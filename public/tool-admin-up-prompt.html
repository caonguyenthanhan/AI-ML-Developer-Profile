<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Tool - Update Prompt Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 py-8">
    <div class="max-w-4xl mx-auto px-4">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Admin Tool</h1>
            <p class="text-white text-lg">Update Prompt Library</p>
        </div>

        <div class="bg-white bg-opacity-25 backdrop-blur-lg rounded-2xl p-8 shadow-2xl">
            <form id="promptForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                    <input type="text" id="title" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Enter prompt title">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prompt Content</label>
                    <textarea id="prompt" required rows="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Enter prompt content"></textarea>
                    <div class="text-sm text-gray-500 mt-1">
                        Characters: <span id="charCount">0</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select id="category" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white">
                        <option value="">Chọn danh mục</option>
                        <option value="Portrait Photography">Chụp chân dung</option>
                        <option value="Art Gallery & Exhibition">Triển lãm nghệ thuật</option>
                        <option value="Divine & Spiritual">Thần thánh & Tâm linh</option>
                        <option value="Classical Art Styles">Phong cách hội họa cổ điển</option>
                        <option value="Vietnamese Mythology">Thần thoại Việt Nam</option>
                        <option value="Lifestyle & Nature">Phong cách sống & Thiên nhiên</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-indigo-400 transition-colors" id="uploadArea">
                        <p class="text-gray-600 mb-2">Click to select image</p>
                        <p class="text-sm text-gray-400">JPG, PNG, JPEG (Max: 1MB)</p>
                        <input type="file" id="imageFile" accept="image/*" class="hidden" required>
                    </div>
                    
                    <div id="imagePreview" class="mt-4 hidden">
                        <p class="text-sm font-medium text-gray-700 mb-2">Preview:</p>
                        <div class="flex items-center space-x-4">
                            <img id="previewImg" class="w-32 h-32 object-cover rounded-lg shadow-md" alt="Preview">
                            <div>
                                <p id="fileName" class="text-sm font-medium text-gray-700"></p>
                                <p id="fileSize" class="text-sm text-gray-500"></p>
                                <button type="button" id="removeImage" class="text-red-500 text-sm mt-2 hover:text-red-700 transition-colors">Remove Image</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-4">
                    <button type="submit" id="submitBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                        Add New Prompt
                    </button>
                    <button type="button" id="previewBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                        Preview
                    </button>
                </div>
            </form>
        </div>

        <div id="statusMessage" class="mt-6 hidden">
            <div class="bg-white bg-opacity-25 backdrop-blur-lg rounded-lg p-4 text-center">
                <p id="statusText" class="text-white font-medium"></p>
            </div>
        </div>

        <div class="mt-8 text-center">
            <a href="/image-prompt-library" class="text-white hover:text-gray-200 transition-colors">Back to Prompt Library</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var uploadArea = document.getElementById('uploadArea');
            var imageFile = document.getElementById('imageFile');
            var imagePreview = document.getElementById('imagePreview');
            var previewImg = document.getElementById('previewImg');
            var fileName = document.getElementById('fileName');
            var fileSize = document.getElementById('fileSize');
            var removeImageBtn = document.getElementById('removeImage');
            var statusMessage = document.getElementById('statusMessage');
            var statusText = document.getElementById('statusText');
            var charCount = document.getElementById('charCount');
            var promptInput = document.getElementById('prompt');

            promptInput.addEventListener('input', function() {
                charCount.textContent = promptInput.value.length;
            });

            uploadArea.addEventListener('click', function() {
                imageFile.click();
            });

            imageFile.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            function handleFileSelect(file) {
                if (!file.type.startsWith('image/')) {
                    showStatus('Please select a valid image file!');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    showStatus('Image file too large! Please select a file smaller than 5MB.');
                    return;
                }

                var reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    imagePreview.classList.remove('hidden');
                    showStatus('Image uploaded successfully!');
                };
                reader.readAsDataURL(file);
            }

            function showStatus(message) {
                statusText.textContent = message;
                statusMessage.classList.remove('hidden');
                
                setTimeout(function() {
                    statusMessage.classList.add('hidden');
                }, 3000);
            }

            removeImageBtn.addEventListener('click', function() {
                imageFile.value = '';
                imagePreview.classList.add('hidden');
                previewImg.src = '';
                showStatus('Image removed!');
            });

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                var k = 1024;
                var sizes = ['Bytes', 'KB', 'MB', 'GB'];
                var i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            document.getElementById('previewBtn').addEventListener('click', function() {
                var title = document.getElementById('title').value;
                var prompt = document.getElementById('prompt').value;
                
                if (!title || !prompt) {
                    showStatus('Please fill in title and prompt to preview!');
                    return;
                }

                var imagePath = previewImg.src || 'https://placehold.co/600x450/e0e0e0/333333?text=No+Image';
                
                var previewWindow = window.open('', '_blank', 'width=800,height=600');
                var previewHTML = '<!DOCTYPE html><html><head><title>Preview</title><script src="https://cdn.tailwindcss.com"><\/script></head><body class="bg-gray-100 p-8"><div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden"><div class="aspect-[4/3] bg-gray-100 flex items-center justify-center overflow-hidden"><img src="' + imagePath + '" alt="Preview" class="w-full h-full object-cover"></div><div class="p-6"><h2 class="text-xl font-bold text-gray-800 mb-2">' + title + '</h2><div class="text-gray-600 text-sm italic bg-gray-50 p-3 rounded-lg border border-gray-100 max-h-40 overflow-y-auto">' + prompt + '</div></div></div></body></html>';
                previewWindow.document.write(previewHTML);
                showStatus('Preview opened in new window!');
            });

            document.getElementById('promptForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                var title = document.getElementById('title').value;
                var prompt = document.getElementById('prompt').value;
                var category = document.getElementById('category').value;
                var file = imageFile.files[0];
                
                if (!title || !prompt || !category || !file) {
                    showStatus('Please fill in all information including category!');
                    return;
                }
                
                var submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';
                
                try {
                    // Upload image first
                    var imagePath = await uploadImage(file);
                    
                    // Create prompt data
                    var promptData = {
                        title: title,
                        prompt: prompt,
                        category: category,
                        imagePath: imagePath
                    };
                    
                    // Send to API
                    var response = await fetch('/api/prompts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(promptData)
                    });
                    
                    if (response.ok) {
                        var result = await response.json();
                        var message = result.message || 'Prompt added successfully!';
                        if (result.note) {
                            message += ' (' + result.note + ')';
                        }
                        showStatus(message);
                        
                        // Reset form
                        document.getElementById('promptForm').reset();
                        imagePreview.classList.add('hidden');
                        charCount.textContent = '0';
                        
                        // Redirect to prompt library after 3 seconds (longer for demo message)
                        setTimeout(function() {
                            window.location.href = '/genai/prompts';
                        }, 3000);
                    } else {
                        var error = await response.text();
                        showStatus('Error: ' + error);
                    }
                } catch (error) {
                    showStatus('Error: ' + error.message);
                }
                
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add New Prompt';
            });
            
            async function uploadImage(file) {
                return new Promise((resolve, reject) => {
                    // Generate unique filename
                    var timestamp = Date.now();
                    var extension = file.name.split('.').pop();
                    var filename = 'image' + (timestamp % 1000) + '.' + extension;
                    var imagePath = '/image/genai/' + filename;
                    
                    // For demo purposes, we'll use a placeholder path
                    // In a real implementation, you would upload the file to the server
                    resolve(imagePath);
                });
            }
        });
    </script>
</body>
</html>