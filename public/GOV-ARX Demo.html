import React, { useState, useEffect, useRef } from 'react';
import { 
  Brain, 
  Database, 
  FileText, 
  Search, 
  Activity, 
  MessageSquare, 
  ArrowRight, 
  Cpu, 
  Layers, 
  CheckCircle2,
  BarChart3,
  FileOutput,
  HelpCircle,
  Terminal,
  Play
} from 'lucide-react';

// --- Constants & Data ---

const STEPS = [
  { id: 'input', label: 'User Input', icon: MessageSquare, description: 'Người dùng gửi yêu cầu' },
  { id: 'intent', label: 'Intent Detector', icon: Search, subLabel: 'Gemma 270M', description: 'Phân loại ý định người dùng' },
  { id: 'normalize', label: 'Input Styler', icon: FileText, subLabel: 'Gemma 1B IT', description: 'Chuẩn hóa câu hỏi đầu vào' },
  { id: 'agent', label: 'Main Agent', icon: Brain, subLabel: 'Gemma 4B (ReAct)', description: 'Lập kế hoạch & Gọi Tools' },
  { id: 'tools', label: 'Tool Layer', icon: Database, subLabel: 'RAG / API / WOM', description: 'Truy xuất dữ liệu thực tế' },
  { id: 'output', label: 'Output Styler', icon: Layers, subLabel: 'Gemma 1B IT', description: 'Định dạng văn phong hành chính' },
  { id: 'final', label: 'Final Answer', icon: CheckCircle2, description: 'Trả về kết quả cho người dùng' }
];

const SCENARIOS = [
  {
    type: 'Lookup',
    label: 'Tra cứu số liệu',
    icon: Search,
    query: 'Cho tôi biết dân số và diện tích của Hà Nội năm 2023?',
    color: 'text-blue-400',
    mockProcess: {
      intent: 'Lookup',
      reasoning: 'Phát hiện từ khóa "dân số", "diện tích", "Hà Nội". Không cần chuẩn hóa phức tạp.',
      tool: 'API_WOM (/criteria/year/2023)',
      result: 'Hà Nội: 8.5 triệu người, 3359 km2.'
    }
  },
  {
    type: 'Compare',
    label: 'So sánh',
    icon: BarChart3,
    query: 'So sánh GDP của TP.HCM và Hà Nội trong quý 1/2024.',
    color: 'text-purple-400',
    mockProcess: {
      intent: 'Compare',
      reasoning: 'Phát hiện yêu cầu so sánh hai đối tượng. Cần chuẩn hóa để tách thực thể.',
      tool: 'Compare Tool + RAG',
      result: 'TP.HCM tăng trưởng 6.54%, Hà Nội tăng trưởng 5.8%.'
    }
  },
  {
    type: 'Analysis',
    label: 'Phân tích',
    icon: Activity,
    query: 'Tại sao chỉ số CPI tháng này lại tăng đột biến?',
    color: 'text-red-400',
    mockProcess: {
      intent: 'Analysis',
      reasoning: 'Câu hỏi "Tại sao" yêu cầu giải thích nguyên nhân. Cần ngữ cảnh rộng.',
      tool: 'RAG (ChromaDB) + Summary Tool',
      result: 'Do giá xăng dầu tăng 5% và nhu cầu tiêu dùng dịp lễ.'
    }
  },
  {
    type: 'Report',
    label: 'Viết báo cáo',
    icon: FileOutput,
    query: 'Viết dự thảo báo cáo tóm tắt tình hình chuyển đổi số tỉnh X.',
    color: 'text-green-400',
    mockProcess: {
      intent: 'Report',
      reasoning: 'Yêu cầu tạo văn bản dài. Cần Multi-sampling để đảm bảo độ chính xác.',
      tool: 'RAG + Report Template Engine',
      result: 'Đã tạo dự thảo báo cáo 5 trang theo mẫu 04/BC-UBND.'
    }
  },
  {
    type: 'Support',
    label: 'Hỗ trợ/Hướng dẫn',
    icon: HelpCircle,
    query: 'Làm thế nào để đăng ký khai sinh online?',
    color: 'text-yellow-400',
    mockProcess: {
      intent: 'Support',
      reasoning: 'Câu hỏi về quy trình thủ tục.',
      tool: 'RAG (Legal Docs)',
      result: 'Bước 1: Truy cập Dịch vụ công. Bước 2: Chọn Lĩnh vực Hộ tịch...'
    }
  },
  {
    type: 'Other',
    label: 'Khác',
    icon: MessageSquare,
    query: 'Hôm nay trời đẹp không?',
    color: 'text-gray-400',
    mockProcess: {
      intent: 'Other',
      reasoning: 'Không thuộc dữ liệu hành chính công.',
      tool: 'None',
      result: 'Xin lỗi, tôi chỉ là trợ lý hành chính công GOV-ARX.'
    }
  }
];

// --- Components ---

const PipelineNode = ({ step, isActive, isCompleted, index }) => {
  const Icon = step.icon;
  
  return (
    <div className={`relative flex flex-col items-center transition-all duration-500 ${isActive ? 'scale-110 opacity-100' : isCompleted ? 'opacity-100' : 'opacity-40'}`}>
      {/* Connection Line */}
      {index < STEPS.length - 1 && (
        <div className={`absolute top-6 left-1/2 w-full h-1 -z-10 ${isCompleted ? 'bg-emerald-500' : 'bg-slate-700'}`}>
           {isActive && <div className="h-full bg-cyan-400 animate-progress origin-left"></div>}
        </div>
      )}
      
      <div className={`w-12 h-12 rounded-full flex items-center justify-center border-2 z-10 bg-slate-900 
        ${isActive ? 'border-cyan-400 shadow-[0_0_15px_rgba(34,211,238,0.5)]' : 
          isCompleted ? 'border-emerald-500 text-emerald-500' : 'border-slate-600 text-slate-500'}`}>
        <Icon size={20} className={isActive ? 'text-cyan-400 animate-pulse' : ''} />
      </div>
      
      <div className="mt-2 text-center w-32">
        <div className={`text-xs font-bold ${isActive ? 'text-cyan-400' : isCompleted ? 'text-emerald-400' : 'text-slate-400'}`}>
          {step.label}
        </div>
        {step.subLabel && (
          <div className="text-[10px] text-slate-500 font-mono mt-0.5">{step.subLabel}</div>
        )}
      </div>
    </div>
  );
};

const LogEntry = ({ log }) => (
  <div className="mb-1 font-mono text-xs border-l-2 border-slate-700 pl-2 py-1 animate-fadeIn">
    <span className="text-slate-500">[{log.time}]</span>{' '}
    <span className={log.color || 'text-slate-300'}>{log.source}:</span>{' '}
    <span className="text-slate-400">{log.message}</span>
  </div>
);

export default function GovArxDemo() {
  const [activeStep, setActiveStep] = useState(-1);
  const [messages, setMessages] = useState([
    { role: 'system', content: 'Chào mừng đến với GOV-ARX. Vui lòng chọn một kịch bản hoặc nhập câu hỏi để bắt đầu phân tích.' }
  ]);
  const [logs, setLogs] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [userInput, setUserInput] = useState('');
  const logsEndRef = useRef(null);
  const chatEndRef = useRef(null);

  // Auto-scroll logs
  useEffect(() => {
    logsEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [logs]);

  // Auto-scroll chat
  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  const addLog = (source, message, color) => {
    const time = new Date().toLocaleTimeString('vi-VN', { hour12: false, hour: '2-digit', minute:'2-digit', second:'2-digit' });
    setLogs(prev => [...prev, { time, source, message, color }]);
  };

  const simulateDelay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

  const runSimulation = async (scenario) => {
    if (isProcessing) return;
    setIsProcessing(true);
    setActiveStep(0);
    setLogs([]); // Clear logs for new run
    
    // Add user message
    setMessages(prev => [...prev, { role: 'user', content: scenario.query }]);

    // Step 1: User Input
    addLog('SYSTEM', 'Nhận yêu cầu đầu vào từ người dùng.', 'text-white');
    await simulateDelay(800);

    // Step 2: Intent Detection
    setActiveStep(1);
    addLog('INTENT_DETECTOR', 'Đang phân tích ý định (Gemma 3 270M)...', 'text-purple-400');
    await simulateDelay(1200);
    addLog('INTENT_DETECTOR', `Phát hiện Intent: [${scenario.mockProcess.intent}]`, 'text-purple-300 font-bold');
    
    if (scenario.type === 'Other') {
       // Early exit for 'Other'
       addLog('ROUTER', 'Intent không hợp lệ. Bỏ qua pipeline xử lý.', 'text-red-400');
       setActiveStep(6);
       await simulateDelay(500);
       setMessages(prev => [...prev, { role: 'assistant', content: scenario.mockProcess.result }]);
       setIsProcessing(false);
       return;
    }

    // Step 3: Input Normalization (Conditional)
    setActiveStep(2);
    if (['Analysis', 'Compare', 'Report', 'Support'].includes(scenario.type)) {
      addLog('INPUT_STYLER', 'Kích hoạt Gemma 1B IT để chuẩn hóa câu hỏi...', 'text-blue-400');
      await simulateDelay(1000);
      addLog('INPUT_STYLER', 'Input đã được làm sạch và tái cấu trúc.', 'text-blue-300');
    } else {
      addLog('INPUT_STYLER', 'Bỏ qua bước chuẩn hóa (Không cần thiết cho Lookup).', 'text-slate-500');
      await simulateDelay(500);
    }

    // Step 4: Main Agent & Planning
    setActiveStep(3);
    addLog('MAIN_AGENT', 'Gemma 4B khởi tạo ReAct & Chain-of-Thought...', 'text-yellow-400');
    await simulateDelay(1000);
    addLog('MAIN_AGENT', `Suy luận: ${scenario.mockProcess.reasoning}`, 'text-yellow-200 italic');
    await simulateDelay(800);

    // Step 5: Tools
    setActiveStep(4);
    addLog('TOOL_LAYER', `Routing đến công cụ: ${scenario.mockProcess.tool}`, 'text-emerald-400');
    await simulateDelay(1500);
    addLog('RAG_ENGINE', 'Truy xuất 5 chunks từ ChromaDB (Local Memory)...', 'text-emerald-300');
    addLog('API_WOM', 'Gọi API thành công. Dữ liệu raw đã sẵn sàng.', 'text-emerald-300');

    // Step 6: Output Styling
    setActiveStep(5);
    addLog('OUTPUT_STYLER', 'Gemma 1B IT đang định dạng lại văn phong hành chính...', 'text-pink-400');
    await simulateDelay(1200);

    // Step 7: Final Answer
    setActiveStep(6);
    addLog('SYSTEM', 'Hoàn tất quy trình.', 'text-white');
    setMessages(prev => [...prev, { role: 'assistant', content: scenario.mockProcess.result }]);
    
    setIsProcessing(false);
  };

  const handleSend = () => {
    if (!userInput.trim()) return;
    // Simple fallback for custom input - just treats it as "Analysis" for demo purposes
    const customScenario = {
      type: 'Analysis',
      query: userInput,
      mockProcess: {
        intent: 'Analysis (Detected)',
        reasoning: 'Phân tích câu hỏi tùy chỉnh của người dùng.',
        tool: 'General Knowledge + RAG',
        result: 'Đây là phản hồi mô phỏng cho câu hỏi: "' + userInput + '". Trong hệ thống thực tế, Gemma 4B sẽ tạo ra câu trả lời chi tiết dựa trên dữ liệu hành chính.'
      }
    };
    runSimulation(customScenario);
    setUserInput('');
  };

  return (
    <div className="min-h-screen bg-slate-950 text-slate-200 font-sans selection:bg-cyan-900 selection:text-white">
      {/* Header */}
      <header className="border-b border-slate-800 bg-slate-900/50 backdrop-blur-md sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-gradient-to-br from-cyan-500 to-blue-600 p-2 rounded-lg shadow-lg shadow-cyan-500/20">
              <Cpu size={24} className="text-white" />
            </div>
            <div>
              <h1 className="text-xl font-bold bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent">
                GOV-ARX
              </h1>
              <p className="text-xs text-slate-400 uppercase tracking-wider">Agentic RAG System</p>
            </div>
          </div>
          <div className="flex items-center gap-4 text-xs font-mono text-slate-500">
             <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div> Local Memory</span>
             <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div> Gemma 4B Ready</span>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        {/* Left Column: Pipeline Visualization & Logs (7 cols) */}
        <div className="lg:col-span-7 space-y-6">
          
          {/* Pipeline Visualizer */}
          <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 shadow-xl overflow-hidden relative">
            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500/0 via-cyan-500/50 to-cyan-500/0 opacity-20"></div>
            <h2 className="text-sm font-semibold text-slate-400 mb-8 flex items-center gap-2">
              <Activity size={16} className="text-cyan-400" />
              REAL-TIME PIPELINE
            </h2>
            
            <div className="flex justify-between items-start relative px-2">
               {STEPS.map((step, idx) => (
                 <PipelineNode 
                   key={step.id} 
                   step={step} 
                   index={idx}
                   isActive={activeStep === idx}
                   isCompleted={activeStep > idx}
                 />
               ))}
            </div>
            
            {/* Current Step Description */}
            <div className="mt-8 bg-slate-950/50 rounded-lg p-4 border border-slate-800/50 min-h-[80px] flex items-center justify-center text-center transition-all">
              {activeStep !== -1 ? (
                <div>
                   <p className="text-cyan-400 font-bold text-sm mb-1">{STEPS[activeStep].label} Processing...</p>
                   <p className="text-slate-400 text-sm">{STEPS[activeStep].description}</p>
                </div>
              ) : (
                <p className="text-slate-600 text-sm">Hệ thống đang chờ lệnh...</p>
              )}
            </div>
          </div>

          {/* System Logs (Console) */}
          <div className="bg-slate-950 border border-slate-800 rounded-2xl p-4 shadow-inner flex flex-col h-96 font-mono text-sm relative overflow-hidden">
            <div className="flex items-center justify-between mb-2 border-b border-slate-800 pb-2">
              <div className="flex items-center gap-2 text-slate-400">
                <Terminal size={14} />
                <span className="text-xs font-bold">SYSTEM KERNEL LOGS</span>
              </div>
              <div className="flex gap-1">
                 <div className="w-2 h-2 rounded-full bg-red-500/20"></div>
                 <div className="w-2 h-2 rounded-full bg-yellow-500/20"></div>
                 <div className="w-2 h-2 rounded-full bg-green-500/20"></div>
              </div>
            </div>
            
            <div className="flex-1 overflow-y-auto space-y-1 pr-2 custom-scrollbar">
               {logs.length === 0 && (
                 <div className="text-slate-700 italic p-4 text-center mt-20">
                   Sẵn sàng khởi chạy vLLM...<br/>
                   Waiting for input triggers...
                 </div>
               )}
               {logs.map((log, i) => (
                 <LogEntry key={i} log={log} />
               ))}
               <div ref={logsEndRef} />
            </div>
          </div>
        </div>

        {/* Right Column: Chat & Controls (5 cols) */}
        <div className="lg:col-span-5 flex flex-col gap-6 h-full">
          
          {/* Chat Interface */}
          <div className="bg-slate-900 border border-slate-800 rounded-2xl shadow-xl flex flex-col h-[500px]">
            <div className="p-4 border-b border-slate-800 flex justify-between items-center">
               <h3 className="font-bold text-slate-300">Live Demo Interface</h3>
               <span className={`text-xs px-2 py-1 rounded-full ${isProcessing ? 'bg-yellow-500/20 text-yellow-400' : 'bg-emerald-500/20 text-emerald-400'}`}>
                 {isProcessing ? 'PROCESSING' : 'IDLE'}
               </span>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-950/30">
              {messages.map((msg, idx) => (
                <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-[85%] p-3 rounded-xl text-sm ${
                    msg.role === 'user' 
                      ? 'bg-cyan-600/20 border border-cyan-600/50 text-cyan-100 rounded-br-none' 
                      : 'bg-slate-800 border border-slate-700 text-slate-200 rounded-bl-none'
                  }`}>
                    {msg.role === 'system' && <div className="flex items-center gap-2 mb-1 text-cyan-400 font-bold text-xs"><Cpu size={12}/> GOV-ARX</div>}
                    {msg.content}
                  </div>
                </div>
              ))}
              <div ref={chatEndRef} />
            </div>

            {/* Input Area */}
            <div className="p-4 bg-slate-900 border-t border-slate-800">
              <div className="flex gap-2">
                <input
                  type="text"
                  value={userInput}
                  onChange={(e) => setUserInput(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                  placeholder="Nhập câu hỏi hành chính..."
                  disabled={isProcessing}
                  className="flex-1 bg-slate-950 border border-slate-700 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-cyan-500 transition-colors disabled:opacity-50"
                />
                <button 
                  onClick={handleSend}
                  disabled={isProcessing || !userInput}
                  className="bg-cyan-600 hover:bg-cyan-500 text-white p-2 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <ArrowRight size={18} />
                </button>
              </div>
            </div>
          </div>

          {/* Quick Scenarios Grid */}
          <div className="grid grid-cols-2 gap-3">
            {SCENARIOS.map((item) => (
              <button
                key={item.type}
                onClick={() => runSimulation(item)}
                disabled={isProcessing}
                className={`p-3 rounded-xl border border-slate-800 bg-slate-900/50 hover:bg-slate-800 transition-all text-left group disabled:opacity-50 disabled:cursor-not-allowed relative overflow-hidden`}
              >
                <div className={`absolute inset-0 opacity-0 group-hover:opacity-10 transition-opacity bg-current ${item.color}`}></div>
                <div className="flex items-start justify-between mb-2">
                   <item.icon size={18} className={item.color} />
                   <Play size={12} className="text-slate-600 group-hover:text-slate-300" />
                </div>
                <div className="text-xs font-bold text-slate-300 mb-1">{item.type}</div>
                <div className="text-[10px] text-slate-500 line-clamp-2 leading-relaxed">
                  {item.query}
                </div>
              </button>
            ))}
          </div>

        </div>
      </main>
      
      {/* Footer Information based on README */}
      <footer className="max-w-7xl mx-auto px-4 py-6 text-center text-slate-600 text-xs border-t border-slate-900 mt-8">
        <p>GOV-ARX Architecture • Gemma 3 Models (270M, 1B, 4B) • Free Local Memory (ChromaDB)</p>
        <p className="mt-1">Tối ưu hóa cho GPU A100 (VRAM ~37GB {'->'} 12GB Optimized)</p>
      </footer>
      
      <style>{`
        @keyframes progress {
          0% { transform: scaleX(0); }
          100% { transform: scaleX(1); }
        }
        .animate-progress {
          animation: progress 0.5s ease-out forwards;
        }
        .custom-scrollbar::-webkit-scrollbar {
          width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: #0f172a; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: #334155; 
          border-radius: 2px;
        }
        .animate-fadeIn {
          animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(5px); }
          to { opacity: 1; transform: translateY(0); }
        }
      `}</style>
    </div>
  );
}