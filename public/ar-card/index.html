<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Electrical Engineer Graduation</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body { margin: 0; background: #000; overflow: hidden; }
    #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    #overlay .inner { display: flex; flex-direction: column; align-items: center; gap: 16px; }
    .btn-start { padding: 12px 20px; font-size: 16px; font-weight: 700; color: #000; background: #00FFFF; border: none; border-radius: 8px; cursor: pointer; }
    .btn-start:active { transform: scale(0.98); }
  </style>

  <script>
    // --- 1. COMPONENT DẢI PHIM TỰ ĐỘNG (Đọc từ JSON) ---
    AFRAME.registerComponent('auto-filmstrip', {
      schema: {
        jsonUrl: {type: 'string', default: '/image/graduation/kyniem/list.json'},
        folder: {type: 'string', default: '/image/graduation/kyniem/'}
      },
      init: function() {
        const el = this.el;
        const data = this.data;

        // Fetch file JSON danh sách
        fetch(data.jsonUrl)
          .then(response => {
            if (!response.ok) throw new Error("Chưa chạy script scan_images.py!");
            return response.json();
          })
          .then(files => {
            console.log("Đã load được danh sách ảnh:", files);
            
            let x = -0.6; // Vị trí bắt đầu
            
            // Nếu ít ảnh quá thì nhân đôi lên để loop cho đẹp
            let loopFiles = files.length < 5 ? [...files, ...files, ...files] : files;

            loopFiles.forEach(filename => {
              const img = document.createElement('a-image');
              img.setAttribute('src', data.folder + filename);
              img.setAttribute('width', '0.4');
              img.setAttribute('height', '0.25');
              // Shader flat để ảnh sáng rõ
              img.setAttribute('material', 'shader: flat; transparent: true');
              img.setAttribute('position', `${x} -0.55 0.02`);
              
              // Animation chạy ngang vô tận
              img.setAttribute('animation', {
                property: 'position',
                to: `${x + 1.5} -0.55 0.02`,
                dur: 10000 + (Math.random() * 2000),
                loop: true,
                easing: 'linear'
              });

              el.appendChild(img);
              x += 0.38; // Khoảng cách giữa các ảnh
            });
          })
          .catch(err => {
            console.error("Lỗi load ảnh kỷ niệm:", err);
            // Tạo text báo lỗi nếu quên chạy script
            const txt = document.createElement('a-text');
            txt.setAttribute('value', 'Run python script first!');
            txt.setAttribute('color', 'red');
            txt.setAttribute('position', '0 -0.4 0');
            el.appendChild(txt);
          });
      }
    });

    // --- 2. HIỆU ỨNG VIỀN MẠCH ĐIỆN (Circuit Border) ---
    AFRAME.registerComponent('circuit-anim', {
      tick: function(t) {
        // Tạo hiệu ứng nhấp nháy như dòng điện
        const intensity = 0.5 + Math.abs(Math.sin(t / 200)) * 0.5;
        this.el.setAttribute('opacity', intensity);
      }
    });

    AFRAME.registerComponent('avatar-slideshow', {
      schema: { folder: {type: 'string', default: '/image/graduation/'}, count: {type: 'number', default: 6}, interval: {type: 'int', default: 2500} },
      init: function() {
        var el = this.el;
        var data = this.data;
        var idx = 1;
        this.timer = setInterval(function(){ idx = (idx % data.count) + 1; el.setAttribute('src', data.folder + 'main' + idx + '.jpg'); }, data.interval);
      },
      remove: function(){ if (this.timer) clearInterval(this.timer); }
    });

    AFRAME.registerComponent('marquee', {
      tick: function(t, dt) {
        var pos = this.el.getAttribute('position');
        pos.x -= 0.001 * dt;
        if (pos.x < -3) pos.x = 3;
        this.el.setAttribute('position', pos);
      }
    });

    AFRAME.registerComponent('app-manager', {
      init: function() {
        var btn = document.querySelector('.btn-start');
        var ov = document.getElementById('overlay');
        var audio = document.getElementById('bg-music');
        var video = document.getElementById('youtube-video-file');
        if (btn && ov) {
          btn.addEventListener('click', function(){
            ov.style.opacity = '0';
            setTimeout(function(){ ov.style.display = 'none'; }, 300);
            if (audio) { var p = audio.play(); if (p && typeof p.then === 'function') { p.then(function(){ audio.pause(); audio.currentTime=0; }).catch(function(){}); } }
            if (video) { var v = video.play(); if (v && typeof v.then === 'function') { v.then(function(){ video.pause(); video.currentTime=0; }).catch(function(){}); } }
          });
        }
        var targetEl = document.querySelector('[mindar-image-target]');
        if (targetEl) {
          targetEl.addEventListener('targetFound', function(){ if (audio) audio.play(); if (video) { video.muted=false; video.play(); } });
          targetEl.addEventListener('targetLost', function(){ if (audio) audio.pause(); if (video) video.pause(); });
        }
      }
    });
  </script>
</head>

<body>
  <div id="overlay">
    <div class="inner">
      <button class="btn-start">KHỞI ĐỘNG HỆ THỐNG</button>
    </div>
  </div>
  <audio id="bg-music" src="/ar-card/music.mp3" loop preload="auto" playsinline></audio>

  <a-scene 
    app-manager
    mindar-image="imageTargetSrc: /ar-card/target.mind; uiScanning: no; uiLoading: no;" 
    color-space="sRGB" 
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false" 
    device-orientation-permission-ui="enabled: false">

    <a-assets>
      <video id="youtube-video-file" src="/ar-card/video.mp4" preload="auto" loop webkit-playsinline playsinline muted></video>
      <img id="fallback" src="/ar-card/tag.png">
      <img id="main1" src="/image/graduation/main.jpg" />
      <img id="main2" src="/image/graduation/main2.jpg" />
      <img id="main3" src="/image/graduation/main3.jpg" />
      <img id="main4" src="/image/graduation/main4.jpg" />
      <img id="main5" src="/image/graduation/main5.jpg" />
      <img id="main6" src="/image/graduation/main6.jpg" />
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">

      <a-entity position="-1.2 0 0">
        <a-plane width="1.6" height="0.9" color="#000" material="shader: flat; opacity: 0.8"></a-plane>
        <a-plane width="1.65" height="0.95" color="#00FFFF" material="shader: flat; opacity: 0.3" position="0 0 -0.01"></a-plane>
        <a-video src="#youtube-video-file" width="1.5" height="0.85" position="0 0 0.01"></a-video>
        <a-text value="KY YEU 2025" position="0 0.55 0" align="center" color="#FFF" font="roboto"></a-text>
      </a-entity>

      <a-plane color="#00FFFF" width="1.1" height="0.01" position="0 0.36 0" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="1.1" height="0.01" position="0 -0.55 0" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="0.01" height="0.9" position="-0.55 -0.1 0" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="0.01" height="0.9" position="0.55 -0.1 0" shader="flat" circuit-anim></a-plane>

      <a-circle color="#00FFFF" radius="0.04" position="-0.6 0.38 0.01" shader="flat"></a-circle>
      <a-circle color="#00FFFF" radius="0.04" position="0.6 0.38 0.01" shader="flat"></a-circle>
      <a-circle color="#00FFFF" radius="0.04" position="-0.6 -0.55 0.01" shader="flat"></a-circle>
      <a-circle color="#00FFFF" radius="0.04" position="0.6 -0.55 0.01" shader="flat"></a-circle>


      


      <a-entity position="0 0.6 0.05">
        <a-text value="CHUC MUNG TOT NGHIEP" align="center" width="4" color="#00FFFF" font="exo2bold" position="0 0.1 0" shader="flat"></a-text>
        <a-text value="TAN KY SU DIEN: NGO TAN TAI" align="center" width="2.5" color="#FFFF00" font="exo2bold" position="0 0 0" shader="flat"></a-text>
      </a-entity>
      <a-image src="/image/graduation/main1.jpg" width="0.4" height="0.5" position="0.3 -0.05 0.01" avatar-slideshow material="shader: flat"></a-image>

      <a-plane position="0 -0.4 0.02" width="1.2" height="0.12" color="#000" opacity="0.7"></a-plane>
      <a-entity position="0 -0.4 0.03">
        <a-text marquee value="Chuc mung Ngo Tan Tai da xuat sac hoan thanh chuong trinh dao tao Ky su Dien - Tuong lai ruc ro dang cho don! --- Happy Graduation! --- " color="#00FF00" width="3" position="1.5 0 0" font="roboto" anchor="left"></a-text>
      </a-entity>

      <a-entity auto-filmstrip></a-entity>

    </a-entity>
  </a-scene>
</body>
</html>
