<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AR Graduation Card — Fixed</title>

<!-- A-Frame + MindAR -->
<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

<style>
  body { margin:0; overflow:hidden; font-family: Arial, "Segoe UI", sans-serif; }
  #scanning-overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,0.32); color:#00FFFF; z-index:10; pointer-events:none;
    text-shadow:0 0 8px #00FFFF; font-size:20px;
  }
</style>

<script>
/* ---------------------------
 Utilities
----------------------------*/
function loadImageOnce(url){
  return new Promise(resolve=>{
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = ()=> resolve({ url, img });
    img.onerror = ()=> resolve(null);
    // cache-bust for dev convenience
    img.src = url + '?v=' + Math.floor(Math.random()*99999);
  });
}

/* Render Vietnamese text to dataURL */
function createTextDataURL(text, maxW = 1400){
  const canvas = document.createElement('canvas');
  canvas.width = maxW;
  canvas.height = 320;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // background transparent
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  const fontSize = 48;
  ctx.font = `bold ${fontSize}px "Segoe UI", Arial, sans-serif`;
  ctx.fillStyle = "#00FFFF";
  ctx.shadowColor = 'rgba(0,255,255,0.9)';
  ctx.shadowBlur = 18;

  // simple wrap: split into chunks by words
  const words = text.split(' ');
  let lines = [], cur = '';
  for (let w of words){
    const test = cur ? cur + ' ' + w : w;
    if (ctx.measureText(test).width > canvas.width - 80 && cur){
      lines.push(cur); cur = w;
    } else cur = test;
  }
  if (cur) lines.push(cur);
  const lineHeight = fontSize + 8;
  let startY = canvas.height/2 - (lines.length-1)*lineHeight/2;
  for (let i=0;i<lines.length;i++){
    ctx.fillText(lines[i], canvas.width/2, startY + i*lineHeight);
  }
  return canvas.toDataURL('image/png');
}

/* ---------------------------
 main-slideshow component
 - preloads images, computes aspect, sets width/height to avoid distortion
----------------------------*/
AFRAME.registerComponent('main-slideshow', {
  schema: {
    files: { type: 'array', default: [
      'public/image/graduation/main.jpg',
      'public/image/graduation/main2.jpg',
      'public/image/graduation/main3.jpg',
      'public/image/graduation/main4.jpg',
      'public/image/graduation/main5.jpg',
      'public/image/graduation/main6.jpg'
    ] },
    maxWidth: { type: 'number', default: 1.1 },
    maxHeight: { type: 'number', default: 0.65 }
  },

  init: async function(){
    this.idx = 0;
    // preload sequentially and keep only valid
    const promises = this.data.files.map(f => loadImageOnce(f));
    const results = await Promise.all(promises);
    this.valid = results.filter(r => r && r.img);
    if (!this.valid.length){
      console.warn('No valid main images found');
      this.el.setAttribute('material','color:#111');
      return;
    }
    // show first
    this.showIndex(0);
    this.timer = setInterval(()=> this.next(), 3000);
  },

  showIndex: function(i){
    const obj = this.valid[i];
    const aspect = obj.img.width / obj.img.height;
    let w = this.data.maxWidth;
    let h = w / aspect;
    if (h > this.data.maxHeight){
      h = this.data.maxHeight;
      w = h * aspect;
    }
    this.el.setAttribute('width', w);
    this.el.setAttribute('height', h);
    // position slightly above centre to leave space for text
    this.el.setAttribute('position', `0 ${0.05} 0.015`);
    this.el.setAttribute('src', obj.url);
    this.el.setAttribute('opacity', 1);
  },

  next: function(){
    if (!this.valid || !this.valid.length) return;
    const nextIdx = (this.idx + 1) % this.valid.length;
    this.el.setAttribute('animation__out', 'property: opacity; to:0; dur:380; easing: easeOutQuad');
    setTimeout(()=> {
      this.showIndex(nextIdx);
      this.el.setAttribute('animation__in', 'property: opacity; to:1; dur:380; easing: easeInQuad');
      this.idx = nextIdx;
    }, 380);
  },

  remove: function(){ clearInterval(this.timer); }
});

/* ---------------------------
 filmstrip auto-detect filenames
 - tries many likely patterns (no server-side listing)
----------------------------*/
AFRAME.registerComponent('filmstrip', {
  schema: {
    folder: { type: 'string', default: 'public/image/graduation/kyniem/' },
    itemW: { type: 'number', default: 0.32 },
    itemH: { type: 'number', default: 0.20 }
  },
  init: async function(){
    const folder = this.data.folder;
    const exts = ['jpg','jpeg','png','webp'];
    const nameCandidates = [];

    // try common patterns and existing filenames heuristics
    for (let i=1;i<=80;i++){
      nameCandidates.push('img'+i);
      nameCandidates.push('IMG_'+i);
      nameCandidates.push('photo'+i);
      nameCandidates.push('IMG-'+i);
      nameCandidates.push('PXL_'+i);
      nameCandidates.push('pic'+i);
    }
    // small attempt for timestamp-like names
    for (let y=2018;y<=2025;y++) nameCandidates.push(String(y));

    const tries = [];
    nameCandidates.forEach(n => exts.forEach(e => tries.push(folder + n + '.' + e)));

    // also attempt to probe a few likely explicit names if any
    const extra = ['1','2','3','0','a','b','c'].map(x=>folder+x+'.jpg');
    extra.forEach(u => tries.push(u));

    // dedupe tries
    const uniqueTries = Array.from(new Set(tries)).slice(0, 400); // limit for speed

    // test in batches to avoid too many parallel
    const results = [];
    const batchSize = 30;
    for (let i=0;i<uniqueTries.length;i+=batchSize){
      const batch = uniqueTries.slice(i, i+batchSize).map(url => loadImageOnce(url));
      const r = await Promise.all(batch);
      results.push(...r.filter(x=>x));
      // if we already have enough images (say 12) we can stop
      if (results.length >= 12) break;
    }

    if (!results.length){
      console.warn('No filmstrip images found in', folder);
      return;
    }

    // create scrolling images (duplicate sequence to loop)
    const imgs = results.map(r=>r.url);
    const loopImgs = imgs.concat(imgs);

    let x = -0.6;
    loopImgs.forEach((url, idx) => {
      const el = document.createElement('a-image');
      el.setAttribute('src', url);
      el.setAttribute('width', this.data.itemW);
      el.setAttribute('height', this.data.itemH);
      el.setAttribute('position', `${x} -0.30 0.015`);
      el.setAttribute('animation',
        `property: position; from: ${x} -0.30 0.015; to: ${x+1.6} -0.30 0.015; dur:12000; loop:true; easing:linear`);
      this.el.appendChild(el);
      x += 0.36;
    });
  }
});

/* ---------------------------
 fireworks
----------------------------*/
AFRAME.registerComponent('fireworks', {
  init: function(){
    this.timer = setInterval(()=> this.burst(), 1700);
  },
  burst: function(){
    for (let i=0;i<8;i++){
      const s = document.createElement('a-sphere');
      const angle = Math.random()*Math.PI*2;
      const r = 0.04 + Math.random()*0.18;
      const x = Math.cos(angle)*r;
      const z = Math.sin(angle)*r;
      const yTo = 0.5 + Math.random()*0.7;
      s.setAttribute('radius', 0.012 + Math.random()*0.02);
      const colors = ['#00FFFF','#FFD700','#FFFFFF','#FF88FF'];
      s.setAttribute('color', colors[Math.floor(Math.random()*colors.length)]);
      s.setAttribute('position', `${x} -0.2 ${z}`);
      s.setAttribute('animation', `property: position; to: ${x} ${yTo} ${z}; dur: ${700+Math.random()*700}; easing: easeOutCubic`);
      s.setAttribute('animation__fade', `property: opacity; to:0; dur: ${800+Math.random()*800}; delay: 300`);
      this.el.appendChild(s);
      setTimeout(()=> { if (s.parentNode) s.parentNode.removeChild(s); }, 2200);
    }
  },
  remove: function(){ clearInterval(this.timer); }
});

/* ---------------------------
 AR overlay show/hide & audio control
----------------------------*/
AFRAME.registerComponent('ar-control', {
  init: function(){
    const overlay = document.getElementById('scanning-overlay');
    const music = document.getElementById('bgm');
    this.el.addEventListener('targetFound', () => {
      overlay.style.display = 'none';
      try { music.play().catch(()=>{}); } catch(e){}
    });
    this.el.addEventListener('targetLost', () => {
      overlay.style.display = 'flex';
      try { music.pause(); } catch(e){}
    });
  }
});
</script>
</head>

<body>
<div id="scanning-overlay">Đang quét thẻ...</div>

<a-scene mindar-image="imageTargetSrc: public/ar-card/target.mind; uiScanning: no;"
         renderer="colorManagement:true; physicallyCorrectLights"
         vr-mode-ui="enabled:false"
         device-orientation-permission-ui="enabled:false">

  <!-- assets: the ring image and music (crossorigin to avoid black textures) -->
  <a-assets>
    <img id="ringImg" src="public/image/hologram-ring.png" crossorigin="anonymous">
    <audio id="bgm" src="public/music/Chang The Cam Hoa.mp3" preload="auto" crossorigin="anonymous"></audio>
  </a-assets>

  <!-- camera + light -->
  <a-camera cursor="rayOrigin:mouse" position="0 0 0">
    <a-entity light="type:ambient; intensity:1.1; color:#66CCFF"></a-entity>
    <a-entity light="type:directional; intensity:1.1; color:#FFE9A0" position="2 3 2"></a-entity>
  </a-camera>

  <!-- main AR target entity -->
  <a-entity mindar-image-target="targetIndex:0" ar-control>

    <!-- outer glow -->
    <a-plane width="1.22" height="0.70" position="0 0 0" color="#00FFFF" opacity="0.22"
             material="shader:flat; transparent:true"
             animation="property:opacity; from:0.12; to:0.36; dur:1500; dir:alternate; loop:true">
    </a-plane>

    <!-- ring image (your asked /image/nguyet-que.png earlier, but here using hologram-ring.png in public/image) -->
    <a-image src="#ringImg" rotation="-90 0 0" position="0 -0.42 0.005"
             scale="0.9 0.9 0.9" opacity="0.95"
             animation="property:rotation; to:-90 360 0; dur:6000; loop:true; easing:linear">
    </a-image>

    <!-- thin running ring -->
    <a-ring radius-inner="0.56" radius-outer="0.585" position="0 0 0.01"
            material="color:#00FFFF; opacity:0.95"
            animation="property:rotation; to:0 0 360; dur:4200; loop:true">
    </a-ring>

    <!-- greeting text as canvas texture -->
    <a-image id="greeting" position="0 0.50 0.015" width="1.15" height="0.26"></a-image>

    <!-- set text src after scene init -->
    <script>
      (function(){
        const msg = "Chúc mừng bạn đã hoàn thành hành trình tri thức — tương lai đang chờ đón một kỹ sư đầy khát vọng!";
        const dataUrl = createTextDataURL(msg, 1400);
        const trySet = () => {
          const el = document.getElementById('greeting');
          if (el) { el.setAttribute('src', dataUrl); return; }
          setTimeout(trySet, 50);
        };
        trySet();
      })();
    </script>

    <!-- main slideshow (positioned on same plane) -->
    <a-image main-slideshow position="0 0.05 0.02"></a-image>

    <!-- filmstrip: auto scan folder public/image/graduation/kyniem/ -->
    <a-entity position="0 0 0.02" filmstrip></a-entity>

    <!-- fireworks -->
    <a-entity position="0 -0.15 0" fireworks></a-entity>

  </a-entity>
</a-scene>

</body>
</html>
