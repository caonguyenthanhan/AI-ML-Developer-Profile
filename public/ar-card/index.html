<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Electrical Engineer Graduation</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body { margin: 0; background: #000; overflow: hidden; font-family:'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }

    /* FIX SAFARI / IPHONE */
    a-image, a-plane, a-entity { 
      backface-visibility: hidden; 
      -webkit-backface-visibility: hidden;
      transform-style: flat;
    }
    img { image-rendering: auto; }

    /* OVERLAY KHỞI ĐỘNG */
    #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
    .btn-start {
      padding: 14px 26px; font-size: 18px; font-weight: 700; 
      background: linear-gradient(90deg, #00FFFF, #0000FF);
      color: white; border:none; border-radius:30px; cursor:pointer; 
      box-shadow: 0 0 15px rgba(0,255,255,0.5);
    }

    /* AR CARD HTML CONTENT (HUD) */
    #ar-card-content {
      position: fixed;
      /* Căn sang bên phải màn hình */
      top: 50%; right: 5%; left: auto; 
      transform: translateY(-50%);
      
      /* Thu nhỏ kích thước hơn nữa */
      width: 45%; max-width: 250px; 
      
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px; /* Bo góc nhỏ hơn xíu */
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      
      padding: 12px;
      text-align: center;
      color: white;
      
      opacity: 0; 
      pointer-events: none; 
      transition: opacity 0.5s ease, transform 0.5s ease;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* FILMSTRIP (Dải ảnh chạy bên dưới) */
    #filmstrip-container {
      position: fixed;
      bottom: 20px; left: 0; width: 100%;
      height: 120px;
      overflow: hidden;
      z-index: 999;
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(5px);
    }
    #filmstrip-container.visible { opacity: 1; pointer-events: auto; }
    
    .filmstrip-track {
      display: flex;
      gap: 10px;
      position: absolute;
      left: 0; top: 10px;
      animation: scrollFilmstrip 30s linear infinite;
    }
    .filmstrip-img {
      height: 100px;
      width: auto;
      border-radius: 8px;
      border: 2px solid rgba(0, 255, 255, 0.5);
      object-fit: cover;
    }

    @keyframes scrollFilmstrip {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); } /* Di chuyển 50% vì track được nhân đôi */
    }

    #ar-card-content.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(-50%) scale(1);
    }

    /* HEADER */
    .card-header h1 {
      margin: 0;
      font-size: 1.1rem; /* Giảm font */
      color: #00FFFF;
      text-transform: uppercase;
      text-shadow: 0 0 10px rgba(0,255,255,0.5);
    }
    .card-header h2 {
      margin: 3px 0 0;
      font-size: 0.85rem; /* Giảm font */
      color: #FFFF00;
      font-weight: normal;
    }

    /* SLIDESHOW */
    .slideshow-container {
      position: relative;
      width: 100%;
      aspect-ratio: 3/4;
      overflow: hidden;
      border-radius: 10px;
      border: 2px solid rgba(0, 255, 255, 0.3);
    }
    .slide-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0; left: 0;
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
    }
    .slide-img.active { opacity: 1; }

    /* MARQUEE */
    .marquee-container {
      overflow: hidden;
      white-space: nowrap;
      background: rgba(0,0,0,0.3);
      padding: 8px 0;
      border-radius: 8px;
    }
    .marquee-text {
      display: inline-block;
      padding-left: 100%;
      animation: marquee 15s linear infinite;
      color: #00FF00;
      font-size: 0.9rem;
    }

    @keyframes marquee {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    /* ACTION BUTTONS */
    .card-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .btn-action {
      background: rgba(0, 255, 255, 0.2);
      border: 1px solid #00FFFF;
      color: #00FFFF;
      padding: 6px 12px;
      border-radius: 20px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s;
      font-size: 0.8rem;
    }
  </style>

  <script>
    /* ---------------- HTML SLIDESHOW ---------------- */
    let slideIndex = 0;
    function showSlides() {
      const slides = document.querySelectorAll('.slide-img');
      if (slides.length === 0) return;
      
      slides.forEach(img => img.classList.remove('active'));
      
      slideIndex++;
      if (slideIndex > slides.length) { slideIndex = 1; }
      
      slides[slideIndex - 1].classList.add('active');
      setTimeout(showSlides, 2500); // Change image every 2.5 seconds
    }

    /* ---------------- FILMSTRIP LOADER ---------------- */
    function loadFilmstrip() {
      const track = document.getElementById('filmstrip-track');
      const folder = '/image/graduation/kyniem/';
      const jsonUrl = '/image/graduation/kyniem/list.json';

      fetch(jsonUrl)
        .then(r => r.json())
        .then(files => {
          // Lấy 15 ảnh đầu tiên
          const images = files.slice(0, 15);
          
          // Tạo HTML chuỗi ảnh
          const createImg = (name) => `<img src="${folder}${name}" class="filmstrip-img">`;
          const html = images.map(createImg).join('');
          
          // Nhân đôi chuỗi ảnh để tạo hiệu ứng lặp vô tận (scroll loop)
          track.innerHTML = html + html; 
        });
    }

    /* ---------------- APP MANAGER & AR EVENTS ---------------- */
    AFRAME.registerComponent('app-manager',{
      init:function(){
        const btn = document.querySelector('.btn-start');
        const ov = document.getElementById('overlay');
        const audio = document.getElementById('bg-music');
        const video = document.getElementById('card-video'); // Video Overlay
        const arContent = document.getElementById('ar-card-content');
        const filmstrip = document.getElementById('filmstrip-container');
        
        // Load filmstrip images
        loadFilmstrip();

        // Start Button
        btn.onclick=()=>{
          ov.style.opacity="0";
          setTimeout(()=>ov.style.display="none",350);
          audio.play().catch(()=>{});
          video.play().catch(()=>{}); // Unlock video
          video.pause(); // Pause immediately, wait for target
          // Start slideshow after user interaction
          showSlides();
        };

        const t = document.querySelector('[mindar-image-target]');
        
        // Target Found
        t.addEventListener('targetFound', () => {
          console.log("Target Found");
          audio.play().catch(()=>{});
          video.play().catch(()=>{}); // Play Video Overlay
          arContent.classList.add('visible');
          filmstrip.classList.add('visible');
        });

        // Target Lost
        t.addEventListener('targetLost', () => {
          console.log("Target Lost");
          audio.pause();
          video.pause(); // Pause Video Overlay
          arContent.classList.remove('visible');
          filmstrip.classList.remove('visible');
        });
      }
    });

    /* ---------------- BORDER SHIMMER (A-FRAME) ---------------- */
    AFRAME.registerComponent('circuit-anim',{
      tick:function(t){
        const k = 0.4 + Math.abs(Math.sin(t/310))*0.6;
        this.el.setAttribute('opacity', k);
      }
    });
  </script>
</head>

<body>

  <div id="overlay">
    <button class="btn-start">KHỞI ĐỘNG HỆ THỐNG</button>
  </div>

  <!-- AR CARD HTML OVERLAY (HUD) -->
  <div id="ar-card-content">
    
    <!-- Header -->
    <div class="card-header">
      <h1>CHÚC MỪNG TỐT NGHIỆP</h1>
      <h2>Tân Kỹ Sư Điện: Ngô Tấn Tài</h2>
    </div>

    <!-- Slideshow -->
    <div class="slideshow-container">
      <img src="/image/graduation/main1.jpg" class="slide-img active">
      <img src="/image/graduation/main2.jpg" class="slide-img">
      <img src="/image/graduation/main3.jpg" class="slide-img">
      <img src="/image/graduation/main4.jpg" class="slide-img">
      <img src="/image/graduation/main5.jpg" class="slide-img">
      <img src="/image/graduation/main6.jpg" class="slide-img">
    </div>

    <!-- Marquee -->
    <div class="marquee-container">
      <div class="marquee-text">
        Chúc mừng Ngô Tấn Tài đã xuất sắc hoàn thành chương trình đào tạo Kỹ sư Điện — Tương lai rực rỡ đang chờ đón! — Happy Graduation! —
      </div>
    </div>

  </div>

  <audio id="bg-music" src="/music/music.mp3" loop preload="auto"></audio>

  <!-- FILMSTRIP BOTTOM -->
  <div id="filmstrip-container">
    <div class="filmstrip-track" id="filmstrip-track">
      <!-- JS sẽ load ảnh vào đây -->
    </div>
  </div>

  <a-scene
    app-manager
    mindar-image="imageTargetSrc:/ar-card/target.mind; uiScanning:no; uiLoading:no;"
    color-space="sRGB"
    renderer="colorManagement:true; physicallyCorrectLights:true; antialias:true; sortObjects:true;"
    device-orientation-permission-ui="enabled:false">

    <a-assets>
      <video id="card-video" src="/video/0111.mp4" loop="true" crossorigin="anonymous" playsinline webkit-playsinline></video>
    </a-assets>

    <a-camera look-controls="enabled:false"></a-camera>

    <a-entity mindar-image-target="targetIndex:0">

      <!-- VIDEO OVERLAY (BÁO PHÙ THỦY) -->
      <a-video src="#card-video" width="1" height="1.3" position="0 0 0" opacity="0.9" rotation="0 0 0"></a-video>

      <!-- BORDER 3D (GIỮ LẠI HIỆU ỨNG KHÔNG GIAN) -->
      <a-plane color="#00FFFF" width="1.1" height="0.01" position="0 0.55 0.01" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="1.1" height="0.01" position="0 -0.55 0.01" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="0.01" height="1.1"  position="-0.55 0 0.01" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="0.01" height="1.1"  position="0.55 0 0.01" shader="flat" circuit-anim></a-plane>

    </a-entity>
  </a-scene>
</body>
</html>
