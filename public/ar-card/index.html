<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Electrical Engineer Graduation</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body { margin: 0; background: #000; overflow: hidden; font-family:'Playfair Display','Times New Roman',serif; }

    /* FIX SAFARI / IPHONE */
    a-image, a-plane, a-entity { 
      backface-visibility: hidden; 
      -webkit-backface-visibility: hidden;
      transform-style: flat;
    }
    img { image-rendering: auto; }

    #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .btn-start {
      padding: 14px 26px; font-size: 18px; font-weight: 700; 
      background:#00FFFF; border:none; border-radius:8px; cursor:pointer; 
    }
  </style>

  <script>
    /* ---------------- FILMSTRIP TỐI ƯU CHO IPHONE (SMOOTH LOOP) ---------------- */
    AFRAME.registerComponent('auto-filmstrip', {
      schema: {
        jsonUrl:  {type:'string', default:'/image/graduation/kyniem/list.json'},
        folder:   {type:'string', default:'/image/graduation/kyniem/'},
        maxDisplay:{type:'number', default:20},
        speed:    {type:'number', default:0.15} // Tốc độ di chuyển
      },

      init: function() {
        this.images = [];
        const root = this.el;
        const data = this.data;

        fetch(data.jsonUrl)
          .then(r=>r.json())
          .then(files=>{
            const slice = files.slice(0, data.maxDisplay);
            // Đảm bảo đủ ảnh để lấp đầy màn hình + buffer
            const loopFiles = [...slice, ...slice]; 
            
            const W = 0.9; // Khoảng cách giữa các ảnh
            this.totalWidth = loopFiles.length * W;
            
            // Bắt đầu từ vị trí cân đối
            let startX = -W * 2; 

            loopFiles.forEach((name, i)=>{
              const img = document.createElement('a-image');
              img.setAttribute('src', data.folder + name);
              img.setAttribute('width', '0.42');
              img.setAttribute('height', '0.30');
              img.setAttribute('material', 'shader: flat; transparent:true');
              
              // Đặt vị trí ban đầu
              // Y nâng lên -0.85 để không bị "dưới chân"
              // Z = 0.02 để nổi lên trên nền
              img.setAttribute('position', `${startX + (i * W)} -0.85 0.02`);
              
              root.appendChild(img);
              this.images.push(img);
            });
          });
      },

      tick: function(t, dt) {
        if (!this.images || this.images.length === 0) return;
        
        // Di chuyển dựa trên delta time (ms) để mượt mà trên mọi FPS
        const move = (dt / 1000) * this.data.speed; 
        const W = 0.9;
        const leftBound = -6.0; // Điểm biến mất bên trái
        const rightBound = (this.images.length * W) + leftBound;

        this.images.forEach(img => {
          let pos = img.object3D.position;
          pos.x -= move; // Di chuyển sang trái
          
          // Nếu ảnh đi quá xa bên trái, đưa nó về cuối hàng bên phải
          if (pos.x < leftBound) {
            // Tìm vị trí x lớn nhất hiện tại để nối đuôi vào
            // Cách đơn giản: cộng thêm tổng chiều dài chuỗi ảnh
            // Tuy nhiên, để chính xác ta chỉ cần cộng thêm (Số lượng ảnh * W)
            pos.x += (this.images.length * W);
          }
        });
      }
    });

    /* ---------------- BORDER SHIMMER ---------------- */
    AFRAME.registerComponent('circuit-anim',{
      tick:function(t){
        const k = 0.4 + Math.abs(Math.sin(t/310))*0.6;
        this.el.setAttribute('opacity', k);
      }
    });

    /* ---------------- MAIN SLIDESHOW ---------------- */
    AFRAME.registerComponent('avatar-slideshow', {
      schema:{folder:{type:'string',default:'/image/graduation/'},count:{type:'number',default:6},interval:{type:'int',default:2500}},
      init:function(){
        let el=this.el,d=this.data,idx=1;
        this.timer=setInterval(()=>{
          idx=(idx%d.count)+1;
          el.setAttribute('src', d.folder+'main'+idx+'.jpg');
        }, d.interval);
      },
      remove:function(){clearInterval(this.timer);}
    });

    /* ---------------- MARQUEE ---------------- */
    AFRAME.registerComponent('marquee',{
      tick:function(t,dt){
        // Optimize: Use object3D directly instead of getAttribute/setAttribute
        let pos = this.el.object3D.position;
        pos.x -= 0.00032 * dt;
        if(pos.x < -0.9) pos.x = 0.9;
      }
    });

    /* ---------------- APP MANAGER ---------------- */
    AFRAME.registerComponent('app-manager',{
      init:function(){
        const btn=document.querySelector('.btn-start');
        const ov=document.getElementById('overlay');
        const audio=document.getElementById('bg-music');

        btn.onclick=()=>{
          ov.style.opacity="0";
          setTimeout(()=>ov.style.display="none",350);
          audio.play().catch(()=>{});
        };

        const t=document.querySelector('[mindar-image-target]');
        t.addEventListener('targetFound',()=>audio.play());
        t.addEventListener('targetLost',()=>audio.pause());
      }
    });
  </script>
</head>

<body>

  <div id="overlay">
    <button class="btn-start">KHỞI ĐỘNG HỆ THỐNG</button>
  </div>

  <audio id="bg-music" src="/music/music.mp3" loop preload="auto"></audio>

  <a-scene
    app-manager
    mindar-image="imageTargetSrc:/ar-card/target.mind; uiScanning:no; uiLoading:no;"
    color-space="sRGB"
    renderer="colorManagement:true; physicallyCorrectLights:true"
    device-orientation-permission-ui="enabled:false">

    <a-assets>
      <img id="main1" src="/image/graduation/main.jpg">
      <img id="main2" src="/image/graduation/main2.jpg">
      <img id="main3" src="/image/graduation/main3.jpg">
      <img id="main4" src="/image/graduation/main4.jpg">
      <img id="main5" src="/image/graduation/main5.jpg">
      <img id="main6" src="/image/graduation/main6.jpg">
    </a-assets>

    <a-camera look-controls="enabled:false"></a-camera>

    <a-entity mindar-image-target="targetIndex:0">

      <!-- BORDER -->
      <a-plane color="#00FFFF" width="1.1" height="0.01" position="0 0.36 0.01" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="1.1" height="0.01" position="0 -0.55 0.01" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="0.01" height="0.9"  position="-0.55 -0.1 0.01" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="0.01" height="0.9"  position="0.55 -0.1 0.01" shader="flat" circuit-anim></a-plane>

      <!-- BANNER BACKGROUND -->
      <a-plane position="0 0.67 0.20"
               width="1.25" height="0.24"
               color="#000" opacity="0.65"></a-plane>

      <!-- BANNER TEXT -->
      <a-entity position="0 0.66 0.21" scale="3.1 3.1 1">
        <a-text value="Chúc Mừng Tốt Nghiệp"
                align="center" width="8"
                color="#00FFFF"
                font="/fonts/FS-Southamton.fnt"
                position="0 0.13 0"></a-text>

        <a-text value="Tân Kỹ Sư Điện: Ngô Tấn Tài"
                align="center" width="6"
                color="#FFFF00"
                font="/fonts/SVN-Anastasia.fnt"
                position="0 -0.05 0"></a-text>
      </a-entity>

      <!-- PHOTO MAIN (SÁT PHẢI) -->
      <a-image 
        src="/image/graduation/main1.jpg"
        width="0.55"
        height="0.71"
        position="0.31 -0.20 0.15"
        avatar-slideshow
        material="shader:flat"
        crossorigin="anonymous">
      </a-image>

      <!-- MARQUEE -->
      <a-plane position="0 -0.42 0.12" width="1.28" height="0.14" color="#000" opacity="0.70"></a-plane>

      <a-entity position="0 -0.42 0.13">
        <a-text 
          marquee
          value="Chúc mừng Ngô Tấn Tài đã xuất sắc hoàn thành chương trình đào tạo Kỹ sư Điện — Tương lai rực rỡ đang chờ đón! — Happy Graduation! — "
          color="#00FF00"
          width="8"
          position="0.7 0 0"
          font="https://cdn.aframe.io/fonts/DejaVu-sdf.fnt"
          shader="sdf"
          wrap-count="2000"
          anchor="left"
          scale="2 2 1">
        </a-text>
      </a-entity>

      <!-- FILMSTRIP (Z THẤP) -->
      <a-entity auto-filmstrip="maxDisplay:20" position="0 0 0.00"></a-entity>

    </a-entity>
  </a-scene>
</body>
</html>
