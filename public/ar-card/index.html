<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AR Graduation Card</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>

  <style>
    /* 1. RESET CSS QUAN TRỌNG ĐỂ FULL MÀN HÌNH */
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      overflow: hidden; /* Chặn cuộn trang */
      font-family: 'Segoe UI', sans-serif;
      background-color: #000; /* Nền đen tránh bị vệt trắng */
    }

    /* 2. MÀN HÌNH START + LOADING (Giao diện chính) */
    #overlay-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); /* Màu nền tối */
      z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.5s;
    }

    /* Chữ tiêu đề */
    .title-text {
      color: #00FFFF; font-size: 24px; font-weight: bold;
      margin-bottom: 30px; text-align: center;
      text-shadow: 0 0 10px #00FFFF; letter-spacing: 2px;
    }

    /* Nút Bắt đầu */
    #start-btn {
      padding: 15px 40px; font-size: 18px; font-weight: bold;
      color: #000; background: #00FFFF; border: none;
      border-radius: 30px; cursor: pointer;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      animation: pulse 1.5s infinite;
    }

    /* Trạng thái Loading */
    #loading-text {
      color: #FFF; font-size: 16px; margin-top: 20px; display: none;
    }

    /* 3. DÒNG CHỮ HƯỚNG DẪN KHI QUÉT (Overlay phụ) */
    #scanning-guide {
      position: fixed; bottom: 50px; left: 0; width: 100%;
      text-align: center; pointer-events: none; z-index: 1000;
      display: none; /* Mặc định ẩn, chỉ hiện sau khi start */
    }
    .guide-box {
      display: inline-block; background: rgba(0, 0, 0, 0.6);
      color: #00FFFF; padding: 10px 20px; border-radius: 20px;
      border: 1px solid #00FFFF; font-weight: bold;
    }

    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); }
      50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(0, 255, 255, 0.8); }
      100% { transform: scale(1); box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); }
    }
  </style>

  <script>
    let isAudioStarted = false;

    // Hàm khởi động (Gắn vào nút Bắt đầu)
    function startExperience() {
      const btn = document.getElementById('start-btn');
      const loadingText = document.getElementById('loading-text');
      const music = document.querySelector('#bg-music');

      // 1. Đổi giao diện nút thành Loading
      btn.style.display = 'none';
      loadingText.style.display = 'block';
      loadingText.innerText = "ĐANG TẢI DỮ LIỆU... (VUI LÒNG ĐỢI)";

      // 2. Kích hoạt Âm thanh (Hack để trình duyệt cho phép phát nhạc sau này)
      if(music) {
        music.play().then(() => {
          music.pause();
          music.currentTime = 0;
          isAudioStarted = true;
        }).catch(e => console.log("Audio permission error:", e));
      }

      // 3. Ẩn màn hình Start sau khi AR load xong
      // Chúng ta sẽ lắng nghe sự kiện arReady của scene bên dưới
    }

    AFRAME.registerComponent('app-manager', {
      init: function() {
        const overlay = document.getElementById('overlay-screen');
        const guide = document.getElementById('scanning-guide');
        const music = document.querySelector('#bg-music');

        // Khi AR đã tải xong (Camera bật lên)
        this.el.addEventListener("arReady", () => {
          // Chỉ ẩn overlay nếu người dùng đã bấm Start (tránh trường hợp load xong trước khi bấm)
          const loadingText = document.getElementById('loading-text');
          if(loadingText.style.display === 'block') {
             overlay.style.opacity = '0';
             setTimeout(() => { overlay.style.display = 'none'; }, 500);
             guide.style.display = 'block'; // Hiện hướng dẫn soi thẻ
          } else {
             // Nếu AR load xong mà chưa bấm nút -> Đổi chữ Loading thành "Sẵn sàng"
             // (Logic này xử lý tự động bởi nút bấm ở trên rồi)
          }
        });

        // Khi tìm thấy hình ảnh
        this.el.addEventListener("targetFound", () => {
          guide.style.display = 'none'; // Ẩn hướng dẫn
          if(isAudioStarted && music) music.play();
        });

        // Khi mất hình ảnh
        this.el.addEventListener("targetLost", () => {
          guide.style.display = 'block'; // Hiện lại hướng dẫn
          if(isAudioStarted && music) music.pause();
        });
        
        // Fix lỗi loading mãi mãi: Tự động ẩn loading nếu AR ready
        this.el.addEventListener("arReady", () => {
             // Logic ghép vào nút bấm: 
             // Nút bấm kích hoạt -> Chờ AR Ready -> Ẩn Overlay
             const btn = document.getElementById('start-btn');
             btn.innerText = "BẮT ĐẦU TRẢI NGHIỆM"; // Cập nhật text báo sẵn sàng
             btn.onclick = function() {
                overlay.style.opacity = '0';
                setTimeout(() => { overlay.style.display = 'none'; }, 500);
                guide.style.display = 'block';
                // Kích hoạt nhạc
                if(music) {
                  music.play().then(() => { music.pause(); music.currentTime = 0; isAudioStarted = true; });
                }
             }
        });
      }
    });
    
    // Component mở link
    AFRAME.registerComponent('click-opener', {
      schema: { url: {type: 'string', default: ''} },
      init: function () {
        this.el.addEventListener('click', () => {
          if(this.data.url) window.open(this.data.url, '_blank');
        });
        this.el.addEventListener('mouseenter', () => { this.el.setAttribute('scale', '1.2 1.2 1.2'); });
        this.el.addEventListener('mouseleave', () => { this.el.setAttribute('scale', '1 1 1'); });
      }
    });
  </script>
</head>

<body>

  <div id="overlay-screen">
    <div class="title-text">AR GRADUATION CARD</div>
    <button id="start-btn">ĐANG KHỞI TẠO CAMERA...</button>
    <div id="loading-text"></div>
  </div>

  <div id="scanning-guide">
    <div class="guide-box">HÃY SOI VÀO TẤM THẺ</div>
  </div>

  <a-scene 
    app-manager
    mindar-image="imageTargetSrc: /ar-card/target.mind; filterMinCF:0.0001; filterBeta: 0.001; uiLoading: no; uiScanning: no; uiError: no;" 
    color-space="sRGB" 
    renderer="colorManagement: true, physicallyCorrectLights"
    shadow="type: pcfsoft"
    vr-mode-ui="enabled: false" 
    device-orientation-permission-ui="enabled: false">

    <a-assets>
      <a-asset-item id="avatarModel" src="/ar-card/avatar.glb"></a-asset-item>
      
      <img id="cardBg" src="/ar-card/tag.png" />
      <img id="ringImg" src="/ar-card/tag.png" /> 
      <img id="iconFB" src="/ar-card/tag.png" /> 
      <img id="iconWEB" src="/ar-card/tag.png" />
      <img id="iconZALO" src="/ar-card/tag.png" />
      
      <audio id="bg-music" src="/ar-card/music.mp3" preload="auto" loop></audio>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="far: 10000; objects: .clickable">
      <a-entity light="type: directional; intensity: 1.5; color: #00FFFF" position="2 4 2"></a-entity>
      <a-entity light="type: ambient; intensity: 0.6;"></a-entity>
    </a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      
      <a-image src="#ringImg" rotation="-90 0 0" position="0 -0.4 0.01"
        scale="0.9 0.9 0.9" opacity="0.5"
        animation="property: rotation; to:-90 360 0; dur:5000; loop:true; easing:linear">
      </a-image>

      <a-gltf-model src="#avatarModel"
        position="0 -0.4 0.05" scale="0.38 0.38 0.38"
        animation-mixer 
        animation="property: position; from: 0 -0.4 0.05; to: 0 -0.35 0.05; dir: alternate; dur: 2000; loop: true">
      </a-gltf-model>

      <a-image src="#iconFB" class="clickable"
        position="-0.3 -0.65 0.2" scale="0.15 0.15 0.15"
        animation="property: position; to:-0.3 -0.62 0.2; dir:alternate; dur:1500; loop:true"
        click-opener="url:https://www.facebook.com/tantai.ngo.397">
      </a-image>

      <a-image src="#iconWEB" class="clickable"
        position="0 -0.7 0.25" scale="0.18 0.18 0.18"
        animation="property: position; to:0 -0.67 0.25; dir:alternate; dur:1500; loop:true"
        click-opener="url:https://hethongthongminh.id.vn">
      </a-image>

      <a-image src="#iconZALO" class="clickable"
        position="0.3 -0.65 0.2" scale="0.15 0.15 0.15"
        animation="property: position; to:0.3 -0.62 0.2; dir:alternate; dur:1500; loop:true"
        click-opener="url:https://zalo.me/0812493802">
      </a-image>

      <a-entity position="0 0.1 0.1">
         <a-text value="NGO TAN TAI" align="center" width="2.8" color="#00FFFF" position="0 0.25 0" font="exo2bold"></a-text>
         <a-text value="ELECTRICAL ENGINEER" align="center" width="1.8" color="#FFF" position="0 0.15 0"></a-text>
      </a-entity>

    </a-entity>
  </a-scene>
</body>
</html>