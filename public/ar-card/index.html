<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Electrical Engineer Graduation</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body { margin: 0; background: #000; overflow: hidden; font-family:'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }

    /* FIX SAFARI / IPHONE */
    a-image, a-plane, a-entity { 
      backface-visibility: hidden; 
      -webkit-backface-visibility: hidden;
      transform-style: flat;
    }
    img { image-rendering: auto; }

    /* OVERLAY KHỞI ĐỘNG */
    #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
    .btn-start {
      padding: 14px 26px; font-size: 18px; font-weight: 700; 
      background: linear-gradient(90deg, #00FFFF, #0000FF);
      color: white; border:none; border-radius:30px; cursor:pointer; 
      box-shadow: 0 0 15px rgba(0,255,255,0.5);
    }

    /* AR CARD HTML CONTENT (HUD) */
    #ar-card-content {
      position: fixed;
      transform-origin: center center;
      will-change: transform, opacity;
      
      width: 280px; /* Kích thước chuẩn theo thiết kế mới */
      
      /* Glassmorphism Dark Theme */
      background: rgba(20, 20, 35, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      
      /* Viền Gradient: Cyan -> Gold */
      border: 2px solid transparent;
      background-image: linear-gradient(rgba(20, 20, 35, 0.95), rgba(20, 20, 35, 0.95)), linear-gradient(to right, #00C6FF, #FFD700);
      background-origin: border-box;
      background-clip: content-box, border-box;
      
      border-radius: 12px;
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8);
      
      padding: 12px;
      text-align: center;
      color: white;
      
      opacity: 0; 
      pointer-events: none; 
      /* CHÚ Ý: Loại bỏ 'transform' khỏi transition để tránh bị trễ (lag) khi di chuyển theo AR */
      transition: opacity 0.5s ease;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* HEADER */
    .card-header {
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 8px;
    }
    .card-header h1 {
      margin: 0; 
      font-size: 14px; 
      color: #00C6FF; /* Cyan */
      text-transform: uppercase; 
      letter-spacing: 1.5px; 
      font-weight: 700;
    }
    .card-header h2 {
      margin: 4px 0 0; 
      font-size: 16px; 
      color: #FFD700; /* Gold */
      font-weight: 700; 
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    #filmstrip-container {
      position: fixed;
      bottom: 20px; left: 0; width: 100%;
      height: 120px;
      overflow: hidden;
      z-index: 999;
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(5px);
    }
    #filmstrip-container.visible { opacity: 1; pointer-events: auto; }
    
    .filmstrip-track {
      display: flex;
      gap: 10px;
      position: absolute;
      left: 0; top: 10px;
      animation: scrollFilmstrip 30s linear infinite;
    }
    .filmstrip-img {
      height: 100px;
      width: auto;
      border-radius: 8px;
      border: 2px solid rgba(0, 255, 255, 0.5);
      object-fit: cover;
    }

    @keyframes scrollFilmstrip {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); } /* Di chuyển 50% vì track được nhân đôi */
    }

    #ar-card-content.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(-50%) scale(1);
    }

    /* HEADER */
    /* (Đã tích hợp vào .card-header ở trên) */

    /* SLIDESHOW */
    .slideshow-container {
      position: relative;
      width: 100%;
      aspect-ratio: 3/4;
      overflow: hidden;
      border-radius: 10px;
      border: 2px solid rgba(0, 255, 255, 0.3);
    }
    .slide-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0; left: 0;
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
    }
    .slide-img.active { opacity: 1; }

    /* MARQUEE */
    .marquee-container {
      overflow: hidden;
      white-space: nowrap;
      background: rgba(0,0,0,0.3);
      padding: 8px 0;
      border-radius: 8px;
    }
    .marquee-text {
      display: inline-block;
      padding-left: 100%;
      animation: marquee 15s linear infinite;
      color: #00FF00;
      font-size: 0.9rem;
    }

    @keyframes marquee {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    /* ACTION BUTTONS */
    .card-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .btn-action {
      background: rgba(0, 255, 255, 0.2);
      border: 1px solid #00FFFF;
      color: #00FFFF;
      padding: 6px 12px;
      border-radius: 20px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s;
      font-size: 0.8rem;
    }
  </style>

  <script>
    /* ---------------- ADVANCED EFFECTS ---------------- */
    /* 1. SHADOW CATCHER (Bóng đổ ảo) */
    AFRAME.registerComponent('shadow-catcher', {
      init: function() {
        const mesh = this.el.getObject3D('mesh');
        if(!mesh) return;
        mesh.material = new THREE.ShadowMaterial();
        mesh.material.opacity = 0.4; // Độ đậm của bóng
      }
    });

    /* 2. FLOATING & BOBBING (Lơ lửng) */
    AFRAME.registerComponent('floating', {
      schema: { speed: {default: 1.5}, amp: {default: 0.05} }, // Biên độ 5cm
      init: function() {
        this.orgPos = this.el.object3D.position.clone();
      },
      tick: function(t, dt) {
        const y = this.orgPos.y + Math.sin(t/1000 * this.data.speed) * this.data.amp;
        this.el.object3D.position.y = y;
        this.el.object3D.rotation.z = Math.sin(t/1500) * 0.03; // Xoay nhẹ ~2 độ
      }
    });

    /* 3. PARTICLE SYSTEM (Hạt năng lượng) */
    AFRAME.registerComponent('particles', {
      init: function() {
        this.particleCount = 60;
        this.particles = [];
        
        for(let i=0; i<this.particleCount; i++) {
          const p = document.createElement('a-plane'); // Dùng plane cho nhẹ
          p.setAttribute('width', 0.01 + Math.random()*0.02);
          p.setAttribute('height', 0.01 + Math.random()*0.02);
          p.setAttribute('color', '#00FFFF');
          p.setAttribute('material', 'shader: flat; transparent: true; opacity: 0; side: double');
          p.setAttribute('position', this.randomPos());
          p.setAttribute('rotation', `${Math.random()*360} ${Math.random()*360} ${Math.random()*360}`);
          this.el.appendChild(p);
          
          this.particles.push({
            el: p,
            life: Math.random() * 4000 + 4000,
            age: Math.random() * 4000,
            velocity: {
              x: (Math.random()-0.5)*0.0005,
              y: Math.random()*0.001 + 0.0002, // Bay lên nhẹ
              z: (Math.random()-0.5)*0.0005
            }
          });
        }
      },
      randomPos: function() {
        return `${(Math.random()-0.5)*1.2} ${(Math.random()-0.5)*0.5} ${(Math.random()-0.5)*0.5}`;
      },
      tick: function(t, dt) {
        if(!dt) return;
        this.particles.forEach(p => {
          p.age += dt;
          if(p.age > p.life) {
            p.age = 0;
            p.el.setAttribute('position', this.randomPos());
          }
          
          // Move
          const pos = p.el.object3D.position;
          pos.x += p.velocity.x * (dt/16);
          pos.y += p.velocity.y * (dt/16);
          pos.z += p.velocity.z * (dt/16);
          p.el.object3D.rotation.x += 0.01;
          
          // Fade logic
          const progress = p.age / p.life;
          let opacity = 0;
          if(progress < 0.2) opacity = progress * 5; 
          else if(progress > 0.8) opacity = (1 - progress) * 5; 
          else opacity = 1;
          
          p.el.getObject3D('mesh').material.opacity = opacity * 0.6;
        });
      }
    });

    /* 4. HTML FOLLOWER (Projection Mapping) */
    AFRAME.registerComponent('html-follower', {
      init: function() {
        this.htmlElement = document.getElementById('ar-card-content');
        this.camera = document.querySelector('a-camera').object3D;
        this.vector = new THREE.Vector3();
      },
      tick: function() {
        if (!this.htmlElement || !this.htmlElement.classList.contains('visible')) return;

        // 1. Lấy vị trí 3D của Anchor
        this.el.object3D.getWorldPosition(this.vector);
        
        // 2. Project 3D -> 2D (Normalized Device Coordinates)
        this.vector.project(this.el.sceneEl.camera);

        // 3. Convert NDC (-1 to +1) to Screen Coordinates (Pixels)
        const x = (this.vector.x * .5 + .5) * window.innerWidth;
        const y = -(this.vector.y * .5 - .5) * window.innerHeight;

        // 4. Tính khoảng cách để Scale
        const distance = this.el.object3D.position.distanceTo(this.camera.position);
        let scaleFactor = 1.8 / distance; // Điều chỉnh số 1.8 để thay đổi độ lớn
        scaleFactor = Math.min(Math.max(scaleFactor, 0.5), 2.0); // Limit scale

        // 5. Apply CSS Transform
        // Dùng translate3d để kích hoạt GPU
        this.htmlElement.style.transform = `translate3d(${x - this.htmlElement.offsetWidth/2}px, ${y - this.htmlElement.offsetHeight/2}px, 0) scale(${scaleFactor})`;
      }
    });

    /* ---------------- HTML SLIDESHOW ---------------- */
    let slideIndex = 0;
    function showSlides() {
      const slides = document.querySelectorAll('.slide-img');
      if (slides.length === 0) return;
      
      slides.forEach(img => img.classList.remove('active'));
      
      slideIndex++;
      if (slideIndex > slides.length) { slideIndex = 1; }
      
      slides[slideIndex - 1].classList.add('active');
      setTimeout(showSlides, 2500); // Change image every 2.5 seconds
    }

    /* ---------------- FILMSTRIP LOADER ---------------- */
    function loadFilmstrip() {
      const track = document.getElementById('filmstrip-track');
      const folder = '/image/graduation/kyniem/';
      
      // Hard-code danh sách ảnh để tránh lỗi 404 và tăng tốc độ load
      const hardcodedFiles = [
        "1.jpg", "2.jpg", "3.jpg", "4.jpg", "5.jpg", 
        "6.jpg", "7.jpg", "8.jpg", "9.jpg", "10.jpg"
      ];

      // Tạo HTML chuỗi ảnh
      const createImg = (name) => `<img src="${folder}${name}" class="filmstrip-img" onerror="this.style.display='none'">`;
      const html = hardcodedFiles.map(createImg).join('');
      
      // Nhân đôi chuỗi ảnh để tạo hiệu ứng lặp vô tận (scroll loop)
      track.innerHTML = html + html; 
    }

    /* ---------------- APP MANAGER & AR EVENTS ---------------- */
    AFRAME.registerComponent('app-manager',{
      init:function(){
        const btn = document.querySelector('.btn-start');
        const ov = document.getElementById('overlay');
        const audio = document.getElementById('bg-music');
        const video = document.getElementById('card-video'); // Video Overlay
        const videoEntity = document.querySelector('a-video'); // Entity chứa video
        const arContent = document.getElementById('ar-card-content');
        const filmstrip = document.getElementById('filmstrip-container');
        
        // Load filmstrip images
        loadFilmstrip();

        // Start Button
        btn.onclick=()=>{
          ov.style.opacity="0";
          setTimeout(()=>ov.style.display="none",350);
          audio.play().catch(()=>{});
          video.play().catch(()=>{}); // Unlock video & Keep playing
          // Start slideshow after user interaction
          showSlides();
        };

        const t = document.querySelector('[mindar-image-target]');
        
        // Target Found
        t.addEventListener('targetFound', () => {
          console.log("Target Found");
          audio.play().catch(()=>{});
          videoEntity.setAttribute('visible', true); // Show video entity
          arContent.classList.add('visible');
          filmstrip.classList.add('visible');
        });

        // Target Lost
        t.addEventListener('targetLost', () => {
          console.log("Target Lost");
          audio.pause();
          videoEntity.setAttribute('visible', false); // Hide video entity but keep playing
          arContent.classList.remove('visible');
          filmstrip.classList.remove('visible');
        });
      }
    });

    /* ---------------- BORDER SHIMMER (A-FRAME) ---------------- */
    AFRAME.registerComponent('circuit-anim',{
      tick:function(t){
        const k = 0.4 + Math.abs(Math.sin(t/310))*0.6;
        this.el.setAttribute('opacity', k);
      }
    });
  </script>
</head>

<body>

  <div id="overlay">
    <button class="btn-start">KHỞI ĐỘNG HỆ THỐNG</button>
  </div>

  <!-- AR CARD HTML OVERLAY (HUD) -->
  <div id="ar-card-content">
    
    <!-- Header -->
    <div class="card-header">
      <h1>CHÚC MỪNG TỐT NGHIỆP</h1>
      <h2>Tân Kỹ Sư Điện: Ngô Tấn Tài</h2>
    </div>

    <!-- Slideshow -->
    <div class="slideshow-container">
      <img src="/image/graduation/main1.jpg" class="slide-img active">
      <img src="/image/graduation/main2.jpg" class="slide-img">
      <img src="/image/graduation/main3.jpg" class="slide-img">
      <img src="/image/graduation/main4.jpg" class="slide-img">
      <img src="/image/graduation/main5.jpg" class="slide-img">
      <img src="/image/graduation/main6.jpg" class="slide-img">
    </div>

    <!-- Marquee -->
    <div class="marquee-container">
      <div class="marquee-text">
        Chúc mừng Ngô Tấn Tài đã xuất sắc hoàn thành chương trình đào tạo Kỹ sư Điện — Tương lai rực rỡ đang chờ đón! — Happy Graduation! —
      </div>
    </div>

  </div>

  <audio id="bg-music" src="/music/music.mp3" loop preload="auto"></audio>

  <!-- FILMSTRIP BOTTOM -->
  <div id="filmstrip-container">
    <div class="filmstrip-track" id="filmstrip-track">
      <!-- JS sẽ load ảnh vào đây -->
    </div>
  </div>

  <a-scene
    app-manager
    mindar-image="imageTargetSrc:/ar-card/target.mind; uiScanning:no; uiLoading:no;"
    color-space="sRGB"
    renderer="colorManagement:true; physicallyCorrectLights:true; antialias:true; sortObjects:true; shadowMap:true; shadowMapType:pcfsoft"
    device-orientation-permission-ui="enabled:false">

    <a-assets>
      <video id="card-video" src="/video/0111.mp4" loop="true" crossorigin="anonymous" playsinline webkit-playsinline></video>
    </a-assets>

    <a-camera look-controls="enabled:false"></a-camera>

    <!-- ÁNH SÁNG TỰ NHIÊN (3-POINT LIGHTING) -->
    <a-light type="ambient" intensity="0.6" color="#ffffff"></a-light>
    <a-light type="directional" intensity="1.2" position="1 2 1" color="#ffdcb4" cast-shadow="true" shadow-bias="-0.001" shadow-camera-far="10" shadow-camera-top="2" shadow-camera-bottom="-2" shadow-camera-left="-2" shadow-camera-right="2" shadow-mapSize-width="1024" shadow-mapSize-height="1024"></a-light>
    <a-light type="point" intensity="0.5" position="-2 1 -2" color="#b4d2ff" distance="10"></a-light>

    <a-entity mindar-image-target="targetIndex:0">

      <!-- 1. GHOST PLANE (Lớp phủ mờ bóng bẩy) -->
      <a-plane width="1" height="1.3" color="#FFF" opacity="0.05" position="0 0 0.001"></a-plane>

      <!-- 2. CYAN RING (Vòng tròn năng lượng) -->
      <a-ring radius-inner="0.3" radius-outer="0.31" color="#00FFFF" opacity="0.8" position="0 0 0.002"
              animation="property: rotation; to: 0 0 360; loop: true; dur: 10000; easing: linear">
      </a-ring>

      <!-- SHADOW CATCHER (MẶT PHẲNG HỨNG BÓNG) -->
      <a-plane position="0 0 0" width="2" height="2" rotation="0 0 0" shadow-catcher shadow="receive: true"></a-plane>

      <!-- ANCHOR CHO HTML FOLLOWER (ĐIỂM NEO VÔ HÌNH) -->
      <!-- Position: X=0.75 (Bên phải 75cm) -->
      <a-entity id="html-anchor" position="0.75 0 0" html-follower></a-entity>

      <!-- CONTAINER CHO AVATAR (CÓ HIỆU ỨNG LƠ LỬNG) -->
      <a-entity position="0.31 -0.20 0.15" floating>
        
        <!-- KHUNG ẢNH 3D (A-BOX) -->
        <a-box position="0 0 -0.01" width="0.6" height="0.8" depth="0.02" 
               color="#333" material="roughness: 0.3; metalness: 0.7" 
               shadow="cast: true; receive: true"></a-box>

        <!-- VIDEO OVERLAY (AVATAR ONLY) -->
        <a-video src="#card-video" width="0.55" height="0.71" position="0 0 0.015" opacity="0.9" visible="false"></a-video>

      </a-entity>

      <!-- HỆ THỐNG HẠT (PARTICLES) -->
      <a-entity particles position="0 0 0.1"></a-entity>

      <!-- BORDER 3D (GIỮ LẠI HIỆU ỨNG KHÔNG GIAN) -->
      <a-plane color="#00FFFF" width="1.1" height="0.01" position="0 0.55 0.01" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="1.1" height="0.01" position="0 -0.55 0.01" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="0.01" height="1.1"  position="-0.55 0 0.01" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="0.01" height="1.1"  position="0.55 0 0.01" shader="flat" circuit-anim></a-plane>

    </a-entity>
  </a-scene>
</body>
</html>
