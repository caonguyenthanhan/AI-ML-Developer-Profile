<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Electrical Engineer Graduation - AR Card</title>

  <!-- A-Frame & MindAR -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <!-- Confetti Effect -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    body { margin: 0; background: #000; overflow: hidden; font-family:'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }

    /* FIX SAFARI / IPHONE */
    a-image, a-plane, a-entity { 
      backface-visibility: hidden; 
      -webkit-backface-visibility: hidden;
      transform-style: flat;
    }
    img { image-rendering: auto; }

    /* START OVERLAY */
    #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
    .btn-start {
      padding: 14px 26px; font-size: 18px; font-weight: 700; 
      background: linear-gradient(90deg, #00FFFF, #0000FF);
      color: white; border:none; border-radius:30px; cursor:pointer; 
      box-shadow: 0 0 15px rgba(0,255,255,0.5);
    }

    /* SUBTITLE BOX (Text at Bottom) */
    .subtitle-box {
      position: fixed;
      bottom: 30px; left: 50%;
      transform: translateX(-50%);
      width: 90%; max-width: 400px;
      
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      
      padding: 15px;
      text-align: center;
      color: white;
      
      opacity: 0; 
      pointer-events: none; 
      transition: opacity 0.5s ease;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .subtitle-box.visible {
      opacity: 1;
      pointer-events: auto;
    }

    /* TYPOGRAPHY */
    .subtitle-box h1 {
      margin: 0;
      font-size: 1.2rem;
      color: #00FFFF;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 0 0 5px rgba(0,255,255,0.8);
    }
    .subtitle-box h2 {
      margin: 0;
      font-size: 1rem;
      color: #FFFFFF;
      font-weight: 400;
    }
    
    /* Tutorial Hint */
    .hint-text {
      position: fixed;
      top: 20px;
      width: 100%;
      text-align: center;
      color: rgba(255,255,255,0.7);
      font-size: 0.9rem;
      pointer-events: none;
      z-index: 998;
      opacity: 0;
      transition: opacity 0.5s;
    }
    .hint-text.visible { opacity: 1; }

  </style>

  <script>
    /* ---------------- ASSETS LIST ---------------- */
    const IMAGES = [
      '/image/graduation/main1.jpg',
      '/image/graduation/main2.jpg',
      '/image/graduation/main3.jpg',
      '/image/graduation/main4.jpg',
      '/image/graduation/main5.jpg',
      '/image/graduation/main6.jpg'
    ];

    /* ---------------- APP LOGIC ---------------- */
    AFRAME.registerComponent('app-manager', {
      init: function() {
        const btn = document.querySelector('.btn-start');
        const ov = document.getElementById('overlay');
        const audio = document.getElementById('bg-music');
        const subtitle = document.querySelector('.subtitle-box');
        const hint = document.querySelector('.hint-text');
        
        // Start Button
        btn.onclick = () => {
          ov.style.opacity = "0";
          setTimeout(() => ov.style.display = "none", 350);
          // Don't auto-play audio here to allow user interaction first if needed, 
          // or auto-play if browser allows. Best to wait for user gesture on AR scene.
          audio.play().catch(() => {});
        };

        const t = document.querySelector('[mindar-image-target]');
        
        // Target Found
        t.addEventListener('targetFound', () => {
          console.log("Target Found");
          audio.play().catch(() => {});
          subtitle.classList.add('visible');
          hint.classList.add('visible');
          
          // Fire Confetti
          confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#00FFFF', '#FFD700', '#FFFFFF']
          });
        });

        // Target Lost
        t.addEventListener('targetLost', () => {
          console.log("Target Lost");
          audio.pause();
          subtitle.classList.remove('visible');
          hint.classList.remove('visible');
        });
      }
    });

    /* ---------------- IMAGE CHANGER COMPONENT ---------------- */
    AFRAME.registerComponent('change-image', {
      init: function() {
        this.index = 0;
        this.el.addEventListener('click', () => {
          this.index = (this.index + 1) % IMAGES.length;
          const newSrc = IMAGES[this.index];
          this.el.setAttribute('src', newSrc);
          
          // Small scale animation on click
          this.el.object3D.scale.set(0.95, 0.95, 0.95);
          setTimeout(() => {
            this.el.object3D.scale.set(1, 1, 1);
          }, 150);
        });
      }
    });

    /* ---------------- MUSIC TOGGLE COMPONENT ---------------- */
    AFRAME.registerComponent('music-control', {
      init: function() {
        this.isPlaying = true;
        const audio = document.getElementById('bg-music');
        const text = this.el.querySelector('a-text');
        
        this.el.addEventListener('click', () => {
          if (this.isPlaying) {
            audio.pause();
            this.el.setAttribute('color', '#555'); // Dim color
            text.setAttribute('value', 'OFF');
          } else {
            audio.play().catch(()=>{});
            this.el.setAttribute('color', '#FFD700'); // Active color
            text.setAttribute('value', '♪');
          }
          this.isPlaying = !this.isPlaying;
          
          // Spin animation
          this.el.emit('spin');
        });
      }
    });
  </script>
</head>

<body>

  <div id="overlay">
    <button class="btn-start">START SYSTEM</button>
  </div>
  
  <div class="hint-text">Tap image to change • Tap note for music</div>

  <!-- SUBTITLE BOX (HTML) -->
  <div class="subtitle-box">
    <h1>HAPPY GRADUATION</h1>
    <h2>Electrical Engineer: Ngo Tan Tai</h2>
  </div>

  <audio id="bg-music" src="/music/music.mp3" loop preload="auto"></audio>

  <a-scene
    app-manager
    mindar-image="imageTargetSrc:/ar-card/target.mind; uiScanning:no; uiLoading:no;"
    color-space="sRGB"
    renderer="colorManagement:true; physicallyCorrectLights:true; antialias:true; sortObjects:true;"
    device-orientation-permission-ui="enabled:false">

    <a-assets>
      <img id="img-start" src="/image/graduation/main1.jpg">
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;">
      <!-- Visual Cursor (Yellow Ring) -->
      <a-cursor color="#FFD700" scale="0.5 0.5 0.5" raycaster="objects: .clickable"></a-cursor>
    </a-camera>

    <a-entity mindar-image-target="targetIndex:0">

      <!-- FLOATING GROUP -->
      <a-entity animation="property: position; to: 0 0.1 0; dir: alternate; loop: true; dur: 2000; easing: easeInOutSine">
        
        <!-- White Border Frame -->
        <a-plane width="1.1" height="1.1" color="white" position="0 0 0"></a-plane>
        
        <!-- Main Image Display -->
        <a-plane id="ar-display-img" 
                 src="#img-start" 
                 width="1" height="1" 
                 position="0 0 0.01" 
                 class="clickable" 
                 change-image>
        </a-plane>

      </a-entity>

      <!-- MUSIC BUTTON (Floating Right) -->
      <a-circle position="0.8 0 0" radius="0.15" color="#FFD700" 
                class="clickable" music-control
                animation__spin="property: rotation; to: 0 360 0; dur: 500; startEvents: spin">
        <a-text value="♪" color="black" align="center" width="4" position="0 -0.05 0.02"></a-text>
      </a-circle>

    </a-entity>
  </a-scene>
</body>
</html>