<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Electrical Engineer Graduation</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body { margin: 0; background: #000; overflow: hidden; }
    #overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10;
      display: flex; align-items: center; justify-content: center;
      color: #00FFFF; font-family: sans-serif; font-weight: bold;
      pointer-events: none;
    }
    .mindar-ui-scanning #overlay { display: flex; }
    .mindar-ui-loading #overlay { display: none; }
  </style>

  <script>
    // --- 1. COMPONENT DẢI PHIM TỰ ĐỘNG (Đọc từ JSON) ---
    AFRAME.registerComponent('auto-filmstrip', {
      schema: {
        jsonUrl: {type: 'string', default: '/image/graduation/kyniem/list.json'},
        folder: {type: 'string', default: '/image/graduation/kyniem/'}
      },
      init: function() {
        const el = this.el;
        const data = this.data;

        // Fetch file JSON danh sách
        fetch(data.jsonUrl)
          .then(response => {
            if (!response.ok) throw new Error("Chưa chạy script scan_images.py!");
            return response.json();
          })
          .then(files => {
            console.log("Đã load được danh sách ảnh:", files);
            
            let x = -0.6; // Vị trí bắt đầu
            
            // Nếu ít ảnh quá thì nhân đôi lên để loop cho đẹp
            let loopFiles = files.length < 5 ? [...files, ...files, ...files] : files;

            loopFiles.forEach(filename => {
              const img = document.createElement('a-image');
              img.setAttribute('src', data.folder + filename);
              img.setAttribute('width', '0.35');
              img.setAttribute('height', '0.25');
              // Shader flat để ảnh sáng rõ
              img.setAttribute('material', 'shader: flat; transparent: true');
              img.setAttribute('position', `${x} -0.4 0.02`);
              
              // Animation chạy ngang vô tận
              img.setAttribute('animation', {
                property: 'position',
                to: `${x + 1.5} -0.4 0.02`,
                dur: 8000 + (Math.random() * 2000), // Random tốc độ chút cho tự nhiên
                loop: true,
                easing: 'linear'
              });

              el.appendChild(img);
              x += 0.38; // Khoảng cách giữa các ảnh
            });
          })
          .catch(err => {
            console.error("Lỗi load ảnh kỷ niệm:", err);
            // Tạo text báo lỗi nếu quên chạy script
            const txt = document.createElement('a-text');
            txt.setAttribute('value', 'Run python script first!');
            txt.setAttribute('color', 'red');
            txt.setAttribute('position', '0 -0.4 0');
            el.appendChild(txt);
          });
      }
    });

    // --- 2. HIỆU ỨNG VIỀN MẠCH ĐIỆN (Circuit Border) ---
    AFRAME.registerComponent('circuit-anim', {
      tick: function(t) {
        // Tạo hiệu ứng nhấp nháy như dòng điện
        const intensity = 0.5 + Math.abs(Math.sin(t / 200)) * 0.5;
        this.el.setAttribute('opacity', intensity);
      }
    });
  </script>
</head>

<body>
  <div id="overlay">ĐANG TẢI DỮ LIỆU KỸ SƯ...</div>

  <a-scene 
    mindar-image="imageTargetSrc: /ar-card/target.mind; uiScanning: no;" 
    color-space="sRGB" 
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false" 
    device-orientation-permission-ui="enabled: false">

    <a-assets>
      <img id="nguyetque" src="/image/graduation/nguyet-que.png" />
      
      <img id="fallback" src="/ar-card/tag.png">
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">

      <a-plane color="#00FFFF" width="1.2" height="0.02" position="0 0.38 0" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="1.2" height="0.02" position="0 -0.55 0" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="0.02" height="0.95" position="-0.6 0 -0.08" shader="flat" circuit-anim></a-plane>
      <a-plane color="#00FFFF" width="0.02" height="0.95" position="0.6 0 -0.08" shader="flat" circuit-anim></a-plane>

      <a-circle color="#00FFFF" radius="0.04" position="-0.6 0.38 0.01" shader="flat"></a-circle>
      <a-circle color="#00FFFF" radius="0.04" position="0.6 0.38 0.01" shader="flat"></a-circle>
      <a-circle color="#00FFFF" radius="0.04" position="-0.6 -0.55 0.01" shader="flat"></a-circle>
      <a-circle color="#00FFFF" radius="0.6" position="0.6 -0.55 0.01" shader="flat"></a-circle>


      <a-image src="#nguyetque" onerror="this.src='#fallback'"
               position="0 0 0.01" 
               width="0.8" height="0.8" 
               opacity="0.9"
               animation="property: rotation; to: 0 0 360; dur: 10000; easing: linear; loop: true">
      </a-image>


      <a-entity position="0 0.2 0.05">
        <a-text value="CHUC MUNG TOT NGHIEP" color="#000" align="center" width="3" position="0.02 -0.02 -0.01" font="exo2bold"></a-text>
        <a-text value="CHUC MUNG TOT NGHIEP" color="#FFD700" align="center" width="3" position="0 0 0" font="exo2bold"></a-text>
        
        <a-text value="TAN KY SU DIEN - NGO TAN TAI" color="#FFF" align="center" width="2" position="0 -0.15 0" font="roboto"></a-text>
      </a-entity>


      <a-entity auto-filmstrip></a-entity>

    </a-entity>
  </a-scene>
</body>
</html>