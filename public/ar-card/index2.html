<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Electrical Engineer Graduation - AR Sync</title>

  <!-- A-Frame & MindAR -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    /* --- CẤU HÌNH CƠ BẢN --- */
    body { 
      margin: 0; 
      background: #000; 
      overflow: hidden; 
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
    }
    
    /* Ngăn người dùng chọn văn bản/ảnh khi đang thao tác AR */
    * { user-select: none; -webkit-user-select: none; }

    /* Màn hình chờ */
    #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
    .btn-start {
      padding: 15px 30px; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
      background: linear-gradient(135deg, #00C6FF, #0072FF);
      color: white; border: none; border-radius: 50px; cursor: pointer; 
      box-shadow: 0 0 20px rgba(0, 114, 255, 0.6);
      animation: pulse 2s infinite;
    }

    /* --- AR HTML CARD (DYNAMIC) --- */
    /* Quan trọng: position absolute để di chuyển, top/left = 0 để làm gốc */
    #ar-card-content {
      position: absolute;
      top: 0; left: 0;
      width: 260px; /* Kích thước chuẩn */
      
      /* Gốc biến hình nằm ở giữa để scale đẹp hơn */
      transform-origin: center center;
      
      background: rgba(16, 20, 30, 0.85); /* Nền tối sang trọng */
      backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      
      padding: 15px;
      text-align: center;
      color: white;
      
      /* Mặc định ẩn, JS sẽ hiện khi tracking */
      opacity: 0;
      pointer-events: none; /* Không chặn thao tác zoom/xoay của AR */
      z-index: 1000;
      
      /* Will-change giúp trình duyệt tối ưu render */
      will-change: transform, opacity;
    }

    /* Nội dung bên trong thẻ */
    .card-header h1 { margin: 0; font-size: 16px; color: #00FFFF; text-transform: uppercase; letter-spacing: 1px; }
    .card-header h2 { margin: 5px 0 10px; font-size: 12px; color: #ccc; font-weight: 400; }
    
    .slideshow-container {
      position: relative; width: 100%; aspect-ratio: 4/5;
      overflow: hidden; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
      background: #000;
    }
    .slide-img {
      width: 100%; height: 100%; object-fit: cover;
      position: absolute; top: 0; left: 0;
      opacity: 0; transition: opacity 0.8s ease;
    }
    .slide-img.active { opacity: 1; }

    /* Filmstrip (Dải ảnh bên dưới - Giữ nguyên fixed cho đẹp) */
    #filmstrip-container {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 100px;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      z-index: 900; opacity: 0; transition: opacity 0.5s; pointer-events: none;
    }
    #filmstrip-container.visible { opacity: 1; }
    
    /* Animation */
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
  </style>

  <script>
    /* --- COMPONENT: HTML FOLLOWER (TRÁI TIM CỦA LOGIC NÀY) --- */
    AFRAME.registerComponent('html-follower', {
      schema: {
        target: {type: 'selector'}, // Thẻ HTML cần di chuyển
        offset: {type: 'vec3', default: {x: 0, y: 0, z: 0}}, // Độ lệch vị trí
        minScale: {default: 0.5},
        maxScale: {default: 1.5}
      },
      init: function() {
        this.htmlEl = this.data.target;
        this.vector = new THREE.Vector3(); // Biến tạm để tính toán
        this.camera = document.querySelector('a-camera').object3D;
        this.isVisible = false;
      },
      tick: function() {
        if (!this.el.object3D.visible) {
          if (this.isVisible) {
            this.htmlEl.style.opacity = 0;
            this.isVisible = false;
          }
          return;
        }

        // 1. Lấy vị trí thế giới thực của Entity 3D
        this.el.object3D.getWorldPosition(this.vector);
        
        // 2. Chiếu vị trí đó lên màn hình Camera (Normalized Device Coordinates)
        // Kết quả trả về x, y trong khoảng [-1, 1]
        this.vector.project(this.el.sceneEl.camera);

        const x = this.vector.x;
        const y = this.vector.y;
        const z = this.vector.z; // z < 1 nghĩa là nằm trước camera

        // 3. Chuyển đổi sang pixel màn hình
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        const screenX = (x * 0.5 + 0.5) * width;
        const screenY = -(y * 0.5 - 0.5) * height;

        // 4. Tính toán Scale dựa trên khoảng cách (Distance Scaling)
        // Lấy khoảng cách từ camera đến vật thể
        const distance = this.el.object3D.position.distanceTo(this.camera.position);
        
        // Công thức nội suy scale: Càng xa càng nhỏ
        // Giả sử khoảng cách chuẩn là 2 mét (scale 1)
        let scaleFactor = 1.8 / distance; 
        scaleFactor = Math.min(Math.max(scaleFactor, this.data.minScale), this.data.maxScale);

        // 5. Cập nhật CSS (Chỉ render khi vật thể nằm trong khung hình và phía trước camera)
        if (z < 1 && x > -1.2 && x < 1.2 && y > -1.2 && y < 1.2) {
            // Dùng translate3d(-50%, -50%, 0) để tâm thẻ nằm đúng điểm neo
            // Cộng thêm vị trí màn hình screenX, screenY
            this.htmlEl.style.transform = `translate3d(${screenX}px, ${screenY}px, 0) translate(-50%, -50%) scale(${scaleFactor})`;
            
            if (!this.isVisible) {
                this.htmlEl.style.opacity = 1;
                this.isVisible = true;
            }
        } else {
            if (this.isVisible) {
                this.htmlEl.style.opacity = 0;
                this.isVisible = false;
            }
        }
      }
    });

    // --- CÁC LOGIC KHÁC (SLIDESHOW, START...) ---
    AFRAME.registerComponent('app-manager', {
      init: function() {
        const btn = document.querySelector('.btn-start');
        const overlay = document.getElementById('overlay');
        const audio = document.getElementById('bg-music');
        const filmstrip = document.getElementById('filmstrip-container');
        
        // Slideshow logic
        let slideIndex = 0;
        const showSlides = () => {
          const slides = document.querySelectorAll('.slide-img');
          if(!slides.length) return;
          slides.forEach(s => s.classList.remove('active'));
          slideIndex = (slideIndex + 1) % slides.length;
          slides[slideIndex].classList.add('active');
        };
        setInterval(showSlides, 2500);

        btn.onclick = () => {
          overlay.style.opacity = 0;
          setTimeout(() => overlay.remove(), 500);
          audio.play().catch(()=>{});
        };

        const target = document.querySelector('[mindar-image-target]');
        target.addEventListener('targetFound', () => {
          filmstrip.classList.add('visible');
          audio.play().catch(()=>{});
        });
        target.addEventListener('targetLost', () => {
          filmstrip.classList.remove('visible');
          audio.pause();
        });
      }
    });
  </script>
</head>

<body>

  <div id="overlay">
    <button class="btn-start">Start Experience</button>
  </div>

  <!-- THẺ HTML CHÍNH (Sẽ bay theo tấm thiệp) -->
  <div id="ar-card-content">
    <div class="card-header">
      <h1>Chúc Mừng Tốt Nghiệp</h1>
      <h2>Tân Kỹ Sư Điện: Ngô Tấn Tài</h2>
    </div>
    <div class="slideshow-container">
      <img src="/image/graduation/main1.jpg" class="slide-img active">
      <img src="/image/graduation/main2.jpg" class="slide-img">
      <img src="/image/graduation/main3.jpg" class="slide-img">
      <img src="/image/graduation/main4.jpg" class="slide-img">
    </div>
    <p style="font-size: 11px; margin-top: 10px; opacity: 0.8;">
      "Không có áp lực, không có kim cương."
    </p>
  </div>

  <audio id="bg-music" src="/music/music.mp3" loop></audio>

  <!-- Dải film bên dưới (Trang trí) -->
  <div id="filmstrip-container"></div>

  <!-- A-FRAME SCENE -->
  <a-scene 
    app-manager
    mindar-image="imageTargetSrc: /ar-card/target.mind; uiScanning: no; uiLoading: no;" 
    color-space="sRGB" 
    renderer="colorManagement: true, physicallyCorrectLights: true" 
    vr-mode-ui="enabled: false" 
    device-orientation-permission-ui="enabled: false">

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- TARGET -->
    <a-entity mindar-image-target="targetIndex: 0">
      
      <!-- 1. ĐIỂM NEO CHO THẺ HTML (HTML ANCHOR) -->
      <!-- Vị trí x=0.8 nghĩa là thẻ HTML sẽ bay lơ lửng bên PHẢI tấm thiệp 0.8 mét (trong hệ toạ độ AR) -->
      <!-- Bạn thay đổi position ở đây để chỉnh vị trí thẻ HTML so với tấm ảnh thật -->
      <a-entity 
        id="html-anchor" 
        position="0.8 0 0" 
        html-follower="target: #ar-card-content">
      </a-entity>

      <!-- 2. HIỆU ỨNG 3D TRÊN THIỆP -->
      <a-plane position="0 0 0" width="1" height="1.4" color="white" opacity="0.1"></a-plane>
      
      <!-- Một vòng tròn xoay xoay ảo diệu -->
      <a-ring color="#00FFFF" radius-inner="0.6" radius-outer="0.62" position="0 0 0"
        animation="property: rotation; to: 0 0 360; dur: 8000; loop: true; easing: linear">
      </a-ring>

    </a-entity>
  </a-scene>
</body>
</html>