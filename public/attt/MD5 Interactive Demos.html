<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD5 Educational Lab - Học liệu số Tương tác</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .reg-box { transition: all 0.3s ease; }
        .reg-changed { background-color: #fef08a; transform: scale(1.05); border-color: #eab308; }
        
        /* Step Progress Bar */
        .step-dot { width: 8px; height: 8px; background: #e2e8f0; border-radius: 50%; }
        .step-dot.active { background: #3b82f6; transform: scale(1.5); }
        .step-dot.passed { background: #93c5fd; }

        /* Terminal Cursor */
        @keyframes blink { 50% { opacity: 0; } }
        .cursor::after { content: '▋'; animation: blink 1s step-start infinite; color: #22c55e; }
        
        .tab-btn { opacity: 0.7; border-bottom: 3px solid transparent; }
        .tab-btn:hover { opacity: 1; background-color: rgba(255,255,255,0.5); }
        .tab-btn.active { opacity: 1; border-bottom: 3px solid #2563eb; color: #2563eb; background: #eff6ff; font-weight: 700; }

        /* Diff Highlight */
        .diff-byte { color: #ef4444; font-weight: bold; background-color: #fee2e2; border-radius: 2px; padding: 0 2px; }

        /* Typography for Theory Tab */
        .prose h3 { color: #1e293b; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em; font-size: 1.25rem; }
        .prose p { color: #475569; line-height: 1.7; margin-bottom: 1em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; color: #475569; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.5em; }
        .prose strong { color: #0f172a; font-weight: 600; }
        .prose code { background-color: #f1f5f9; color: #0f172a; padding: 0.2em 0.4em; border-radius: 0.25em; font-size: 0.9em; font-family: 'JetBrains Mono', monospace; }
        
        /* New Collision Demo Styles */
        .code-window { background: #1e293b; color: #cbd5e1; font-family: 'JetBrains Mono', monospace; padding: 1rem; border-radius: 0.5rem; font-size: 0.85rem; line-height: 1.5; overflow: hidden; position: relative; }
        .code-window::before { content: '● ● ●'; color: #475569; font-size: 0.6rem; position: absolute; top: 0.5rem; left: 0.5rem; letter-spacing: 2px; }
        .arrow-down { font-size: 1.5rem; color: #94a3b8; margin: 1rem 0; text-align: center; display: block; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-6 py-3 flex items-center justify-between shrink-0 shadow-sm z-20 relative">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-blue-600 to-indigo-700 text-white p-2.5 rounded-lg shadow-lg shadow-blue-200">
                <i class="fa-solid fa-graduation-cap text-xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-800 leading-tight">MD5 Educational Lab</h1>
                <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">Dành cho sinh viên ATTT</p>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <nav class="flex gap-1 bg-slate-100 p-1 rounded-lg overflow-x-auto">
            <button onclick="switchTab('theory')" id="btn-theory" class="tab-btn active px-4 py-2 rounded-md text-sm transition-all whitespace-nowrap flex items-center gap-2">
                <i class="fa-solid fa-book-open"></i> Lý thuyết & Bài giảng
            </button>
            <div class="w-px bg-slate-300 mx-1 my-2"></div>
            <button onclick="switchTab('algo')" id="btn-algo" class="tab-btn px-4 py-2 rounded-md text-sm transition-all whitespace-nowrap">1. Cấu trúc Lõi</button>
            <button onclick="switchTab('avalanche')" id="btn-avalanche" class="tab-btn px-4 py-2 rounded-md text-sm transition-all whitespace-nowrap">2. Tuyết lở</button>
            <button onclick="switchTab('collision')" id="btn-collision" class="tab-btn px-4 py-2 rounded-md text-sm transition-all whitespace-nowrap">3. Demo Va chạm</button>
            <button onclick="switchTab('length_ext')" id="btn-length_ext" class="tab-btn px-4 py-2 rounded-md text-sm transition-all whitespace-nowrap">4. Tấn công Mở rộng</button>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-slate-50 relative scroll-smooth">

        <!-- TAB 0: THEORY -->
        <section id="tab-theory" class="max-w-5xl mx-auto p-8 pb-20">
            <!-- (Giữ nguyên nội dung Tab Lý thuyết như cũ) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-900 text-white p-10 relative overflow-hidden">
                    <div class="absolute top-0 right-0 opacity-10 text-9xl transform translate-x-10 -translate-y-10">
                        <i class="fa-solid fa-shield-halved"></i>
                    </div>
                    <h2 class="text-3xl font-bold mb-4">Tổng quan về MD5 và An toàn thông tin</h2>
                    <p class="text-slate-300 text-lg max-w-2xl">Tài liệu tự học tích hợp demo tương tác. Khám phá kiến trúc, lỗ hổng và ứng dụng thực tế của thuật toán băm MD5.</p>
                </div>
                <div class="grid grid-cols-12 gap-0">
                    <div class="col-span-3 bg-slate-50 border-r border-slate-200 p-6 hidden md:block">
                        <h4 class="font-bold text-slate-400 text-xs uppercase tracking-wider mb-4">MỤC LỤC</h4>
                        <ul class="space-y-3 text-sm font-medium text-slate-600">
                            <li><a href="#phan1" class="hover:text-blue-600 block">1. Giới thiệu & Lịch sử</a></li>
                            <li><a href="#phan2" class="hover:text-blue-600 block">2. Kiến trúc Kỹ thuật</a></li>
                            <li><a href="#phan3" class="hover:text-blue-600 block">3. Hiệu ứng Tuyết lở</a></li>
                            <li><a href="#phan4" class="hover:text-blue-600 block">4. Khủng hoảng Va chạm</a></li>
                            <li><a href="#phan5" class="hover:text-blue-600 block">5. Kết luận</a></li>
                        </ul>
                    </div>
                    <div class="col-span-12 md:col-span-9 p-10 prose max-w-none">
                        <div id="phan1" class="mb-12">
                            <h3 class="text-blue-700 border-b border-blue-100 pb-2">1. Giới thiệu</h3>
                            <p>MD5 là hàm băm mật mã 128-bit phổ biến. Tuy nhiên, nó đã bị phá vỡ hoàn toàn về mặt kháng va chạm.</p>
                        </div>
                        <div id="phan4" class="mb-12">
                            <h3 class="text-blue-700 border-b border-blue-100 pb-2">4. Khủng hoảng Va chạm</h3>
                            <p>Phần này quan trọng nhất. Hãy chuyển sang <strong>Tab 3</strong> để xem demo cách tạo ra 2 phần mềm khác nhau (Lành tính vs Độc hại) nhưng có cùng chữ ký MD5.</p>
                            <button onclick="switchTab('collision')" class="bg-blue-100 text-blue-700 px-4 py-2 rounded font-bold hover:bg-blue-200 transition">Đi đến Demo Va chạm >></button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB 1: ALGORITHM VISUALIZATION -->
        <section id="tab-algo" class="max-w-6xl mx-auto h-full flex flex-col hidden p-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex-1 flex flex-col">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-lg font-bold flex items-center gap-2 text-slate-800">
                            <i class="fa-solid fa-gears text-blue-500"></i> Mô phỏng Bên trong MD5
                        </h2>
                        <p class="text-sm text-slate-500 mt-1">Xem giá trị các thanh ghi A, B, C, D thay đổi qua 64 bước biến đổi.</p>
                    </div>
                    <div class="bg-slate-100 p-2 rounded-lg flex items-center gap-2">
                        <input type="text" id="algo-input" value="abc" class="bg-white border border-slate-300 rounded px-3 py-1 text-sm w-32 focus:outline-none focus:border-blue-500" placeholder="Input...">
                        <button onclick="initAlgoDemo()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">Nạp dữ liệu</button>
                    </div>
                </div>
                <div class="flex-1 grid grid-cols-12 gap-6">
                    <div class="col-span-4 flex flex-col gap-4">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-xs font-bold text-slate-500 uppercase">Điều khiển</span>
                                <span id="step-counter" class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded">Step 0 / 64</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="algoStep(1)" class="bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 shadow-sm flex items-center justify-center gap-2"><i class="fa-solid fa-play"></i> Bước tiếp</button>
                                <button onclick="algoAutoPlay()" id="btn-autoplay" class="bg-white text-slate-700 border border-slate-300 py-2 rounded-lg font-medium hover:bg-slate-50 flex items-center justify-center gap-2"><i class="fa-solid fa-forward"></i> Tự chạy</button>
                                <button onclick="algoReset()" class="col-span-2 bg-slate-200 text-slate-600 py-2 rounded-lg text-sm hover:bg-slate-300"><i class="fa-solid fa-rotate-left"></i> Reset</button>
                            </div>
                        </div>
                        <div class="bg-slate-900 text-green-400 p-4 rounded-xl font-mono text-sm leading-relaxed shadow-inner overflow-hidden relative">
                            <div class="absolute top-2 right-2 text-xs text-slate-500">LOGIC</div>
                            <div id="algo-log"><div class="opacity-50">Waiting to start...</div></div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-center">
                            <div class="text-xs text-yellow-700 font-bold mb-2 uppercase">Công thức Bước <span id="current-step-display">i</span></div>
                            <div class="font-serif text-lg text-slate-800 italic">A = B + ((A + <span class="text-blue-600 font-bold">F</span> + M + K) <<< s)</div>
                            <div class="text-xs text-slate-500 mt-2">*Sau đó hoán vị: D→A, C→D, B→C</div>
                        </div>
                    </div>
                    <div class="col-span-8 bg-slate-50 rounded-xl border border-slate-200 p-6 relative flex flex-col justify-center items-center">
                        <div class="grid grid-cols-4 gap-4 w-full mb-10">
                            <div id="reg-a" class="reg-box bg-white p-4 rounded-xl border-2 border-slate-200 shadow-sm text-center relative"><div class="text-xs font-bold text-slate-400 absolute top-2 left-3">REG A</div><div class="font-mono text-lg font-bold text-slate-700 mt-2 val">00000000</div></div>
                            <div id="reg-b" class="reg-box bg-white p-4 rounded-xl border-2 border-blue-500 shadow-md text-center relative transform scale-105"><div class="text-xs font-bold text-blue-500 absolute top-2 left-3">REG B</div><div class="font-mono text-lg font-bold text-blue-600 mt-2 val">00000000</div><div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs text-blue-500 font-bold"><i class="fa-solid fa-arrow-up"></i> Updated</div></div>
                            <div id="reg-c" class="reg-box bg-white p-4 rounded-xl border-2 border-slate-200 shadow-sm text-center relative"><div class="text-xs font-bold text-slate-400 absolute top-2 left-3">REG C</div><div class="font-mono text-lg font-bold text-slate-700 mt-2 val">00000000</div></div>
                            <div id="reg-d" class="reg-box bg-white p-4 rounded-xl border-2 border-slate-200 shadow-sm text-center relative"><div class="text-xs font-bold text-slate-400 absolute top-2 left-3">REG D</div><div class="font-mono text-lg font-bold text-slate-700 mt-2 val">00000000</div></div>
                        </div>
                        <div class="w-full px-4">
                            <div class="flex justify-between text-xs text-slate-400 mb-2 uppercase font-bold"><span>Round 1 (F)</span><span>Round 2 (G)</span><span>Round 3 (H)</span><span>Round 4 (I)</span></div>
                            <div class="h-2 bg-slate-200 rounded-full overflow-hidden"><div id="progress-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div></div>
                            <div class="flex justify-between mt-2" id="step-dots"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB 2: AVALANCHE EFFECT -->
        <section id="tab-avalanche" class="max-w-5xl mx-auto space-y-6 hidden p-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-hill-rockslide text-indigo-500"></i> Demo: Hiệu ứng Tuyết lở</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-3">
                        <label class="block text-sm font-medium text-slate-700">Input A</label>
                        <input type="text" id="input1" value="Hello World" oninput="updateAvalanche()" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none mono text-sm">
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200"><div id="hash1" class="mono text-blue-600 font-bold text-sm break-all">...</div></div>
                    </div>
                    <div class="space-y-3">
                        <label class="block text-sm font-medium text-slate-700">Input B</label>
                        <input type="text" id="input2" value="hello World" oninput="updateAvalanche()" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-red-500 focus:outline-none mono text-sm">
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200"><div id="hash2" class="mono text-red-600 font-bold text-sm break-all">...</div></div>
                    </div>
                </div>
                <div class="mt-8 pt-6 border-t border-slate-100">
                    <div class="bg-slate-900 rounded-lg p-4 overflow-x-auto text-white"><div id="binary-viz" class="mono text-sm leading-relaxed whitespace-nowrap"></div></div>
                    <div class="mt-4 flex items-center justify-between text-sm">
                        <span class="text-slate-600">Thay đổi: <span id="diff-percent" class="font-bold text-slate-900">0%</span></span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2.5 mt-2"><div id="diff-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                </div>
            </div>
        </section>

        <!-- TAB 3: COLLISION DEMO (UPDATED) -->
        <section id="tab-collision" class="max-w-6xl mx-auto hidden p-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[700px]">
                <!-- Control Header -->
                <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                    <div>
                        <h2 class="text-lg font-bold flex items-center gap-2 text-slate-800">
                            <i class="fa-solid fa-car-burst text-red-500"></i> Demo: Tạo Va chạm Phần mềm (Evil Twin)
                        </h2>
                        <p class="text-xs text-slate-500">Quy trình giả mạo phần mềm: Từ Source Code đến Thực thi.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="resetCollisionStep()" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-sm font-medium transition-colors">Làm lại</button>
                        <button onclick="nextCollisionStep()" id="btn-col-next" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold shadow-md transition-all flex items-center gap-2">
                            Bước tiếp theo <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Main Content (Scrollable) -->
                <div class="flex-1 p-6 overflow-y-auto bg-slate-100">
                    <div class="max-w-5xl mx-auto space-y-8">
                        
                        <!-- Step 1: Source Code -->
                        <div id="col-step-1" class="step-card bg-white p-6 rounded-xl border border-slate-200 shadow-sm transition-all duration-500">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">1</div>
                                <h3 class="font-bold text-slate-800">Bước 1: Viết 2 chương trình (Source Code)</h3>
                            </div>
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs font-bold text-green-600 uppercase"><i class="fa-solid fa-shield-halved mr-1"></i> Chương trình A (Lành tính)</span>
                                        <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">good.c</span>
                                    </div>
                                    <div class="code-window">
                                        <span class="text-pink-400">void</span> main() {<br>
                                        &nbsp;&nbsp;<span class="text-purple-400">printf</span>(<span class="text-yellow-300">"Hello! I am safe."</span>);<br>
                                        }
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs font-bold text-red-600 uppercase"><i class="fa-solid fa-skull mr-1"></i> Chương trình B (Độc hại)</span>
                                        <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">evil.c</span>
                                    </div>
                                    <div class="code-window border-red-500 border-opacity-50">
                                        <span class="text-pink-400">void</span> main() {<br>
                                        &nbsp;&nbsp;<span class="text-purple-400">system</span>(<span class="text-yellow-300">"DELETE ALL DATA!"</span>);<br>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Binary Generation -->
                        <div id="col-step-2" class="step-card bg-white p-6 rounded-xl border border-slate-200 shadow-sm hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">2</div>
                                <h3 class="font-bold text-slate-800">Bước 2: Biên dịch & Tạo va chạm (Collision Generation)</h3>
                            </div>
                            <p class="text-sm text-slate-600 mb-4">Sử dụng công cụ tạo va chạm (ví dụ: <code>fastcoll</code>) để tạo ra 2 khối dữ liệu nhị phân đặc biệt (Block 1 & Block 2). Chúng trông rất giống nhau nhưng có vài byte khác biệt (màu đỏ).</p>
                            
                            <i class="fa-solid fa-arrow-down arrow-down"></i>

                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <div class="text-xs font-bold text-slate-500 mb-1">Binary Block 1 (Generated)</div>
                                    <div class="bg-slate-50 p-3 rounded border border-slate-200 h-24 overflow-y-auto break-all mono text-xs text-slate-600" id="col-block1-view"></div>
                                </div>
                                <div>
                                    <div class="text-xs font-bold text-slate-500 mb-1">Binary Block 2 (Generated)</div>
                                    <div class="bg-slate-50 p-3 rounded border border-slate-200 h-24 overflow-y-auto break-all mono text-xs text-slate-600" id="col-block2-view"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Hashing -->
                        <div id="col-step-3" class="step-card bg-white p-6 rounded-xl border border-slate-200 shadow-sm hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">3</div>
                                <h3 class="font-bold text-slate-800">Bước 3: Kiểm tra Chữ ký số (Hashing)</h3>
                            </div>
                            <div class="grid grid-cols-2 gap-6 items-center">
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200 text-center relative">
                                    <div class="text-xs text-green-700 font-bold mb-1">MD5 (Block 1)</div>
                                    <div class="mono font-bold text-slate-800 break-all text-sm" id="col-md5-1">Calculated...</div>
                                    <div class="absolute -top-3 -right-3 bg-green-600 text-white text-xs px-2 py-1 rounded shadow">Hợp lệ</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-red-500 mb-1">=</div>
                                    <div class="text-xs text-red-500 font-bold uppercase tracking-wider">COLLISION!</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200 text-center relative">
                                    <div class="text-xs text-green-700 font-bold mb-1">MD5 (Block 2)</div>
                                    <div class="mono font-bold text-slate-800 break-all text-sm" id="col-md5-2">Calculated...</div>
                                    <div class="absolute -top-3 -right-3 bg-green-600 text-white text-xs px-2 py-1 rounded shadow">Hợp lệ</div>
                                </div>
                            </div>
                            <p class="text-center text-sm text-slate-500 mt-4 italic">Hệ thống bảo mật (Antivirus) thấy 2 file này có cùng chữ ký -> Coi là an toàn như nhau!</p>
                        </div>

                        <!-- Step 4: Execution -->
                        <div id="col-step-4" class="step-card bg-white p-6 rounded-xl border border-slate-200 shadow-sm hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">4</div>
                                <h3 class="font-bold text-slate-800">Bước 4: Thực thi & Hậu quả</h3>
                            </div>
                            <p class="text-sm text-slate-600 mb-4">Khi chạy, máy tính sẽ đọc nội dung file. Do nội dung khác nhau (tại các byte màu đỏ), chương trình sẽ rẽ nhánh thực thi khác nhau.</p>
                            
                            <div class="grid grid-cols-2 gap-6">
                                <!-- Scenario A -->
                                <div class="border border-green-200 rounded-lg overflow-hidden">
                                    <div class="bg-green-50 px-3 py-2 border-b border-green-200 text-xs font-bold text-green-800 flex justify-between">
                                        <span>TERMINAL 1 (Running File A)</span>
                                        <i class="fa-solid fa-play"></i>
                                    </div>
                                    <div class="p-4 bg-slate-900 text-green-400 font-mono text-sm h-32">
                                        $ ./program_a<br>
                                        [System] Checking MD5... OK.<br>
                                        > Hello! I am safe.<br>
                                        <span class="animate-pulse">_</span>
                                    </div>
                                </div>
                                <!-- Scenario B -->
                                <div class="border border-red-200 rounded-lg overflow-hidden relative">
                                    <div class="absolute inset-0 bg-red-500 opacity-10 pointer-events-none animate-pulse"></div>
                                    <div class="bg-red-50 px-3 py-2 border-b border-red-200 text-xs font-bold text-red-800 flex justify-between">
                                        <span>TERMINAL 2 (Running File B)</span>
                                        <i class="fa-solid fa-play"></i>
                                    </div>
                                    <div class="p-4 bg-slate-900 text-red-400 font-mono text-sm h-32">
                                        $ ./program_b<br>
                                        [System] Checking MD5... OK.<br>
                                        > DELETING ALL DATA...<br>
                                        > [ERROR] CRITICAL DATA LOST!<br>
                                        <span class="animate-pulse">_</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 bg-yellow-50 border border-yellow-200 p-4 rounded-lg text-center">
                                <p class="text-yellow-800 font-bold text-sm">
                                    <i class="fa-solid fa-triangle-exclamation mr-1"></i> KẾT LUẬN:
                                </p>
                                <p class="text-slate-700 text-sm mt-1">MD5 không thể phân biệt "Tốt" và "Xấu". Kẻ tấn công có thể tráo đổi file độc hại vào hệ thống mà không làm thay đổi chữ ký MD5.</p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </section>

        <!-- TAB 4: LENGTH EXTENSION (Keep same) -->
        <section id="tab-length_ext" class="max-w-6xl mx-auto hidden p-6">
            <!-- (Giữ nguyên nội dung Tab 4 cũ) -->
            <div class="bg-slate-900 rounded-xl shadow-2xl overflow-hidden border border-slate-700 flex flex-col h-[500px]">
                <div class="bg-slate-800 px-4 py-2 flex items-center gap-2 border-b border-slate-700">
                    <div class="flex gap-1.5"><div class="w-3 h-3 rounded-full bg-red-500"></div><div class="w-3 h-3 rounded-full bg-yellow-500"></div><div class="w-3 h-3 rounded-full bg-green-500"></div></div>
                    <div class="text-xs text-slate-400 font-mono ml-2">hacker@kali:~/md5-exploit</div>
                </div>
                <div class="flex-1 p-6 font-mono text-sm overflow-y-auto relative" id="terminal-content">
                    <div class="text-slate-500 mb-4"># Demo Tấn công Mở rộng Chiều dài (Length Extension Attack)<br># Nhấn 'NEXT STEP' để thực hiện từng bước tấn công.</div>
                    <div id="term-lines"></div>
                    <div class="mt-4 flex items-center gap-2"><span class="text-green-500">➜</span><span class="text-blue-400">~</span><span class="cursor"></span></div>
                </div>
                <div class="bg-slate-800 p-4 border-t border-slate-700 flex justify-end gap-3">
                    <button onclick="resetExploit()" class="px-4 py-2 bg-slate-700 text-slate-300 rounded hover:bg-slate-600 text-xs font-bold uppercase">Reset</button>
                    <button onclick="nextExploitStep()" id="btn-next-exploit" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-bold flex items-center gap-2">Next Step <i class="fa-solid fa-chevron-right"></i></button>
                </div>
            </div>
        </section>

    </main>

    <!-- JS Logic -->
    <script>
        // --- TABS ---
        function switchTab(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('btn-' + id);
            if(btn) btn.classList.add('active');
            if(id === 'theory') document.querySelector('main').scrollTop = 0;
        }

        // --- ALGORITHM SIMULATION ---
        const K = []; for(let i=0; i<64; i++) K[i] = Math.floor(Math.abs(Math.sin(i + 1)) * 4294967296);
        const S = [7, 12, 17, 22, 7, 12, 17, 22, 7, 12, 17, 22, 7, 12, 17, 22, 5, 9, 14, 20, 5, 9, 14, 20, 5, 9, 14, 20, 5, 9, 14, 20, 4, 11, 16, 23, 4, 11, 16, 23, 4, 11, 16, 23, 4, 11, 16, 23, 6, 10, 15, 21, 6, 10, 15, 21, 6, 10, 15, 21, 6, 10, 15, 21];
        let algoState = { a:0, b:0, c:0, d:0, step:0, M:[], timer: null };

        function initAlgoDemo() {
            const input = document.getElementById('algo-input').value;
            let M = new Array(16).fill(0);
            for(let i=0; i<input.length && i<64; i++) M[i >> 2] |= input.charCodeAt(i) << ((i % 4) * 8);
            algoState = { a: 0x67452301, b: 0xEFCDAB89, c: 0x98BADCFE, d: 0x10325476, step: 0, M: M, timer: null };
            updateAlgoUI(true);
            const dotsContainer = document.getElementById('step-dots');
            dotsContainer.innerHTML = '';
            for(let i=0; i<64; i++) { let dot = document.createElement('div'); dot.className = 'step-dot'; dot.id = 'dot-'+i; dotsContainer.appendChild(dot); }
        }

        function algoStep(count) {
            if(algoState.step >= 64) return;
            for(let k=0; k<count; k++) {
                if(algoState.step >= 64) break;
                let {a, b, c, d, step, M} = algoState;
                let f, g;
                if (step < 16) { f = (b & c) | ((~b) & d); g = step; } 
                else if (step < 32) { f = (d & b) | ((~d) & c); g = (5 * step + 1) % 16; } 
                else if (step < 48) { f = b ^ c ^ d; g = (3 * step + 5) % 16; } 
                else { f = c ^ (b | (~d)); g = (7 * step) % 16; }
                let temp = (a + f + K[step] + M[g]) >>> 0;
                let s = S[step];
                temp = ((temp << s) | (temp >>> (32 - s))) >>> 0;
                temp = (temp + b) >>> 0;
                algoState.a = d; algoState.d = c; algoState.c = b; algoState.b = temp;
                algoState.step++;
            }
            updateAlgoUI(false);
        }

        function updateAlgoUI(reset) {
            const {a, b, c, d, step} = algoState;
            const hex = n => (n >>> 0).toString(16).padStart(8, '0').toUpperCase();
            document.querySelector('#reg-a .val').innerText = hex(a);
            document.querySelector('#reg-b .val').innerText = hex(b);
            document.querySelector('#reg-c .val').innerText = hex(c);
            document.querySelector('#reg-d .val').innerText = hex(d);
            document.querySelectorAll('.reg-box').forEach(el => { el.classList.remove('reg-changed', 'border-blue-500', 'border-slate-200', 'shadow-md'); el.classList.add('border-slate-200'); });
            if(!reset) { const bBox = document.getElementById('reg-b'); bBox.classList.add('reg-changed', 'border-blue-500', 'shadow-md'); bBox.classList.remove('border-slate-200'); }
            const funcName = step < 16 ? 'F' : step < 32 ? 'G' : step < 48 ? 'H' : 'I';
            const logHTML = `<div class="flex justify-between mb-1"><span>Op:</span> <span class="font-bold text-white">${funcName}</span></div><div class="flex justify-between"><span>K:</span> <span class="text-yellow-300">0x${(K[step-1]||0).toString(16).toUpperCase()}</span></div>`;
            if (step > 0 && step <= 64) document.getElementById('algo-log').innerHTML = logHTML;
            document.getElementById('step-counter').innerText = `Step ${step} / 64`;
            document.getElementById('current-step-display').innerText = step;
            document.getElementById('progress-bar').style.width = (step / 64 * 100) + '%';
            for(let i=0; i<64; i++) { const dot = document.getElementById('dot-'+i); dot.className = 'step-dot ' + (i < step ? 'passed' : '') + (i === step-1 ? ' active' : ''); }
        }

        function algoAutoPlay() {
            if(algoState.timer) { clearInterval(algoState.timer); algoState.timer = null; document.getElementById('btn-autoplay').innerHTML = '<i class="fa-solid fa-forward"></i> Tự chạy'; return; }
            document.getElementById('btn-autoplay').innerHTML = '<i class="fa-solid fa-pause"></i> Dừng lại';
            algoState.timer = setInterval(() => { if(algoState.step >= 64) algoAutoPlay(); algoStep(1); }, 200);
        }
        function algoReset() { if(algoState.timer) algoAutoPlay(); initAlgoDemo(); }

        // --- AVALANCHE ---
        function updateAvalanche() {
            const i1 = document.getElementById('input1').value; const i2 = document.getElementById('input2').value;
            const h1 = SparkMD5.hash(i1); const h2 = SparkMD5.hash(i2);
            document.getElementById('hash1').innerText = h1; document.getElementById('hash2').innerText = h2;
            const hex2bin = h => parseInt(h, 16).toString(2).padStart(4, '0');
            let b1 = "", b2 = ""; for(let i=0;i<32;i++) { b1+=hex2bin(h1[i]); b2+=hex2bin(h2[i]); }
            let html = "", diff=0;
            for(let i=0; i<128; i++) { if(b1[i] !== b2[i]) { diff++; html+=`<span class="text-red-500 font-bold bg-red-100 rounded px-px">${b2[i]}</span>`; } else { html+=`<span class="text-slate-300">${b2[i]}</span>`; } if((i+1)%32===0) html+="<br>"; }
            document.getElementById('binary-viz').innerHTML = html;
            let p = Math.round(diff/128*100);
            document.getElementById('diff-percent').innerText = p+"%";
            document.getElementById('diff-bar').style.width = p+"%";
        }

        // --- COLLISION (NEW SCENARIO LOGIC) ---
        const b1hex = "d131dd02c5e6eec4693d9a0698aff95c2fcab58712467eab4004583eb8fb7f8955ad340609f4b30283e488832571415a085125e8f7cdc99fd91dbdf280373c5bd8823e3156348f5bae6dacd436c919c6dd53e2b487da03fd02396306d248cda0e99f33420f577ee8ce54b67080a80d1ec69821bcb6a8839396f9652b6ff72a70";
        const b2hex = "d131dd02c5e6eec4693d9a0698aff95c2fcab50712467eab4004583eb8fb7f8955ad340609f4b30283e488832571415a085125e8f7cdc99fd91dbdf280373c5bd8823e3156348f5bae6dacd436c919c6dd53e2b487da03fd02396306d248cda0e99f33420f577ee8ce54b67080a80d1ec69821bcb6a8839396f9652b6ff72a70";
        let colStep = 0;

        async function nextCollisionStep() {
            colStep++;
            // Step 1: Just show UI (Init state is handled by reset)
            
            // Step 2: Binary Generation
            if(colStep === 1) { 
                document.getElementById('col-step-2').classList.remove('hidden');
                
                // Render Hex with highlights
                let h1 = "", h2 = "";
                for(let i=0; i<b1hex.length; i+=2) { 
                    let byte1 = b1hex.substr(i,2); 
                    let byte2 = b2hex.substr(i,2); 
                    if(byte1 !== byte2) { 
                        h1 += `<span class="diff-byte">${byte1}</span>`; 
                        h2 += `<span class="diff-byte">${byte2}</span>`; 
                    } else { 
                        h1 += byte1; h2 += byte2; 
                    } 
                } 
                document.getElementById('col-block1-view').innerHTML = h1; 
                document.getElementById('col-block2-view').innerHTML = h2;
                
                document.querySelector('.max-w-5xl').parentElement.scrollTop = 500; // Auto scroll
            }

            // Step 3: Hashing
            if(colStep === 2) { 
                document.getElementById('col-step-3').classList.remove('hidden');
                
                // Calculate MD5
                const hexToStr = hex => { let s = ''; for(let i=0; i<hex.length; i+=2) s += String.fromCharCode(parseInt(hex.substr(i,2),16)); return s; }; 
                const md5_1 = SparkMD5.hashBinary(hexToStr(b1hex)); 
                const md5_2 = SparkMD5.hashBinary(hexToStr(b2hex)); 
                
                document.getElementById('col-md5-1').innerText = md5_1; 
                document.getElementById('col-md5-2').innerText = md5_2; 
                document.querySelector('.max-w-5xl').parentElement.scrollTop = 900;
            }

            // Step 4: Execution
            if(colStep === 3) {
                document.getElementById('col-step-4').classList.remove('hidden');
                document.getElementById('btn-col-next').innerText = "Hoàn thành";
                document.getElementById('btn-col-next').classList.add('opacity-50', 'cursor-not-allowed');
                document.querySelector('.max-w-5xl').parentElement.scrollTop = 1200;
            }
        }

        function resetCollisionStep() { 
            colStep = 0; 
            document.getElementById('col-step-2').classList.add('hidden');
            document.getElementById('col-step-3').classList.add('hidden');
            document.getElementById('col-step-4').classList.add('hidden');
            document.getElementById('col-block1-view').innerHTML = '...'; 
            document.getElementById('col-block2-view').innerHTML = '...'; 
            document.getElementById('col-md5-1').innerText = '...'; 
            document.getElementById('col-md5-2').innerText = '...';
            document.getElementById('btn-col-next').innerHTML = 'Bước tiếp theo <i class="fa-solid fa-arrow-right"></i>'; 
            document.getElementById('btn-col-next').classList.remove('opacity-50', 'cursor-not-allowed');
            document.querySelector('.max-w-5xl').parentElement.scrollTop = 0;
        }

        // --- TERMINAL ---
        const exploitSteps = [ { text: "$ ./attack_script.py --target api.example.com", type: "cmd" }, { text: "[*] Analyzing original signature...", type: "info" }, { text: "    Original Hash: 85030b39bfd237bf61bc217c1cf0f2ff", type: "data" }, { text: "[*] Extracting internal state (A, B, C, D)...", type: "info" }, { text: "    A=0x61bc217c, B=0x1cf0f2ff...", type: "data" }, { text: "[!] Initializing new MD5 state from extracted values...", type: "warn" }, { text: "[*] Appending malicious payload: '&role=admin'", type: "info" }, { text: "[+] Calculating new signature...", type: "success" }, { text: "    New Hash: 3e700f993eb99acdf5a193462c37de84", type: "result" }, { text: "[*] Sending forged cookie to server...", type: "info" }, { text: "HTTP/1.1 200 OK", type: "server" }, { text: "Welcome, ADMIN! You have full access.", type: "server-success" } ];
        let currentExploitStep = 0;
        function nextExploitStep() { if (currentExploitStep >= exploitSteps.length) return; const step = exploitSteps[currentExploitStep]; const term = document.getElementById('term-lines'); let color = "text-slate-300"; if(step.type === "cmd") color = "text-green-400 font-bold"; if(step.type === "warn") color = "text-yellow-400"; if(step.type === "success") color = "text-green-400"; if(step.type === "result") color = "text-red-400 font-bold"; if(step.type === "server") color = "text-blue-300"; if(step.type === "server-success") color = "text-green-300 bg-green-900/30 p-1 inline-block rounded"; const div = document.createElement('div'); div.className = `mb-1 ${color} font-mono text-sm`; div.innerHTML = step.type === "cmd" ? `<span class="text-blue-400">~</span> ${step.text}` : step.text; term.appendChild(div); document.getElementById('terminal-content').scrollTop = 9999; currentExploitStep++; if(currentExploitStep >= exploitSteps.length) { document.getElementById('btn-next-exploit').innerText = "Hoàn thành"; document.getElementById('btn-next-exploit').classList.add('opacity-50', 'cursor-not-allowed'); } }
        function resetExploit() { document.getElementById('term-lines').innerHTML = ''; currentExploitStep = 0; document.getElementById('btn-next-exploit').innerHTML = 'Next Step <i class="fa-solid fa-chevron-right"></i>'; document.getElementById('btn-next-exploit').classList.remove('opacity-50', 'cursor-not-allowed'); }

        // INIT
        initAlgoDemo();
        updateAvalanche();
        // Start collision demo at step 0 (user clicks Next to start)
    </script>
</body>
</html>