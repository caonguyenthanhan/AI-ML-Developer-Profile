<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GOV-ARX Demo | Agentic RAG System</title>
  
  <!-- 1. Tích hợp Tailwind CSS qua CDN (Quan trọng để chạy trên Vercel mà không cần Build) -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. Cấu hình Tailwind để nhận diện Font và màu sắc -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['monospace'],
          },
          colors: {
            slate: {
              950: '#020617', // Màu nền tối chuẩn
            }
          }
        }
      }
    }
  </script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Icons: Lucide -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <!-- Custom Animations -->
  <style>
    body { font-family: 'Inter', sans-serif; }
    
    @keyframes progress { 
      0% { transform: scaleX(0); } 
      100% { transform: scaleX(1); } 
    }
    .animate-progress { 
      animation: progress 0.5s ease-out forwards; 
    }
    
    /* Scrollbar tùy chỉnh cho đẹp */
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
    
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(5px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    .animate-fadeIn { 
      animation: fadeIn 0.3s ease-in-out; 
    }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-200 selection:bg-cyan-900 selection:text-white flex flex-col">

  <!-- HEADER -->
  <header class="border-b border-slate-800 bg-slate-900/50 backdrop-blur-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="bg-gradient-to-br from-cyan-500 to-blue-600 p-2 rounded-lg shadow-lg shadow-cyan-500/20">
          <i data-lucide="cpu" class="w-6 h-6 text-white"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent">GOV-ARX</h1>
          <p class="text-xs text-slate-400 uppercase tracking-wider">Agentic RAG System</p>
        </div>
      </div>
      <div class="hidden md:flex items-center gap-4 text-xs font-mono text-slate-500">
        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div> Local Memory</span>
        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div> Gemma 4B Ready</span>
      </div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="flex-1 max-w-7xl mx-auto w-full px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
    
    <!-- LEFT COLUMN: Pipeline & Logs -->
    <div class="lg:col-span-7 space-y-6">
      
      <!-- Pipeline Visualization -->
      <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 shadow-xl overflow-hidden relative">
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500/0 via-cyan-500/50 to-cyan-500/0 opacity-20"></div>
        <h2 class="text-sm font-semibold text-slate-400 mb-8 flex items-center gap-2">
          <i data-lucide="activity" class="w-4 h-4 text-cyan-400"></i>
          REAL-TIME PIPELINE
        </h2>
        
        <!-- Steps Container -->
        <div id="pipelineSteps" class="flex justify-between items-start relative px-2 overflow-x-auto pb-2 md:overflow-visible md:pb-0">
          <!-- Steps will be injected here by JS -->
        </div>
        
        <!-- Step Description -->
        <div id="stepDesc" class="mt-8 bg-slate-950/50 rounded-lg p-4 border border-slate-800/50 min-h-[80px] flex items-center justify-center text-center transition-all">
          <p class="text-slate-600 text-sm">Hệ thống đang chờ lệnh...</p>
        </div>
      </div>

      <!-- System Console Logs -->
      <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4 shadow-inner flex flex-col h-96 font-mono text-sm relative overflow-hidden">
        <div class="flex items-center justify-between mb-2 border-b border-slate-800 pb-2">
          <div class="flex items-center gap-2 text-slate-400">
            <i data-lucide="terminal" class="w-3.5 h-3.5"></i>
            <span class="text-xs font-bold">SYSTEM KERNEL LOGS</span>
          </div>
          <div class="flex gap-1">
            <div class="w-2 h-2 rounded-full bg-red-500/20"></div>
            <div class="w-2 h-2 rounded-full bg-yellow-500/20"></div>
            <div class="w-2 h-2 rounded-full bg-green-500/20"></div>
          </div>
        </div>
        
        <div id="logs" class="flex-1 overflow-y-auto space-y-1 pr-2 custom-scrollbar">
          <div class="text-slate-700 italic p-4 text-center mt-20">
            Sẵn sàng khởi chạy vLLM...<br/>
            Waiting for input triggers...
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN: Chat & Scenarios -->
    <div class="lg:col-span-5 flex flex-col gap-6 h-full">
      
      <!-- Chat Box -->
      <div class="bg-slate-900 border border-slate-800 rounded-2xl shadow-xl flex flex-col h-[500px]">
        <div class="p-4 border-b border-slate-800 flex justify-between items-center">
          <h3 class="font-bold text-slate-300">Live Demo Interface</h3>
          <span id="statusBadge" class="text-xs px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">IDLE</span>
        </div>
        
        <div id="chat" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-950/30 custom-scrollbar">
          <!-- Messages injected here -->
        </div>
        
        <div class="p-4 bg-slate-900 border-t border-slate-800">
          <div class="flex gap-2">
            <input id="userInput" type="text" placeholder="Nhập câu hỏi hành chính..." class="flex-1 bg-slate-950 border border-slate-700 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 transition-all text-white placeholder-slate-600" />
            <button id="sendBtn" class="bg-cyan-600 hover:bg-cyan-500 text-white p-2 rounded-lg transition-colors shadow-lg shadow-cyan-900/20">
              <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Scenario Buttons -->
      <div id="scenarios" class="grid grid-cols-2 gap-3">
        <!-- Scenarios injected here -->
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="max-w-7xl mx-auto px-4 py-6 text-center text-slate-600 text-xs border-t border-slate-900 mt-8 w-full">
    <p>GOV-ARX Architecture • Gemma 3 Models (270M, 1B, 4B) • Free Local Memory (ChromaDB)</p>
    <p class="mt-1">Tối ưu hóa cho GPU A100 (VRAM ~37GB → 12GB Optimized)</p>
  </footer>

  <!-- JAVASCRIPT LOGIC -->
  <script>
    // --- Data ---
    var STEPS = [
      { id: 'input', label: 'User Input', icon: 'message-square', description: 'Người dùng gửi yêu cầu' },
      { id: 'intent', label: 'Intent Detector', icon: 'search', subLabel: 'Gemma 270M', description: 'Phân loại ý định người dùng' },
      { id: 'normalize', label: 'Input Styler', icon: 'file-text', subLabel: 'Gemma 1B IT', description: 'Chuẩn hóa câu hỏi đầu vào' },
      { id: 'agent', label: 'Main Agent', icon: 'brain', subLabel: 'Gemma 4B (ReAct)', description: 'Lập kế hoạch & Gọi Tools' },
      { id: 'tools', label: 'Tool Layer', icon: 'database', subLabel: 'RAG / API / WOM', description: 'Truy xuất dữ liệu thực tế' },
      { id: 'output', label: 'Output Styler', icon: 'layers', subLabel: 'Gemma 1B IT', description: 'Định dạng văn phong hành chính' },
      { id: 'final', label: 'Final Answer', icon: 'check-circle-2', description: 'Trả về kết quả cho người dùng' }
    ];

    var SCENARIOS = [
      { type: 'Lookup', label: 'Tra cứu số liệu', icon: 'search', query: 'Cho tôi biết dân số và diện tích của Hà Nội năm 2023?', color: 'text-blue-400', mockProcess: { intent: 'Lookup', reasoning: 'Truy vấn số liệu đơn giản, không cần chuẩn hóa.', tool: 'RAG (Stats DB)', result: 'Dân số Hà Nội 2023 khoảng 8,5 triệu, diện tích ~3.359 km².' } },
      { type: 'Analysis', label: 'Phân tích', icon: 'bar-chart-3', query: 'Tại sao chỉ số CPI tháng này lại tăng đột biến?', color: 'text-emerald-400', mockProcess: { intent: 'Analysis', reasoning: 'Cần chuẩn hóa câu hỏi và chọn nguồn dữ liệu.', tool: 'RAG + API (WB/IMF)', result: 'Do giá xăng dầu tăng 5% và nhu cầu tiêu dùng dịp lễ tăng cao.' } },
      { type: 'Compare', label: 'So sánh', icon: 'file-output', query: 'So sánh tỷ lệ thất nghiệp giữa Hà Nội và TP.HCM năm 2023.', color: 'text-cyan-400', mockProcess: { intent: 'Compare', reasoning: 'Chuẩn hóa đối tượng so sánh và thời gian.', tool: 'API + RAG', result: 'Thất nghiệp: Hà Nội ~2.6%, TP.HCM ~3.1% (tham khảo Tổng cục Thống kê).' } },
      { type: 'Report', label: 'Báo cáo', icon: 'file-text', query: 'Viết báo cáo 200 từ về tình hình giao thông Hà Nội.', color: 'text-pink-400', mockProcess: { intent: 'Report', reasoning: 'Cần cấu trúc báo cáo và văn phong hành chính.', tool: 'Template + RAG', result: 'Báo cáo: Tình hình giao thông đô thị có cải thiện ở các trục chính...' } },
      { type: 'Support', label: 'Hỗ trợ', icon: 'help-circle', query: 'Làm thế nào để đăng ký khai sinh online?', color: 'text-yellow-400', mockProcess: { intent: 'Support', reasoning: 'Câu hỏi về quy trình thủ tục.', tool: 'RAG (Legal Docs)', result: 'Bước 1: Truy cập Dịch vụ công. Bước 2: Chọn Lĩnh vực Hộ tịch...' } },
      { type: 'Other', label: 'Khác', icon: 'message-square', query: 'Hôm nay trời đẹp không?', color: 'text-gray-400', mockProcess: { intent: 'Other', reasoning: 'Không thuộc dữ liệu hành chính công.', tool: 'None', result: 'Xin lỗi, tôi chỉ là trợ lý hành chính công GOV-ARX.' } }
    ];

    // --- State ---
    var activeStep = -1;
    var isProcessing = false;
    var messages = [{ role: 'system', content: 'Chào mừng đến với GOV-ARX. Vui lòng chọn một kịch bản hoặc nhập câu hỏi để bắt đầu phân tích.' }];
    var logs = [];

    // --- Helpers ---
    function qs(sel){ return document.querySelector(sel); }
    function el(tag, cls){ var e=document.createElement(tag); if(cls) e.className=cls; return e; }
    function time(){ return new Date().toLocaleTimeString('vi-VN', { hour12: false, hour: '2-digit', minute:'2-digit', second:'2-digit' }); }
    function delay(ms){ return new Promise(function(res){ setTimeout(res, ms); }); }

    // --- Render Functions ---
    function renderPipeline(){
      var wrap = qs('#pipelineSteps');
      wrap.innerHTML = '';
      STEPS.forEach(function(step, idx){
        // Node Container
        var node = el('div', 'relative flex flex-col items-center transition-all duration-500 shrink-0 mx-2 md:mx-0 '+(activeStep===idx?'scale-110 opacity-100':(activeStep>idx?'opacity-100':'opacity-40')));
        node.style.width = '14%'; // Chia đều chiều rộng

        // Line Connector
        if(idx < STEPS.length-1){
          var lineWrap = el('div', 'absolute top-6 left-1/2 w-full h-1 -z-10 hidden md:block');
          var line = el('div', 'w-full h-full '+(activeStep>idx?'bg-emerald-500':'bg-slate-700'));
          lineWrap.appendChild(line);
          if(activeStep===idx){ 
            var prog = el('div', 'h-full bg-cyan-400 animate-progress origin-left'); 
            // line.appendChild(prog); // Fix: Absolute position for progress bar inside line
            var progWrap = el('div', 'absolute top-0 left-0 w-full h-full bg-cyan-400 animate-progress origin-left');
            lineWrap.appendChild(progWrap);
          }
          node.appendChild(lineWrap);
        }

        // Icon Circle
        var iconWrap = el('div', 'w-12 h-12 rounded-full flex items-center justify-center border-2 z-10 bg-slate-900 transition-colors duration-300 '+(activeStep===idx?'border-cyan-400 shadow-[0_0_15px_rgba(34,211,238,0.5)]':(activeStep>idx?'border-emerald-500 text-emerald-500':'border-slate-600 text-slate-500')));
        var i = el('i', 'w-5 h-5 '+(activeStep===idx?'text-cyan-400':'')); 
        i.setAttribute('data-lucide', step.icon); 
        iconWrap.appendChild(i);
        node.appendChild(iconWrap);

        // Text
        var textWrap = el('div', 'mt-2 text-center w-24 md:w-32');
        var title = el('div', 'text-[10px] md:text-xs font-bold truncate '+(activeStep===idx?'text-cyan-400':(activeStep>idx?'text-emerald-400':'text-slate-400'))); 
        title.textContent = step.label; 
        textWrap.appendChild(title);
        
        if(step.subLabel){ 
          var sub = el('div', 'hidden md:block text-[10px] text-slate-500 font-mono mt-0.5'); 
          sub.textContent = step.subLabel; 
          textWrap.appendChild(sub); 
        }
        node.appendChild(textWrap);
        
        wrap.appendChild(node);
      });
      lucide.createIcons();

      // Description Box
      var desc = qs('#stepDesc');
      if(activeStep!==-1){ 
        desc.innerHTML = '<div class="animate-fadeIn"><p class="text-cyan-400 font-bold text-sm mb-1">'+STEPS[activeStep].label+' Processing...</p><p class="text-slate-400 text-sm">'+STEPS[activeStep].description+'</p></div>'; 
      } else { 
        desc.innerHTML = '<p class="text-slate-600 text-sm">Hệ thống đang chờ lệnh...</p>'; 
      }
    }

    function renderLogs(){
      var wrap = qs('#logs');
      wrap.innerHTML = '';
      if(logs.length === 0) {
        wrap.innerHTML = '<div class="text-slate-700 italic p-4 text-center mt-20">Sẵn sàng khởi chạy vLLM...<br/>Waiting for input triggers...</div>';
        return;
      }
      logs.forEach(function(log){
        var row = el('div', 'mb-1 font-mono text-xs border-l-2 border-slate-700 pl-2 py-1 animate-fadeIn');
        var t = el('span', 'text-slate-500'); t.textContent = '['+log.time+'] '; row.appendChild(t);
        var s = el('span', log.color||'text-slate-300'); s.textContent = log.source+': '; row.appendChild(s);
        var m = el('span', 'text-slate-400'); m.textContent = log.message; row.appendChild(m);
        wrap.appendChild(row);
      });
      wrap.scrollTop = wrap.scrollHeight;
    }

    function renderChat(){
      var wrap = qs('#chat');
      wrap.innerHTML = '';
      messages.forEach(function(msg){
        var row = el('div', 'flex '+(msg.role==='user'?'justify-end':'justify-start') + ' animate-fadeIn');
        var bubble = el('div', 'max-w-[85%] p-3 rounded-xl text-sm shadow-md '+(msg.role==='user'?'bg-cyan-600/20 border border-cyan-600/50 text-cyan-100 rounded-br-none':'bg-slate-800 border border-slate-700 text-slate-200 rounded-bl-none'));
        
        if(msg.role==='system' || msg.role==='assistant'){ 
            if(msg.role === 'system' && messages.indexOf(msg) === 0) {
                 // Intro message style
                 var head = el('div', 'flex items-center gap-2 mb-1 text-cyan-400 font-bold text-xs'); 
                 var ic = el('i', 'w-3 h-3'); ic.setAttribute('data-lucide','cpu'); 
                 head.appendChild(ic); 
                 head.appendChild(document.createTextNode(' GOV-ARX')); 
                 bubble.appendChild(head);
            }
        }
        
        bubble.appendChild(document.createTextNode(msg.content));
        row.appendChild(bubble);
        wrap.appendChild(row);
      });
      lucide.createIcons();
      wrap.scrollTop = wrap.scrollHeight;
    }

    function renderScenarios(){
      var wrap = qs('#scenarios'); wrap.innerHTML='';
      SCENARIOS.forEach(function(item){
        var btn = el('button', 'p-3 rounded-xl border border-slate-800 bg-slate-900/50 hover:bg-slate-800 transition-all text-left group relative overflow-hidden shadow-sm hover:shadow-cyan-500/10');
        // Disabled state if processing
        if(isProcessing) { btn.style.opacity = '0.5'; btn.style.cursor = 'not-allowed'; }
        
        var overlay = el('div', 'absolute inset-0 opacity-0 group-hover:opacity-10 transition-opacity bg-current '+item.color); btn.appendChild(overlay);
        
        var head = el('div', 'flex items-start justify-between mb-2');
        var ic = el('i', 'w-4 h-4 '+item.color); ic.setAttribute('data-lucide', item.icon); head.appendChild(ic);
        var play = el('i', 'w-3 h-3 text-slate-600 group-hover:text-slate-300'); play.setAttribute('data-lucide','play'); head.appendChild(play);
        btn.appendChild(head);
        
        var t = el('div', 'text-xs font-bold text-slate-300 mb-1'); t.textContent=item.type; btn.appendChild(t);
        var q = el('div', 'text-[10px] text-slate-500 leading-relaxed line-clamp-2'); q.textContent=item.query; btn.appendChild(q);
        
        btn.onclick = function(){ if(!isProcessing) runSimulation(item); };
        wrap.appendChild(btn);
      });
      lucide.createIcons();
    }

    // --- Logic ---
    function addLog(source, message, color){ 
        logs.push({ time: time(), source: source, message: message, color: color }); 
        renderLogs(); 
    }

    async function runSimulation(scenario){
      if(isProcessing) return;
      isProcessing = true; 
      
      // Update UI Status
      qs('#statusBadge').className='text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-500/30'; 
      qs('#statusBadge').textContent='PROCESSING';
      qs('#userInput').disabled = true;
      qs('#sendBtn').disabled = true;
      qs('#sendBtn').classList.add('opacity-50');
      renderScenarios(); // Re-render to disable buttons

      activeStep = 0; 
      logs = []; 
      renderPipeline(); 
      renderLogs();

      // 1. User Input
      messages.push({ role:'user', content: scenario.query }); renderChat();
      addLog('SYSTEM', 'Nhận yêu cầu đầu vào từ người dùng.', 'text-white');
      await delay(800);

      // 2. Intent
      activeStep = 1; renderPipeline();
      addLog('INTENT_DETECTOR', 'Đang phân tích ý định (Gemma 3 270M)...', 'text-purple-400');
      await delay(1200);
      addLog('INTENT_DETECTOR', 'Phát hiện Intent: ['+scenario.mockProcess.intent+']', 'text-purple-300 font-bold');
      
      // Handle "Other" intent
      if(scenario.type==='Other'){
        addLog('ROUTER', 'Intent không hợp lệ. Bỏ qua pipeline xử lý.', 'text-red-400');
        activeStep = 6; renderPipeline(); await delay(500);
        messages.push({ role:'assistant', content: scenario.mockProcess.result }); renderChat();
        resetState();
        return;
      }

      // 3. Input Styler
      activeStep = 2; renderPipeline();
      if(['Analysis','Compare','Report','Support'].includes(scenario.type)){
        addLog('INPUT_STYLER', 'Kích hoạt Gemma 1B IT để chuẩn hóa câu hỏi...', 'text-blue-400'); await delay(1000);
        addLog('INPUT_STYLER', 'Input đã được làm sạch và tái cấu trúc.', 'text-blue-300');
      } else { 
        addLog('INPUT_STYLER', 'Bỏ qua bước chuẩn hóa (Không cần thiết cho Lookup).', 'text-slate-500'); await delay(500); 
      }

      // 4. Main Agent
      activeStep = 3; renderPipeline();
      addLog('MAIN_AGENT', 'Gemma 4B khởi tạo ReAct & Chain-of-Thought...', 'text-yellow-400'); await delay(1000);
      addLog('MAIN_AGENT', 'Suy luận: '+scenario.mockProcess.reasoning, 'text-yellow-200 italic'); await delay(800);

      // 5. Tools
      activeStep = 4; renderPipeline();
      addLog('TOOL_LAYER', 'Routing đến công cụ: '+scenario.mockProcess.tool, 'text-emerald-400'); await delay(1500);
      addLog('RAG_ENGINE', 'Truy xuất 5 chunks từ ChromaDB (Local Memory)...', 'text-emerald-300');
      addLog('API_WOM', 'Gọi API thành công. Dữ liệu raw đã sẵn sàng.', 'text-emerald-300');

      // 6. Output Styler
      activeStep = 5; renderPipeline();
      addLog('OUTPUT_STYLER', 'Gemma 1B IT đang định dạng lại văn phong hành chính...', 'text-pink-400'); await delay(1200);

      // 7. Final
      activeStep = 6; renderPipeline();
      addLog('SYSTEM', 'Hoàn tất quy trình.', 'text-white');
      messages.push({ role:'assistant', content: scenario.mockProcess.result }); renderChat();
      
      resetState();
    }

    function resetState(){
      isProcessing=false; 
      qs('#statusBadge').className='text-xs px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-400 border border-emerald-500/30'; 
      qs('#statusBadge').textContent='IDLE';
      qs('#userInput').disabled = false;
      qs('#sendBtn').disabled = false;
      qs('#sendBtn').classList.remove('opacity-50');
      qs('#userInput').focus();
      renderScenarios(); // Re-enable buttons
    }

    function handleSend(){
      var v = qs('#userInput').value.trim(); 
      if(!v || isProcessing) return;
      
      var custom = { 
          type:'Analysis', 
          query:v, 
          mockProcess:{ 
              intent:'Analysis (Detected)', 
              reasoning:'Phân tích câu hỏi tùy chỉnh của người dùng.', 
              tool:'General Knowledge + RAG', 
              result:'Đây là phản hồi mô phỏng cho câu hỏi: "'+v+'". Trong hệ thống thực tế, Gemma 4B sẽ tạo ra câu trả lời chi tiết dựa trên dữ liệu hành chính.' 
          } 
      };
      qs('#userInput').value=''; 
      runSimulation(custom);
    }

    // --- Init ---
    function init(){ 
        renderPipeline(); 
        renderLogs(); 
        renderChat(); 
        renderScenarios(); 
        lucide.createIcons(); 
    }

    window.addEventListener('load', init);
    
    document.addEventListener('DOMContentLoaded', function(){ 
        var sb=qs('#sendBtn'); 
        if(sb) sb.addEventListener('click', handleSend); 
        
        var ui=qs('#userInput'); 
        if(ui) ui.addEventListener('keydown', function(e){ 
            if(e.key==='Enter'){ handleSend(); } 
        }); 
    });
  </script>
</body>
</html>