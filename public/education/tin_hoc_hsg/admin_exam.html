<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản trị bài nộp</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <section id="loginPanel" class="min-h-[60vh] grid place-items-center p-4">
    <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md border-t-4 border-blue-600">
      <h2 class="text-center text-2xl font-bold mb-4">Đăng nhập Quản trị</h2>
      <p class="text-center text-gray-600 mb-6">Nhập mật khẩu quản trị để truy cập trang.</p>
      <div class="grid gap-3">
        <input id="adminLoginKey" type="password" placeholder="Mật khẩu quản trị" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-600" required />
        <button id="adminLoginBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Đăng nhập</button>
        <span id="loginStatus" class="text-sm text-gray-600"></span>
      </div>
    </div>
  </section>
  <div id="adminApp" class="container max-w-6xl mx-auto p-4 sm:p-8">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-gray-800">Quản trị bài nộp</h1>
      <p class="text-gray-600">Danh sách submissions từ bài kiểm tra Tin học 10</p>
    </header>
    <div class="grid md:grid-cols-2 gap-6 mb-6">
      <div class="bg-white rounded-lg shadow-md p-4">
        <h2 class="text-xl font-semibold mb-2">Quản lý Pass Key</h2>
        <p class="text-sm text-gray-600 mb-3">Pass key dùng để bỏ qua đếm ngược thời gian trên đề thi.</p>
        <div class="flex items-center gap-2 mb-3">
          <input id="passInput" type="text" class="flex-1 px-3 py-2 border rounded" placeholder="Nhập pass key" />
          <button id="savePassBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Lưu</button>
        </div>
        <div class="text-sm text-gray-700">
          <p>Pass hiện tại: <span id="currentPass" class="font-mono"></span></p>
          <p class="mt-2">Link chia sẻ:</p>
          <ul class="list-disc ml-5 text-blue-700">
            <li><a id="linkBai1" class="underline" target="_blank">Đề 1</a></li>
            <li><a id="linkBai2" class="underline" target="_blank">Đề 2</a></li>
          </ul>
          <p class="mt-2 text-xs text-gray-500">Thêm tham số <code>?pass=...</code> vào URL để bỏ đếm ngược.</p>
        </div>
        <p id="passStatus" class="text-xs text-gray-600 mt-2"></p>
      </div>
      <div class="bg-white rounded-lg shadow-md p-4">
        <h2 class="text-xl font-semibold mb-2">Hướng dẫn</h2>
        <ul class="list-disc ml-5 text-sm text-gray-700">
          <li>Đặt pass key, hệ thống lưu vào server.</li>
          <li>Gửi link đề thi kèm <code>?pass=PASS</code> cho thí sinh cần bỏ đếm ngược.</li>
          <li>Nếu không có pass hoặc sai pass: đề sẽ hiện lớp phủ và đếm giờ.</li>
        </ul>
      </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-4">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <button id="refreshBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Tải lại</button>
          <span id="statusText" class="text-sm text-gray-600"></span>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full border">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left border">Thời gian</th>
              <th class="px-3 py-2 text-left border">ID</th>
              <th class="px-3 py-2 text-left border">Điểm</th>
              <th class="px-3 py-2 text-left border">Họ tên</th>
              <th class="px-3 py-2 text-left border">Email</th>
              <th class="px-3 py-2 text-left border">Trang</th>
              <th class="px-3 py-2 text-left border">Xem</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4">
    <div class="bg-white w-full max-w-3xl rounded-lg p-6 overflow-y-auto max-h-[90vh]">
      <div class="flex justify-between items-center border-b pb-2 mb-4">
        <h2 class="text-xl font-semibold">Chi tiết bài nộp</h2>
        <button id="closeModal" class="text-2xl">&times;</button>
      </div>
      <div id="detail" class="space-y-4 text-sm"></div>
    </div>
  </div>

  <script>
    const loginPanel = document.getElementById('loginPanel');
    const adminApp = document.getElementById('adminApp');
    const adminLoginKey = document.getElementById('adminLoginKey');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const loginStatus = document.getElementById('loginStatus');
    const tbody = document.getElementById('tbody');
    const statusText = document.getElementById('statusText');
    const refreshBtn = document.getElementById('refreshBtn');
    const modal = document.getElementById('modal');
    const closeModal = document.getElementById('closeModal');
    const detail = document.getElementById('detail');
    const passStatus = document.getElementById('passStatus');
    const passInput = document.getElementById('passInput');
    const currentPass = document.getElementById('currentPass');
    const savePassBtn = document.getElementById('savePassBtn');
    const linkBai1 = document.getElementById('linkBai1');
    const linkBai2 = document.getElementById('linkBai2');

    async function load() {
      statusText.textContent = 'Đang tải...';
      const res = await fetch('/api/exam_submissions').catch(() => null);
      if (!res || !res.ok) {
        statusText.textContent = 'Lỗi tải dữ liệu';
        return;
      }
      const j = await res.json().catch(() => ({ items: [] }));
      const items = Array.isArray(j.items) ? j.items : [];
      window.__items = items;
      tbody.innerHTML = items.map(r => {
        const t = r.timestamp || '';
        const id = r.id || '';
        const score = `${r.score || 0}/${r.totalMcq || 0}`;
        const name = r.studentName || '';
        const email = r.studentEmail || '';
        const url = r.pageUrl || '';
        return `
          <tr>
            <td class="px-3 py-2 border">${t}</td>
            <td class="px-3 py-2 border">${id}</td>
            <td class="px-3 py-2 border">${score}</td>
            <td class="px-3 py-2 border">${escapeHtml(name)}</td>
            <td class="px-3 py-2 border">${escapeHtml(email)}</td>
            <td class="px-3 py-2 border"><a class="text-blue-600 underline" href="${url}" target="_blank">Mở</a></td>
            <td class="px-3 py-2 border"><button class="px-3 py-1 bg-gray-800 text-white rounded viewBtn" data-id="${id}">Xem</button></td>
          </tr>
        `;
      }).join('');
      statusText.textContent = `Đã tải ${items.length} bài nộp`;
    }

    tbody.addEventListener('click', e => {
      const btn = e.target.closest('.viewBtn');
      if (!btn) return;
      const tr = btn.closest('tr');
      const cells = tr.querySelectorAll('td');
      const ts = cells[0].textContent;
      const id = cells[1].textContent;
      const score = cells[2].textContent;
      const name = cells[3].textContent;
      const email = cells[4].textContent;
      detail.innerHTML = `
        <p><b>Thời gian:</b> ${ts}</p>
        <p><b>ID:</b> ${id}</p>
        <p><b>Điểm:</b> ${score}</p>
        <p><b>Họ tên:</b> ${escapeHtml(name)}</p>
        <p><b>Email:</b> ${escapeHtml(email)}</p>
        <h3 class="text-lg font-semibold mt-3">Code Câu 7</h3>
        <pre class="bg-gray-900 text-gray-100 p-3 rounded">${getCodeById(id, 'code7')}</pre>
        <h3 class="text-lg font-semibold">Code Câu 8</h3>
        <pre class="bg-gray-900 text-gray-100 p-3 rounded">${getCodeById(id, 'code8')}</pre>
      `;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    });

    function escapeHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function getCodeById(id, field) {
      return window.__items?.find(x => x.id === id)?.[field] || '(Không khả dụng)';
    }

    refreshBtn.addEventListener('click', load);
    closeModal.addEventListener('click', () => { modal.classList.add('hidden'); modal.classList.remove('flex'); });
    modal.addEventListener('click', e => { if (e.target === modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); } });

    adminLoginBtn.addEventListener('click', async () => {
      const token = (adminLoginKey.value || '').trim();
      if (!token) { loginStatus.textContent = 'Vui lòng nhập mật khẩu.'; return; }
      loginStatus.textContent = 'Đang xác thực...';
      try {
        const res = await fetch('/api/exam_passkey', { headers: { 'x-admin-token': token } });
        const j = await res.json().catch(()=>({ ok:false }));
        const authorized = j && j.ok && Object.prototype.hasOwnProperty.call(j, 'passkey');
        if (authorized) {
          window.ADMIN_TOKEN = token;
          loginPanel.classList.add('hidden');
          await loadPass();
        } else {
          loginStatus.textContent = 'Mật khẩu không đúng.';
        }
      } catch {
        loginStatus.textContent = 'Lỗi mạng khi xác thực.';
      }
    });

    // Tự động đăng nhập qua URL: ?password=ADMIN_TOKEN hoặc ?token=ADMIN_TOKEN
    (async function autoLoginFromUrl(){
      try {
        const qp = new URLSearchParams(window.location.search);
        const urlPass = qp.get('password') || qp.get('token');
        if (!urlPass) { return; }
        adminLoginKey.value = urlPass;
        const ev = new Event('click');
        adminLoginBtn.dispatchEvent(ev);
      } catch (_) {}
    })();

    // Luồng tải dữ liệu submissions mặc định khi mở trang
    (async function initLoad(){
      try { await load(); } catch (_) {}
    })();

    async function loadPass() {
      passStatus.textContent = 'Đang kiểm tra pass key...';
      try {
        const res = await fetch('/api/exam_passkey', { headers: { 'x-admin-token': (window.ADMIN_TOKEN || '') } });
        const j = await res.json().catch(()=>({ ok:false }));
        if (j.ok) {
          const pass = j.passkey || '';
          currentPass.textContent = pass ? pass : '(chưa thiết lập)';
          const origin = window.location.origin;
          linkBai1.href = `${origin}/education/tin_hoc_hsg/check_the_basics/bai1.html${pass ? `?pass=${encodeURIComponent(pass)}` : ''}`;
          linkBai1.textContent = linkBai1.href;
          linkBai2.href = `${origin}/education/tin_hoc_hsg/check_the_basics/bai2.html${pass ? `?pass=${encodeURIComponent(pass)}` : ''}`;
          linkBai2.textContent = linkBai2.href;
          passStatus.textContent = 'Đã tải pass key.';
        } else {
          passStatus.textContent = 'Không thể tải pass key.';
        }
      } catch {
        passStatus.textContent = 'Lỗi tải pass key.';
      }
    }

    savePassBtn.addEventListener('click', async () => {
      const pass = (passInput.value || '').trim();
      if (!pass) { passStatus.textContent = 'Vui lòng nhập pass key.'; return; }
      passStatus.textContent = 'Đang lưu...';
      try {
        const res = await fetch('/api/exam_passkey', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-admin-token': (window.ADMIN_TOKEN || '') },
          body: JSON.stringify({ action: 'set', passkey: pass })
        });
        const j = await res.json().catch(()=>({ ok:false }));
        if (j.ok) { passStatus.textContent = 'Đã lưu pass key.'; passInput.value=''; await loadPass(); }
        else { passStatus.textContent = 'Lưu thất bại.'; }
      } catch { passStatus.textContent = 'Lỗi mạng khi lưu.'; }
    });
  </script>
</body>
</html>