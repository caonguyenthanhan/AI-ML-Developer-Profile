<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thi·ªáp M·ªùi T·ªët Nghi·ªáp ‚Äî T√¢n C·ª≠ nh√¢n Ng√¥ T·∫•n T√†i</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/image/graduation/logotruong.png" />
  <link rel="apple-touch-icon" href="/image/graduation/logotruong.png" />

  <!-- Open Graph -->
  <meta property="og:title" content="Thi·ªáp M·ªùi L·ªÖ T·ªët Nghi·ªáp" />
  <meta property="og:description" content="Tr√¢n tr·ªçng k√≠nh m·ªùi b·∫°n ƒë·∫øn chung vui t·∫°i L·ªÖ T·ªët Nghi·ªáp." />
  <meta property="og:image" content="/image/graduation/main-preview.jpg" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="" />
  <meta property="og:site_name" content="Graduation Invite" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Tailwind (build CLI) -->
<link href="/assets/css/tw.css" rel="stylesheet">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

  <!-- Icons + Confetti -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

  <!-- AOS (Animate On Scroll) -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>

  <style>
    html { scroll-behavior: smooth; }
    .section { min-height: 100vh; display: grid; place-items: center; padding: 4rem 1rem; }
    .btn { @apply inline-flex items-center gap-2 px-4 py-2 rounded-full font-semibold transition; }
    .btn-navy { @apply bg-navy text-white hover:bg-navy/90; }
    .btn-gold { @apply bg-gold text-navy hover:bg-yellow-400; }
    .maxw { max-width: 1100px; width: 100%; }
    #s1.section { min-height: auto; padding: 2rem 1rem; }
    #s1 .maxw { gap: 1.25rem; }
    .hero-video::after {
      content: "";
      position: absolute; inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,.45), rgba(3,32,76,.7));
      pointer-events: none;
    }
    .watermark-center { position: absolute; inset: 0; display: grid; place-items: center; pointer-events: none; }
    .watermark-center img { opacity: .08; width: 9rem; height: 9rem; }
    /* Modal */
    .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal { background: white; border-radius: 1rem; padding: 1.25rem; width: min(92vw, 420px); box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .show { display: flex; }
  </style>
</head>
<body class="font-sans bg-gradient-to-b from-slate-50 to-white text-navy">

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 grid place-items-center bg-white z-[200]">
    <div class="text-center">
      <svg class="animate-spin h-10 w-10 text-navy mx-auto" viewBox="0 0 24 24" fill="none">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
      </svg>
      <p class="mt-3 font-semibold text-navy">ƒêang t·∫£i thi·ªáp m·ªùi...</p>
    </div>
  </div>

  <!-- Logo overlay -->
  <div id="logoOverlay" class="fixed top-4 right-4 z-[110] opacity-90 pointer-events-none"></div>

  <!-- Controls: Music & Celebrate -->
  <div class="fixed bottom-4 right-4 z-[110] flex items-center gap-2">
    <button id="musicBtn" class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg bg-gold text-navy hover:scale-110 transition" title="Nh·∫°c n·ªÅn">
      <i data-lucide="volume-x" class="w-6 h-6"></i>
    </button>
    <button id="celebrateBtn" class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg bg-gold text-navy hover:scale-110 transition" title="Ch√∫c m·ª´ng!">
      <i data-lucide="party-popper" class="w-6 h-6"></i>
    </button>
  </div>

  <audio id="bgm" loop></audio>

  <!-- Sections -->
  <main id="app" class="hidden">
    <!-- 1) HERO -->
    <section id="s1" class="section relative text-white">
      <div class="absolute inset-0 -z-10 hero-video">
        <video autoplay loop muted playsinline class="w-full h-full object-cover">
          <source id="bgVideoSrc" type="video/mp4">
        </video>
      </div>
      <div class="watermark-center">
        <img src="/image/graduation/logotruong.png" alt="logo">
      </div>

      <div class="maxw grid gap-8 place-items-center text-center" data-aos="fade-up">
        <p class="tracking-[0.35em] text-gold font-semibold">TH∆Ø M·ªúI</p>
        <h1 class="font-serif font-black text-5xl md:text-6xl leading-tight">L·ªÑ T·ªêT NGHI·ªÜP</h1>
        <div class="inline-flex items-center gap-3 bg-white/10 px-5 py-2 rounded-full border border-white/20">
          <span class="text-gold font-bold">T√ÇN C·ª¨ NH√ÇN</span>
          <span id="graduateNameHero" class="font-serif font-black text-2xl">T√™n T√¢n C·ª≠ Nh√¢n</span>
        </div>
        <p id="inviteLine" class="mt-3 text-white/90"></p>

        <form id="guestSearchFormTop" class="w-full max-w-xl grid grid-cols-1 md:grid-cols-[1fr_auto] gap-2 mt-4">
          <input name="guest" class="px-4 py-2 rounded-lg bg-white/90 text-navy placeholder-navy/50 focus:outline-none" placeholder="Nh·∫≠p t√™n kh√°ch m·ªùi c·ªßa b·∫°n..." />
          <button class="btn btn-gold"><i data-lucide="search" class="w-5 h-5"></i>T√¨m thi·ªáp</button>
        </form>

        <div class="flex gap-3 mt-2">
          <a href="#s2" class="btn btn-navy"><i data-lucide="chevron-down" class="w-5 h-5"></i>Xem chi ti·∫øt</a>
        </div>
      </div>
    </section>

    <!-- 2) EVENT INFO -->
    <section id="s2" class="section relative">
      <div class="absolute inset-0 pointer-events-none grid place-items-center">
        <img src="/image/graduation/logotruong.png" class="opacity-5 w-40 h-40" alt="">
      </div>

      <div class="maxw">
        <div class="text-center" data-aos="fade-up">
          <h2 class="font-serif text-4xl font-black">Th√¥ng Tin S·ª± Ki·ªán</h2>
          <p id="universityLabel" class="mt-2 font-semibold text-navy/70">T√™n Tr∆∞·ªùng</p>
        </div>

        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="rounded-xl border border-navy/10 bg-white p-6 text-center shadow-sm" data-aos="zoom-in" data-aos-delay="0">
            <i data-lucide="calendar" class="w-8 h-8 mx-auto text-navy"></i>
            <h3 class="mt-2 font-bold">Ng√†y</h3>
            <p id="eventDate" class="text-navy/80">Ch∆∞a c·∫≠p nh·∫≠t</p>
          </div>
          <div class="rounded-xl border border-navy/10 bg-white p-6 text-center shadow-sm" data-aos="zoom-in" data-aos-delay="75">
            <i data-lucide="clock" class="w-8 h-8 mx-auto text-navy"></i>
            <h3 class="mt-2 font-bold">Gi·ªù</h3>
            <p id="eventTime" class="text-navy/80">Ch∆∞a c·∫≠p nh·∫≠t</p>
          </div>
          <div class="rounded-xl border border-navy/10 bg-white p-6 text-center shadow-sm" data-aos="zoom-in" data-aos-delay="150">
            <i data-lucide="map-pin" class="w-8 h-8 mx-auto text-navy"></i>
            <h3 class="mt-2 font-bold">ƒê·ªãa ƒëi·ªÉm</h3>
            <p id="eventVenue" class="text-navy/80">Ch∆∞a c·∫≠p nh·∫≠t</p>
          </div>
        </div>

        <div class="mt-8" data-aos="fade-up">
          <a id="mapLinkBtn" href="#" target="_blank" class="btn btn-navy">
            <i data-lucide="map" class="w-5 h-5"></i>M·ªü Google Maps
          </a>
        </div>

        <div class="mt-6 rounded-xl overflow-hidden border shadow" data-aos="fade-up">
          <div id="mapEmbed"></div>
        </div>
        <div id="countdown" class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4 text-center" data-aos="fade-up"></div>
      </div>
    </section>

    <!-- 3) GRADUATE -->
    <section id="s3" class="section relative text-white">
      <div class="absolute inset-0 -z-10 bg-gradient-to-br from-navy via-navy to-black"></div>
      <div class="absolute inset-0 pointer-events-none grid place-items-center">
        <img src="/image/vien-vang.png" class="opacity-20 w-[90%] max-w-5xl" alt="">
      </div>

      <div class="maxw grid md:grid-cols-2 gap-8 items-center">
        <div class="flex justify-center" data-aos="zoom-in">
          <div class="relative w-56 h-56 md:w-64 md:h-64">
            <img src="/image/nguyet-que.png" class="absolute inset-0 w-full h-full object-contain opacity-90" alt="">
            <img id="graduateImage" src="/image/graduation/main.jpg" class="relative left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 w-40 h-40 md:w-48 md:h-48 object-cover rounded-full ring-4 ring-gold shadow-xl" alt="">
          </div>
        </div>
        <div data-aos="fade-left">
          <h3 id="graduateNameS3" class="font-serif text-4xl font-black text-gold">T√™n T√¢n C·ª≠ Nh√¢n</h3>
          <p id="graduateQuote" class="mt-3 text-white/90 italic">
            "C·∫£m ∆°n gia ƒë√¨nh, th·∫ßy c√¥ v√† b·∫°n b√® ƒë√£ ƒë·ªìng h√†nh trong ch·∫∑ng ƒë∆∞·ªùng n√†y."
          </p>
          <div id="contactWrap" class="mt-4 flex items-center gap-4"></div>
        </div>
      </div>
    </section>

    <!-- 4) RSVP -->
    <section id="s4" class="section relative">
      <div class="absolute inset-0 pointer-events-none grid place-items-center">
        <img src="/image/graduation/logotruong.png" class="opacity-5 w-40 h-40" alt="">
      </div>

      <div class="maxw">
        <div class="text-center" data-aos="fade-up">
          <h2 class="font-serif text-4xl font-black">X√°c Nh·∫≠n Tham D·ª± (RSVP)</h2>
          <p class="mt-2 text-navy/70">Vui l√≤ng ƒëi·ªÅn th√¥ng tin c·ªßa b·∫°n</p>
        </div>

        <form id="rsvpForm" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4" data-aos="fade-up">
          <div class="grid gap-2">
            <label class="text-sm font-semibold">H·ªç v√† t√™n</label>
            <input id="rsvpName" class="px-3 py-2 rounded-lg bg-gray-50 border border-navy/10 focus:outline-none" placeholder="Nguy·ªÖn VƒÉn A" required />
          </div>
          <div class="grid gap-2">
            <label class="text-sm font-semibold">Email</label>
            <input id="rsvpEmail" type="email" class="px-3 py-2 rounded-lg bg-gray-50 border border-navy/10 focus:outline-none" placeholder="ban@email.com" required />
          </div>
          <div class="grid gap-2">
            <label class="text-sm font-semibold">Tr·∫°ng th√°i</label>
            <div class="flex items-center gap-4">
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="attending" value="yes" checked />
                <span>C√≥ tham d·ª±</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="attending" value="no" />
                <span>Kh√¥ng th·ªÉ tham d·ª±</span>
              </label>
            </div>
          </div>
          <div class="grid gap-2 md:col-span-2">
            <label class="text-sm font-semibold">L·ªùi nh·∫Øn</label>
            <textarea id="rsvpMessage" rows="3" class="px-3 py-2 rounded-lg bg-gray-50 border border-navy/10 focus:outline-none" placeholder="L·ªùi nh·∫Øn (tu·ª≥ ch·ªçn)"></textarea>
          </div>

          <div class="md:col-span-2 flex items-center gap-3">
            <button class="btn btn-navy" type="submit"><i data-lucide="check-circle" class="w-5 h-5"></i> G·ª≠i x√°c nh·∫≠n</button>
            <a href="#s5" class="btn btn-gold"><i data-lucide="chevron-down" class="w-5 h-5"></i> Xem thi·ªáp c√° nh√¢n</a>
          </div>
        </form>

        <p class="text-sm text-navy/60 mt-3" data-aos="fade-up">* Sau khi g·ª≠i, h·ªá th·ªëng s·∫Ω l∆∞u ph·∫£n h·ªìi v√† g·ª≠i email th√¥ng b√°o cho ch·ªß l·ªÖ.</p>
        <div class="mt-6 grid gap-4" data-aos="fade-up">
          <div class="text-center">
            <h3 class="font-serif text-2xl font-black">B·∫°n s·∫Ω ƒë·∫øn d·ª± ch·ª©?</h3>
            <p class="mt-1 text-navy/70">Ch·ªçn m·ªôt trong hai l·ª±a ch·ªçn b√™n d∆∞·ªõi</p>
          </div>
          <div class="flex justify-center gap-4">
            <button id="btnYes" class="btn btn-gold"><i data-lucide="check" class="w-5 h-5"></i> ƒêi ch·ª©</button>
            <button id="btnNo" class="btn btn-navy"><i data-lucide="x" class="w-5 h-5"></i> Ti·∫øc qu√°</button>
          </div>
          <div id="instructionCard" class="hidden mt-4 rounded-xl border border-navy/10 bg-white p-4 shadow-sm">
            <img src="/image/graduation/map.jpg" class="w-full rounded-lg" alt="Map h∆∞·ªõng d·∫´n">
          </div>
          <form id="regretForm" class="hidden mt-4 grid gap-3 rounded-xl border border-navy/10 bg-white p-4 shadow-sm">
            <textarea id="rsvpMessage" rows="3" class="px-3 py-2 rounded-lg bg-gray-50 border border-navy/10 focus:outline-none" placeholder="G·ª≠i l·ªùi ch√∫c ho·∫∑c l√Ω do b·∫°n kh√¥ng th·ªÉ ƒë·∫øn..."></textarea>
            <button type="submit" class="btn btn-gold">G·ª≠i l·ªùi nh·∫Øn</button>
          </form>
        </div>
      </div>
    </section>

    <!-- 5) PERSONAL INVITE -->
    <section id="s5" class="section relative">
      <div class="absolute inset-0 -z-10 bg-gradient-to-br from-white to-amber-50"></div>
      <div class="absolute inset-0 pointer-events-none grid place-items-center">
        <img src="/image/graduation/logotruong.png" class="opacity-5 w-40 h-40" alt="">
      </div>

      <div class="maxw">
        <div class="text-center" data-aos="fade-up">
          <h2 class="font-serif text-4xl font-black">Thi·ªáp M·ªùi C√° Nh√¢n</h2>
          <p id="guestTarget" class="mt-2 text-navy/80">D√†nh cho b·∫°n</p>
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6" data-aos="fade-up" data-aos-delay="100">
          <div class="md:col-span-2 rounded-xl border border-navy/10 bg-white p-6 shadow-sm">
            <p id="inviteMessage" class="text-lg font-serif italic text-navy/90">
              "Th√¢n m·ªùi b·∫°n ƒë·∫øn chung vui trong ng√†y t·ªët nghi·ªáp ‚Äî s·ª± hi·ªán di·ªán c·ªßa b·∫°n l√† ni·ªÅm vinh d·ª± l·ªõn nh·∫•t!"
            </p>
            <p id="inviterName" class="mt-3 text-sm text-navy/70">‚Äî T√¢n c·ª≠ nh√¢n</p>

            <div id="rsvpActions" class="mt-6 flex flex-wrap items-center gap-3"></div>
          </div>

          <div class="rounded-xl border border-navy/10 bg-white p-6 text-center shadow-sm">
            <img id="guestAvatar" src="/image/graduation/man.jpg" class="w-20 h-20 rounded-full object-cover mx-auto mb-3 ring-2 ring-navy/10" alt="">
            <p id="guestNameLabel" class="font-semibold">T√™n Kh√°ch M·ªùi</p>

            <form id="guestSearchFormBottom" class="mt-3 flex gap-2">
              <input name="guest" class="flex-1 px-3 py-2 rounded-lg bg-gray-50 border border-navy/10 focus:outline-none" placeholder="Nh·∫≠p t√™n kh√°ch m·ªùi..." />
              <button class="px-3 py-2 rounded-lg bg-gold text-navy font-semibold">T√¨m</button>
            </form>

            <a href="#s1" class="btn btn-navy mt-3"><i data-lucide="home" class="w-5 h-5"></i> V·ªÅ trang ƒë·∫ßu</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="modalWrap" class="modal-bg">
    <div class="modal">
      <h3 id="modalTitle" class="text-xl font-bold"></h3>
      <p id="modalMsg" class="mt-1 text-gray-700"></p>
      <div class="mt-4 text-right">
        <button id="modalClose" class="btn btn-gold">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!-- ====== SCRIPT (Firebase + Logic) ====== -->
  <script type="module">
    // ===== Firebase SDK =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, getDocs, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ===== Globals & Config =====
    const appId = typeof __app_id !== "undefined" ? __app_id : "default-app-id";
    const firebaseConfig = typeof __firebase_config !== "undefined" ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== "undefined" ? __initial_auth_token : null;
    const APP_ROOT = "/graduation";

    const ASSETS = {
      GRADUATE_IMAGE: "/image/graduation/main.jpg",
      MAP_IMAGE: "/image/graduation/map.jpg",
      MAN_DEFAULT: "/image/graduation/man.jpg",
      WOMEN_DEFAULT: "/image/graduation/women.jpg",
      LAUREL_WREATH: "/image/nguyet-que.png",
      GOLD_FRAME: "/image/vien-vang.png",
      LOGO: "/image/graduation/logotruong.png",
      BG_VIDEO: "/video/sparkle-background.mp4",
    };

    const INFO_URL = "/data/info.json";
    const GUESTS_URL = "/data/khach.json";

    let db, auth, isAuthReady = false;
    let INFO = null;
    let GUESTS = [];

    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    // ===== Utilities =====
    function showModal(title, msg) {
      $("#modalTitle").textContent = title;
      $("#modalMsg").textContent = msg;
      $("#modalWrap").classList.add("show");
    }
    $("#modalClose").addEventListener("click", ()=> $("#modalWrap").classList.remove("show"));

    function goldBurst() {
      confetti({ particleCount: 150, spread: 90, origin: { y: .6 }, colors: ["#FFD700","#FFF3B0","#FDE047","#FACC15"] });
    }

    function normalize(s) {
      return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
    }

    function updateMeta(info, guest=null) {
      const title = guest ? `Th∆∞ m·ªùi d√†nh cho ${guest.title||""} ${guest.name}` : `Thi·ªáp M·ªùi L·ªÖ T·ªët Nghi·ªáp | ${info?.graduateName||"Graduate"}`;
      const desc = guest ? `Thi·ªáp m·ªùi ƒë·∫∑c bi·ªát t·ª´ ${info?.graduateName||"T√¢n c·ª≠ nh√¢n"} d√†nh cho ${guest.title||""} ${guest.name}.`
                         : `Tr√¢n tr·ªçng k√≠nh m·ªùi b·∫°n ƒë·∫øn chung vui c√πng ${info?.graduateName||"t√¢n c·ª≠ nh√¢n"}.`;
      const img  = guest?.previewImage || info?.previewImage || ASSETS.GRADUATE_IMAGE;
      document.title = title;
      const set=(sel,attr,val)=>{const m=$(sel); if(m) m.setAttribute(attr,val);};
      set('meta[property="og:title"]', "content", title);
      set('meta[property="og:description"]', "content", desc);
      set('meta[property="og:image"]', "content", img.startsWith("http")?img:`${location.origin}${img}`);
      set('meta[property="og:image:width"]',"content","1200");
      set('meta[property="og:image:height"]',"content","630");
      set('meta[name="twitter:card"]',"content","summary_large_image");
    }

    // ===== Firebase Setup & Data Load =====
    async function setupFirebase() {
      try {
        if (!firebaseConfig || !Object.keys(firebaseConfig).length) { console.warn("Missing firebaseConfig; will fallback JSON."); return false; }
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken); else await signInAnonymously(auth);
        isAuthReady = true; return true;
      } catch (e) { console.error("Firebase init error:", e); return false; }
    }
    const infoDocRef   = () => doc(db, "artifacts", appId, "public", "data", "info", "event_details");
    const guestsColRef = () => collection(db, "artifacts", appId, "public", "data", "khach");
    const rsvpsColRef  = () => collection(db, "artifacts", appId, "public", "data", "rsvps");

    async function loadData() {
      let info = null, guests = [];
      const canFs = await setupFirebase();
      if (canFs && isAuthReady) {
        try {
          const infoSnap = await getDoc(infoDocRef());
          if (infoSnap.exists()) info = infoSnap.data();
          const guestsSnap = await getDocs(guestsColRef());
          guests = guestsSnap.docs.map(d=>d.data());
        } catch (e) { console.warn("Firestore read failed; fallback JSON...", e); }
      }
      try {
        if (!info) {
          const r = await fetch(INFO_URL, { cache: "no-store" }); if (r.ok) info = await r.json();
        }
        if (!guests?.length) {
          const r = await fetch(GUESTS_URL, { cache: "no-store" }); if (r.ok) { const j = await r.json(); guests = Array.isArray(j?.guests)? j.guests : Array.isArray(j)? j : []; }
        }
      } catch(e){ console.error("Local JSON load error:", e); }
      guests = (guests||[]).map(g=>({...g, nameEncoded: encodeURIComponent(g.name)}));
      return { info, guests };
    }

    // ===== Music & Celebrate =====
    function setupMusic(info) {
      const audio = $("#bgm"), btn = $("#musicBtn");
      if (!audio || !btn) return;
      audio.src = info?.music || "";
      let playing = false;
      const render = () => btn.innerHTML = playing ? '<i data-lucide="volume-2" class="w-6 h-6"></i>' : '<i data-lucide="volume-x" class="w-6 h-6"></i>';
      const tryPlay = () => audio.play().then(()=>{playing=true;render();lucide.createIcons();}).catch(()=>{playing=false;render();lucide.createIcons();});
      btn.addEventListener("click", ()=>{ if(!playing) tryPlay(); else { audio.pause(); playing=false; render(); lucide.createIcons(); }});
      setTimeout(()=>tryPlay(), 600);
      document.addEventListener("click", ()=>{ if(!playing) tryPlay(); }, { once: true });
    }

    // ===== Render Helpers =====
    function bindGuestSearch(forms, guests) {
      forms.forEach(form=>{
        const input = form.querySelector("input[name='guest']");
        form.addEventListener("submit", e=>{
          e.preventDefault();
          const q = normalize(input.value);
          if (!q) { input.focus(); return; }
          let target = guests.find(g=>normalize(g.name)===q) || guests.find(g=>normalize(g.name).includes(q));
          if (target) {
            sessionStorage.setItem("guestName", target.name);
            history.pushState({}, "", `${APP_ROOT}/${encodeURIComponent(target.name)}`);
            renderPersonalInvite(INFO, target);
            updateMeta(INFO, target);
            goldBurst();
            document.getElementById("s5").scrollIntoView({ behavior: "smooth" });
          } else {
            // ch∆∞a c√≥ trong danh s√°ch ‚Üí v·∫´n cho qua RSVP
            sessionStorage.setItem("guestName", input.value);
            showModal("Th√¥ng b√°o", "Kh√¥ng t√¨m th·∫•y trong danh s√°ch kh√°ch. B·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c g·ª≠i RSVP ·ªü Trang 4.");
            document.getElementById("s4").scrollIntoView({ behavior: "smooth" });
          }
        });
      });
    }

    function renderEventInfo(info) {
      $("#graduateNameHero").textContent = info?.graduateName || "T√™n T√¢n C·ª≠ Nh√¢n";
      $("#universityLabel").textContent  = info?.university || "T√™n Tr∆∞·ªùng";
      $("#eventDate").textContent        = info?.date || "Ch∆∞a c·∫≠p nh·∫≠t";
      $("#eventTime").textContent        = info?.time || "Ch∆∞a c·∫≠p nh·∫≠t";
      $("#eventVenue").textContent       = info?.venue || "Ch∆∞a c·∫≠p nh·∫≠t";

      const mapLink = info?.mapLink || "#";
      $("#mapLinkBtn").setAttribute("href", mapLink);
      $("#mapEmbed").innerHTML = info?.mapLink
        ? `<iframe src="${info.mapLink}" width="100%" height="360" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`
        : `<img src="${ASSETS.MAP_IMAGE}" class="w-full h-80 object-cover" alt="Map" />`;

      $("#graduateImage").src = info?.graduateImage || ASSETS.GRADUATE_IMAGE;
      $("#graduateNameS3").textContent = info?.graduateName || "T√™n T√¢n C·ª≠ Nh√¢n";
      $("#graduateQuote").textContent  = info?.graduateQuote || "C·∫£m ∆°n gia ƒë√¨nh, th·∫ßy c√¥ v√† b·∫°n b√® ƒë√£ ƒë·ªìng h√†nh trong ch·∫∑ng ƒë∆∞·ªùng n√†y.";

      const c = info?.contact || {};
      const cont = [];
      if (c.phone)    cont.push(`<a href="tel:${c.phone}" class="hover:text-gold" title="G·ªçi"><i data-lucide="phone" class="w-5 h-5"></i></a>`);
      if (c.zalo)     cont.push(`<a href="${c.zalo}" target="_blank" class="hover:text-gold" title="Zalo"><i data-lucide="message-square" class="w-5 h-5"></i></a>`);
      if (c.facebook) cont.push(`<a href="${c.facebook}" target="_blank" class="hover:text-gold" title="Facebook"><i data-lucide="facebook" class="w-5 h-5"></i></a>`);
      $("#contactWrap").innerHTML = cont.join("");

      // bg video & logo overlay
      $("#bgVideoSrc").src = ASSETS.BG_VIDEO;
      $("#logoOverlay").innerHTML = `<img src="${ASSETS.LOGO}" class="w-10 h-10 md:w-12 md:h-12" alt="">`;
    }

    function currentGuestFromURL(guests) {
      const parts = location.pathname.replace(/\/+$/, "").split("/").filter(Boolean);
      if (parts.length===2 && parts[0].toLowerCase()==="graduation") {
        const name = decodeURIComponent(parts[1]);
        return guests.find(g=>g.name.toLowerCase()===name.toLowerCase()) || null;
      }
      return null;
    }

    function renderPersonalInvite(info, guest=null) {
      const guestName   = guest?.name || sessionStorage.getItem("guestName") || "B·∫°n";
      const guestTitle  = guest?.title ? `${guest.title} ` : "";
      const inviteMsg   = (guest?.message && guest.message.trim()) ? guest.message :
                          info?.personalInviteDefault || "S·ª± hi·ªán di·ªán c·ªßa b·∫°n l√† ni·ªÅm vinh d·ª± l·ªõn nh·∫•t!";
      const img = guest?.image ? `/image/graduation/${guest.image}`
                : guest?.gender?.toLowerCase()==="female" ? ASSETS.WOMEN_DEFAULT : ASSETS.MAN_DEFAULT;

      $("#guestTarget").textContent     = `D√†nh cho ${guestTitle}${guestName}`;
      $("#inviteMessage").textContent   = `"${inviteMsg}"`;
      $("#inviterName").textContent     = `‚Äî ${info?.graduateName || "T√¢n c·ª≠ nh√¢n"}`;
      $("#guestAvatar").src             = img;
      $("#guestNameLabel").textContent  = `${guestTitle}${guestName}`;

      const rsvpBtn = info?.rsvpLink ? `<a href="${info.rsvpLink}" target="_blank" class="btn btn-navy"><i data-lucide="calendar-check" class="w-5 h-5"></i> M·ªü trang RSVP</a>` : "";
      $("#rsvpActions").innerHTML = `
        ${rsvpBtn}
        <a href="#s1" class="btn btn-gold"><i data-lucide="home" class="w-5 h-5"></i> V·ªÅ trang ƒë·∫ßu</a>
      `;
      lucide.createIcons();
    }

    // ===== RSVP Actions =====
    async function sendRsvpToFirestore(data) {
      if (!db) return false;
      try {
        await addDoc(rsvpsColRef(), { ...data, timestamp: new Date().toISOString() });
        return true;
      } catch (e) { console.error("RSVP Firestore error:", e); return false; }
    }

    async function sendRsvpEmail(data, info) {
      try {
        const res = await fetch("https://hethongthongminh.id.vn/api/rsvp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ...data, eventInfo: { email: info?.email || "", graduate: info?.graduateName || "" } })
        });
        const ct = res.headers.get("content-type") || "";
        if (!res.ok) {
          const t = await res.text();
          console.error("RSVP Email HTTP error:", res.status, t.slice(0,200));
          return false;
        }
        if (ct.includes("application/json")) {
          const j = await res.json();
          return !!(j && (j.success || j.ok));
        } else {
          const t = await res.text();
          console.warn("RSVP Email non-JSON:", t.slice(0,200));
          return false;
        }
      } catch (e) { console.error("RSVP Email error:", e); return false; }
    }

    function getGuestFromUrl() {
      const parts = location.pathname.split('/').filter(Boolean);
      if (parts.length >= 2 && parts[0].toLowerCase() === 'graduation4') {
        return decodeURIComponent(parts[1]);
      }
      return null;
    }

    async function postRsvp(payload) {
      try {
        const res = await fetch('https://hethongthongminh.id.vn/api/rsvp', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const ct = res.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          const j = await res.json();
          return { ok: res.ok, data: j };
        } else {
          const tx = await res.text();
          return { ok: res.ok, data: tx };
        }
      } catch (e) { return { ok: false, error: String(e) }; }
    }

    function initCountdown() {
      const cd = document.getElementById('countdown');
      if (!cd) return;
      let target = null;
      if (INFO && (INFO.datetime || (INFO.date && INFO.time))) {
        if (INFO.datetime) target = new Date(INFO.datetime);
        else target = new Date(`${INFO.date} ${INFO.time}`);
      }
      if (!target || isNaN(target)) {
        const dEl = document.getElementById('eventDate');
        const tEl = document.getElementById('eventTime');
        if (dEl && tEl) {
          const dt = new Date(`${dEl.textContent.replace('Ng√†y','').replace(':','').trim()} ${tEl.textContent.replace('Gi·ªù','').replace(':','').trim()}`);
          if (!isNaN(dt)) target = dt;
        }
      }
      if (!target || isNaN(target)) { cd.textContent = ''; return; }
      function render(diffMs) {
        const s = Math.floor(diffMs / 1000);
        const days = Math.floor(s / 86400);
        const hours = Math.floor((s % 86400) / 3600);
        const minutes = Math.floor((s % 3600) / 60);
        const seconds = s % 60;
        cd.innerHTML = `
          <div class="rounded-xl border border-navy/10 bg-white p-4 text-navy"><div class="text-3xl font-bold">${days}</div><div class="text-sm">Ng√†y</div></div>
          <div class="rounded-xl border border-navy/10 bg-white p-4 text-navy"><div class="text-3xl font-bold">${hours}</div><div class="text-sm">Gi·ªù</div></div>
          <div class="rounded-xl border border-navy/10 bg-white p-4 text-navy"><div class="text-3xl font-bold">${minutes}</div><div class="text-sm">Ph√∫t</div></div>
          <div class="rounded-xl border border-navy/10 bg-white p-4 text-navy"><div class="text-3xl font-bold">${seconds}</div><div class="text-sm">Gi√¢y</div></div>
        `;
      }
      function tick() {
        const now = new Date();
        const diff = target - now;
        if (diff <= 0) { cd.innerHTML = '<div class="font-semibold">S·ª± ki·ªán ƒëang di·ªÖn ra</div>'; clearInterval(timer); return; }
        render(diff);
      }
      tick();
      const timer = setInterval(tick, 1000);
    }

    function bindSimpleRsvp() {
      const btnYes = document.getElementById('btnYes');
      const btnNo = document.getElementById('btnNo');
      const instruction = document.getElementById('instructionCard');
      const regretForm = document.getElementById('regretForm');
      const guest = getGuestFromUrl();
      if (guest) {
        const inviteLineEl = document.getElementById('inviteLine');
        const guestNameEl = document.getElementById('guestName');
        const guestNameLabelEl = document.getElementById('guestNameLabel');
        if (inviteLineEl) inviteLineEl.textContent = `Tr√¢n tr·ªçng k√≠nh m·ªùi ${guest} ƒë·∫øn tham d·ª± l·ªÖ t·ªët nghi·ªáp.`;
        if (guestNameEl) guestNameEl.textContent = guest;
        if (guestNameLabelEl) guestNameLabelEl.textContent = guest;
      }
      if (btnYes) {
        btnYes.addEventListener('click', async () => {
          if (instruction) instruction.classList.remove('hidden');
          if (regretForm) regretForm.classList.add('hidden');
          confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 }, colors: ['#FFD700', '#FFF3B0'] });
          const payload = { name: guest || '', attending: true, message: '' };
          const r = await postRsvp(payload);
          if (!r.ok) showModal('G·ª≠i RSVP th·∫•t b·∫°i', 'H·ªá th·ªëng t·∫°m th·ªùi gi√°n ƒëo·∫°n, vui l√≤ng th·ª≠ l·∫°i sau.');
        });
      }
      if (btnNo && regretForm) {
        btnNo.addEventListener('click', () => {
          if (instruction) instruction.classList.add('hidden');
          regretForm.classList.remove('hidden');
        });
        regretForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const msgEl = document.getElementById('rsvpMessage');
          const message = msgEl ? msgEl.value : '';
          const payload = { name: guest || '', attending: false, message };
          const r = await postRsvp(payload);
          regretForm.reset();
          regretForm.innerHTML = '<p class="text-gold font-semibold">C·∫£m ∆°n b·∫°n ƒë√£ g·ª≠i l·ªùi nh·∫Øn üíå</p>';
          if (!r.ok) showModal('G·ª≠i l·ªùi nh·∫Øn th·∫•t b·∫°i', 'H·ªá th·ªëng t·∫°m th·ªùi gi√°n ƒëo·∫°n, l·ªùi nh·∫Øn v·∫´n ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n c·ª•c b·ªô.');
        });
      }
    }

    function bindRsvpForm(info) {
      $("#rsvpForm").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const name  = $("#rsvpName").value.trim();
        const email = $("#rsvpEmail").value.trim();
        const attending = (document.querySelector("input[name='attending']:checked")?.value==="yes");
        const message   = $("#rsvpMessage").value.trim();

        if (!name || !email) {
          showModal("Thi·∫øu th√¥ng tin", "Vui l√≤ng nh·∫≠p H·ªç t√™n v√† Email."); return;
        }

        const rsvpData = { name, email, attending, message };

        // Save local guestName for page 5
        sessionStorage.setItem("guestName", name);

        // 1) Firestore
        const okFs = await sendRsvpToFirestore(rsvpData);
        // 2) Email via Vercel
        const okMail = await sendRsvpEmail(rsvpData, info);

        if (okFs && okMail) {
          showModal("üéâ RSVP th√†nh c√¥ng!", "C·∫£m ∆°n b·∫°n ƒë√£ x√°c nh·∫≠n tham d·ª±!");
          goldBurst();
          // Render personal invite (no guest object yet)
          renderPersonalInvite(info, null);
          document.getElementById("s5").scrollIntoView({ behavior: "smooth" });
        } else if (okFs && !okMail) {
          showModal("ƒê√£ l∆∞u RSVP", "H·ªá th·ªëng l∆∞u th√†nh c√¥ng, nh∆∞ng ch∆∞a g·ª≠i email th√¥ng b√°o. Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh Vercel.");
          renderPersonalInvite(info, null);
          document.getElementById("s5").scrollIntoView({ behavior: "smooth" });
        } else {
          showModal("L·ªói g·ª≠i RSVP", "Kh√¥ng th·ªÉ g·ª≠i ph·∫£n h·ªìi l√∫c n√†y. Vui l√≤ng th·ª≠ l·∫°i.");
        }
      });
    }

    // ===== Main =====
    async function main() {
      const { info, guests } = await loadData();
      INFO = info; GUESTS = guests;

      if (!info) {
        $("#loading").innerHTML = `
          <div class="text-center">
            <h2 class="text-2xl font-bold text-red-600">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</h2>
            <p class="mt-2 text-gray-700">Ki·ªÉm tra Firestore ho·∫∑c file JSON fallback.</p>
            <ul class="mt-3 text-left text-sm text-gray-600 list-disc list-inside">
              <li>/artifacts/{appId}/public/data/info/event_details</li>
              <li>/artifacts/{appId}/public/data/khach</li>
            </ul>
          </div>
        `;
        return;
      }

      // Fill UI
      $("#app").classList.remove("hidden");
      $("#loading").classList.add("hidden");
      renderEventInfo(info);
      AOS.init({ duration: 700, once: true, offset: 40 });

      // Icons
      lucide.createIcons();

      // Music
      setupMusic(info);

      // Celebrate button
      $("#celebrateBtn")?.addEventListener("click", goldBurst);

      // Guest search forms
      bindGuestSearch([$("#guestSearchFormTop"), $("#guestSearchFormBottom")], guests);

      // If URL includes guest
      const currentGuest = currentGuestFromURL(guests);
      if (currentGuest) {
        renderPersonalInvite(info, currentGuest);
        updateMeta(info, currentGuest);
      } else {
        renderPersonalInvite(info, null);
        updateMeta(info, null);
      }

      // RSVP form
      bindRsvpForm(info);

      initCountdown();
      bindSimpleRsvp();

      // When back/forward
      window.addEventListener("popstate", ()=>{
        const cg = currentGuestFromURL(guests);
        renderPersonalInvite(info, cg);
        updateMeta(info, cg);
      });
    }

    window.addEventListener("load", main);
  </script>

  <script>
    // Init icons for static HTML
    window.addEventListener("load", ()=>{ try { lucide.createIcons(); } catch(_){} });
  </script>
</body>
</html>
