<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quản trị RSVP — Graduation</title>

  <!-- Tailwind -->
<link href="/assets/css/tw.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { navy: "#03204c", gold: "#ffd700" },
          fontFamily: { sans: ["Inter", "ui-sans-serif"], serif: ["Playfair Display"] },
        },
      },
    };
  </script>

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50 text-navy font-sans">

  <!-- Header -->
  <header class="bg-navy text-white p-4 flex items-center justify-between">
    <h1 class="text-xl font-bold flex items-center gap-2">
      <i data-lucide="calendar-check"></i> Quản trị RSVP
    </h1>
    <button id="logoutBtn" class="hidden px-3 py-1 rounded bg-gold text-navy font-semibold hover:bg-yellow-400">
      Đăng xuất
    </button>
  </header>

  <!-- Login Panel -->
  <section id="loginPanel" class="min-h-[80vh] grid place-items-center">
    <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md border-t-4 border-gold">
      <h2 class="text-center text-2xl font-bold mb-4">Đăng nhập Quản trị</h2>
      <p class="text-center text-gray-600 mb-6">Nhập khóa quản trị để xem danh sách RSVP.</p>
      <form id="loginForm" class="grid gap-4">
        <input id="adminKeyInput" type="password" placeholder="Mã quản trị (adminKey)" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gold" required />
        <button class="bg-navy text-white py-2 rounded-lg font-semibold hover:bg-navy/90">Đăng nhập</button>
      </form>
    </div>
  </section>

  <!-- Dashboard -->
  <main id="dashboard" class="hidden p-6 max-w-6xl mx-auto">
    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <div class="flex items-center gap-2">
        <select id="filterStatus" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-gold focus:outline-none">
          <option value="all">Tất cả</option>
          <option value="yes">Có tham dự</option>
          <option value="no">Không tham dự</option>
        </select>
        <input id="searchBox" type="text" placeholder="Tìm theo tên hoặc email..." class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-gold focus:outline-none" />
      </div>
      <div class="flex items-center gap-2">
        <button id="addManualBtn" class="bg-navy text-white px-4 py-2 rounded-lg font-semibold hover:bg-navy/90 flex items-center gap-2">
          <i data-lucide="plus"></i> Thêm thủ công
        </button>
        <button id="exportBtn" class="bg-gold text-navy px-4 py-2 rounded-lg font-semibold hover:bg-yellow-400 flex items-center gap-2">
          <i data-lucide="download"></i> Xuất CSV
        </button>
      </div>
    </div>

    <div id="statsBar" class="grid grid-cols-3 gap-3 mb-4">
      <div class="rounded-lg bg-white border p-3 text-center"><div class="text-sm text-gray-500">Tổng số</div><div id="countTotal" class="text-2xl font-bold">0</div></div>
      <div class="rounded-lg bg-white border p-3 text-center"><div class="text-sm text-gray-500">Có tham dự</div><div id="countYes" class="text-2xl font-bold text-green-600">0</div></div>
      <div class="rounded-lg bg-white border p-3 text-center"><div class="text-sm text-gray-500">Không tham dự</div><div id="countNo" class="text-2xl font-bold text-red-600">0</div></div>
    </div>

    <form id="manualForm" class="hidden mb-4 grid grid-cols-1 md:grid-cols-4 gap-3 bg-white border rounded-lg p-4">
      <input id="mName" placeholder="Họ tên" class="px-3 py-2 border rounded" required />
      <input id="mEmail" type="email" placeholder="Email" class="px-3 py-2 border rounded" />
      <select id="mAttend" class="px-3 py-2 border rounded">
        <option value="yes">Có tham dự</option>
        <option value="no">Không tham dự</option>
      </select>
      <input id="mMessage" placeholder="Lời nhắn" class="px-3 py-2 border rounded" />
      <button id="mSubmit" class="md:col-span-4 bg-navy text-white px-4 py-2 rounded font-semibold">Thêm</button>
    </form>

    <div class="overflow-x-auto rounded-lg shadow bg-white">
      <table class="min-w-full border-collapse text-sm" id="rsvpTable">
        <thead class="bg-navy text-white">
          <tr>
            <th class="px-3 py-2 text-left">Tên</th>
            <th class="px-3 py-2 text-left">Email</th>
            <th class="px-3 py-2 text-center">Tham dự</th>
            <th class="px-3 py-2 text-left">Lời nhắn</th>
            <th class="px-3 py-2 text-center">Thời gian</th>
            <th class="px-3 py-2 text-center">Thao tác</th>
          </tr>
        </thead>
        <tbody id="rsvpBody"></tbody>
      </table>
    </div>
  </main>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const appId = typeof __app_id !== "undefined" ? __app_id : "default-app-id";
    const firebaseConfig = typeof __firebase_config !== "undefined" ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== "undefined" ? __initial_auth_token : null;
    const INFO_URL = "/data/info.json";

    let db, auth, INFO = null, RSVPS = [];

    async function setupFirebase() {
      try {
        if (!firebaseConfig || !Object.keys(firebaseConfig).length) return false;
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        await signInAnonymously(auth);
        return true;
      } catch (e) {
        console.error("Firebase init error:", e);
        return false;
      }
    }

    async function loadInfo() {
      const ref = doc(db, "artifacts", appId, "public", "data", "info", "event_details");
      const snap = await getDoc(ref);
      if (snap.exists()) INFO = snap.data();
    }

    async function loadInfoJson() {
      try {
        const r = await fetch(INFO_URL, { cache: "no-store" });
        if (r.ok) return await r.json();
      } catch (e) { console.warn("Load info.json failed:", e); }
      return null;
    }

    async function loadRsvps() {
      const ref = collection(db, "artifacts", appId, "public", "data", "rsvps");
      const snap = await getDocs(ref);
      return snap.docs.map(d => d.data());
    }

    async function loadRsvpsApi() {
      try {
        const res = await fetch("/api/rsvp", { method: "GET" });
        if (!res.ok) return [];
        const j = await res.json().catch(()=>null);
        if (!j) return [];
        const list = Array.isArray(j?.data) ? j.data : (Array.isArray(j?.rsvps) ? j.rsvps : []);
        return list;
      } catch (e) { console.error("Load RSVPs API failed:", e); return []; }
    }

    function renderTable(data) {
      const body = document.getElementById("rsvpBody");
      body.innerHTML = "";
      if (!data.length) {
        body.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Không có dữ liệu RSVP</td></tr>`;
        return;
      }
      for (const r of data) {
        const attend = r.attending ? "✅" : "❌";
        const tr = document.createElement("tr");
        tr.dataset.id = r.id || "";
        tr.dataset.ts = r.timestamp || "";
        tr.innerHTML = `
          <td class="border-t px-3 py-2">${r.name || "-"}</td>
          <td class="border-t px-3 py-2">${r.email || "-"}</td>
          <td class="border-t px-3 py-2 text-center">${attend}</td>
          <td class="border-t px-3 py-2">${r.message || ""}</td>
          <td class="border-t px-3 py-2 text-center text-gray-500">${new Date(r.timestamp || "").toLocaleString("vi-VN")}</td>
          <td class="border-t px-3 py-2 text-center"><button class="delBtn bg-red-600 text-white px-2 py-1 rounded">Xóa</button></td>
        `;
        body.appendChild(tr);
      }
      updateStats(data);
    }

    function filterData() {
      const status = document.getElementById("filterStatus").value;
      const search = document.getElementById("searchBox").value.toLowerCase().trim();

      let filtered = RSVPS;
      if (status !== "all") filtered = filtered.filter(r => r.attending === (status === "yes"));
      if (search) filtered = filtered.filter(r => (r.name || "").toLowerCase().includes(search) || (r.email || "").toLowerCase().includes(search));
      renderTable(filtered);
    }

    function updateStats(data) {
      const total = data.length;
      const yes = data.filter(r => r.attending).length;
      const no = total - yes;
      document.getElementById("countTotal").textContent = String(total);
      document.getElementById("countYes").textContent = String(yes);
      document.getElementById("countNo").textContent = String(no);
    }

    function exportCSV() {
      if (!RSVPS.length) return alert("Không có dữ liệu để xuất.");
      const rows = [["Tên", "Email", "Tham dự", "Lời nhắn", "Thời gian"]];
      RSVPS.forEach(r => {
        rows.push([
          r.name || "",
          r.email || "",
          r.attending ? "Có" : "Không",
          r.message || "",
          new Date(r.timestamp || "").toLocaleString("vi-VN")
        ]);
      });
      const csv = rows.map(e => e.map(x => `"${(x || "").replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "RSVP_List.csv";
      a.click();
    }

    // Login & UI logic
    async function doLoginWithKey(keyInput) {
      const canFs = await setupFirebase();
      if (canFs) { await loadInfo(); }
      if (!INFO) { INFO = await loadInfoJson(); }
      const key = String(keyInput || "").trim();
      if (!INFO?.adminKey || key !== INFO.adminKey) {
        alert("Mã quản trị không hợp lệ!");
        return false;
      }

      document.getElementById("loginPanel").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
      document.getElementById("logoutBtn").classList.remove("hidden");

      RSVPS = canFs ? await loadRsvps() : await loadRsvpsApi();
      renderTable(RSVPS);
      lucide.createIcons();
      return true;
    }

    document.getElementById("loginForm").addEventListener("submit", async e => {
      e.preventDefault();
      const val = document.getElementById("adminKeyInput").value;
      await doLoginWithKey(val);
    });

    // Auto-login via URL query: ?pass=ADMINKEY or ?password=ADMINKEY
    (async function autoLoginFromUrl(){
      try {
        const qp = new URLSearchParams(window.location.search);
        const urlPass = qp.get("pass") || qp.get("password");
        if (!urlPass) return; // no query pass provided
        const input = document.getElementById("adminKeyInput");
        input.value = urlPass;
        await doLoginWithKey(urlPass);
      } catch (e) { console.warn("Auto-login via URL failed:", e); }
    })();

    document.getElementById("logoutBtn").addEventListener("click", () => location.reload());
    document.getElementById("filterStatus").addEventListener("change", filterData);
    document.getElementById("searchBox").addEventListener("input", filterData);
    document.getElementById("exportBtn").addEventListener("click", exportCSV);

    document.getElementById("addManualBtn").addEventListener("click", () => {
      const fm = document.getElementById("manualForm");
      fm.classList.toggle("hidden");
    });

    document.getElementById("mSubmit").addEventListener("click", async e => {
      e.preventDefault();
      const data = {
        name: document.getElementById("mName").value.trim(),
        email: document.getElementById("mEmail").value.trim(),
        attending: document.getElementById("mAttend").value === "yes",
        message: document.getElementById("mMessage").value.trim(),
      };
      if (!data.name) return alert("Vui lòng nhập họ tên");
      const res = await fetch("/api/rsvp", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) });
      const ok = res.ok;
      if (!ok) return alert("Thêm thất bại");
      const j = await res.json().catch(()=>({}));
      const entry = { ...data, timestamp: new Date().toISOString(), id: j.id || "" };
      RSVPS.push(entry);
      renderTable(RSVPS);
      document.getElementById("manualForm").classList.add("hidden");
    });

    document.getElementById("rsvpBody").addEventListener("click", async e => {
      const btn = e.target.closest(".delBtn");
      if (!btn) return;
      const tr = btn.closest("tr");
      const id = tr?.dataset?.id || "";
      const ts = tr?.dataset?.ts || "";
      const res = await fetch("/api/rsvp", { method: "DELETE", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ id, timestamp: ts }) });
      if (!res.ok) return alert("Xóa thất bại");
      RSVPS = RSVPS.filter(r => (id ? r.id !== id : r.timestamp !== ts));
      renderTable(RSVPS);
    });
  </script>
</body>
</html>
