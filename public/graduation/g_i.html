<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thi·ªáp M·ªùi T·ªët Nghi·ªáp ‚Äî T√¢n C·ª≠ nh√¢n Ng√¥ T·∫•n T√†i</title>

  <!-- Open Graph -->
  <meta property="og:title" content="Thi·ªáp M·ªùi L·ªÖ T·ªët Nghi·ªáp" />
  <meta property="og:description" content="Tr√¢n tr·ªçng k√≠nh m·ªùi b·∫°n ƒë·∫øn chung vui t·∫°i L·ªÖ T·ªët Nghi·ªáp." />
  <meta property="og:image" content="/image/graduation/main-preview.jpg" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="" />
  <meta name="twitter:card" content="summary_large_image" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/image/graduation/logotruong.png" />
  <link rel="shortcut icon" href="/image/graduation/logotruong.png" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ivory: "#FFFBF7",
            gold: "#D4AF37",
            charcoal: "#242424",
            taupe: "#5D5C61",
            navy: "#03204C" // gi·ªØ ƒë·ªÉ t∆∞∆°ng th√≠ch n·∫øu c√≤n d√πng
          },
          fontFamily: {
            sans: ["Inter","ui-sans-serif","system-ui"],
            serif: ["Playfair Display","ui-serif"],
            cursive: ["Great Vibes","cursive"],
          },
        },
      },
    };
  </script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700;900&family=Great+Vibes&display=swap" rel="stylesheet">

  <!-- Icons + Confetti + AOS -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>

  <style>
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; color: #242424; background: #FFFBF7; }
    .section { min-height: 100vh; display: grid; place-items: center; padding: 3rem 1rem; }
    .card { background: rgba(255,255,255,.85); border: 1px solid rgba(212,175,55,.35); border-radius: 1.25rem; backdrop-filter: blur(6px); box-shadow: 0 10px 30px rgba(0,0,0,.06); }
    .btn { @apply inline-flex items-center justify-center gap-2 px-5 py-2.5 rounded-full font-semibold transition; }
    .btn-gold { background:#D4AF37; color:#242424; }
    .btn-gold:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .btn-navy { background:#242424; color:#FFFBF7; border:1px solid #D4AF37; }
    .btn-navy:hover { background:#333333; transform: translateY(-1px); }
    .watermark-center { position:absolute; inset:0; display:grid; place-items:center; pointer-events:none }
    .watermark-center img { opacity:.08; width:9rem; height:9rem }
    .hero-overlay::after { content:""; position:absolute; inset:0; background: linear-gradient(180deg, rgba(212,175,55,.06), rgba(255,251,247,.85)); pointer-events:none; }
    .count-box { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:.25rem; border-radius:10px; background:#242424; color:#FFFBF7; padding:.75rem; box-shadow:0 6px 16px rgba(0,0,0,.15); }
    /* ƒê·∫£m b·∫£o ch·ªØ c√≥ ƒë·ªô t∆∞∆°ng ph·∫£n t·ªët tr√™n n·ªÅn m·ªõi */
    [class*="text-white"] { color: #242424 !important; }
  </style>
</head>
<body>

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 grid place-items-center bg-white/90 text-charcoal z-[200]">
    <div class="text-center">
      <svg class="animate-spin h-10 w-10 mx-auto" viewBox="0 0 24 24" fill="none">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
      </svg>
      <p class="mt-3 font-semibold">ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>
  </div>

  <!-- Overlay: logo + controls -->
  <div id="logoOverlay" class="fixed top-4 right-4 z-[110] pointer-events-none opacity-90"></div>
  <div class="fixed bottom-4 right-4 z-[110] flex items-center gap-2">
    <button id="musicBtn" class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg btn-gold" title="Nh·∫°c n·ªÅn">
      <i data-lucide="volume-x" class="w-6 h-6"></i>
    </button>
    <button id="celebrateBtn" class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg btn-gold" title="Ch√∫c m·ª´ng!">
      <i data-lucide="party-popper" class="w-6 h-6"></i>
    </button>
  </div>
  <audio id="bgm" loop></audio>

  <!-- App -->
  <main id="app" class="hidden">

    <!-- 1) HERO -->
    <section id="s1" class="section relative text-charcoal">
      <div class="absolute inset-0 -z-10 hero-overlay">
        <video id="bgVideo" autoplay loop muted playsinline class="w-full h-full object-cover">
          <source id="bgVideoSrc" type="video/mp4">
        </video>
      </div>
      <div class="watermark-center"><img src="/image/graduation/logotruong.png" alt="logo" /></div>

      <div class="max-w-3xl w-full text-center" data-aos="fade-up">
        <p class="font-semibold tracking-[0.35em] text-gold">TH∆Ø M·ªúI</p>
        <h1 class="font-serif font-black text-5xl md:text-6xl mt-2">L·ªÑ T·ªêT NGHI·ªÜP</h1>

        <div class="mt-5 inline-flex items-center gap-3 bg-white/70 px-5 py-2 rounded-full border border-[#E6E2D8]/60">
          <span class="text-gold font-bold">T√ÇN C·ª¨ NH√ÇN</span>
          <span id="graduateNameHero" class="font-serif font-black text-2xl">T√™n T√¢n C·ª≠ Nh√¢n</span>
        </div>

        <p id="inviteLine" class="mt-4 text-lg text-charcoal">
          Tr√¢n tr·ªçng k√≠nh m·ªùi <span id="guestNameHero" class="font-semibold text-gold">b·∫°n</span> ƒë·∫øn tham d·ª± l·ªÖ t·ªët nghi·ªáp.
        </p>
        

      </div>
    </section>

    <!-- 2) EVENT INFO + COUNTDOWN -->
    <section id="s2" class="section relative">
      <div class="watermark-center"><img src="/image/graduation/logotruong.png" alt="logo" /></div>

      <div class="max-w-5xl w-full">
        <div class="text-center" data-aos="fade-up">
          <h2 class="font-serif text-4xl font-black">Th√¥ng Tin S·ª± Ki·ªán</h2>
          <p id="universityLabel" class="mt-2 font-semibold text-taupe">T√™n Tr∆∞·ªùng</p>
        </div>

        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="card p-6 text-center" data-aos="zoom-in">
            <i data-lucide="calendar" class="w-8 h-8 mx-auto text-gold"></i>
            <h3 class="mt-2 font-bold text-gold">Ng√†y</h3>
            <p id="eventDate" class="text-charcoal">Ch∆∞a c·∫≠p nh·∫≠t</p>
          </div>
          <div class="card p-6 text-center" data-aos="zoom-in" data-aos-delay="100">
            <i data-lucide="clock" class="w-8 h-8 mx-auto text-gold"></i>
            <h3 class="mt-2 font-bold text-gold">Gi·ªù</h3>
            <p id="eventTime" class="text-charcoal">Ch∆∞a c·∫≠p nh·∫≠t</p>
          </div>
          <div class="card p-6 text-center" data-aos="zoom-in" data-aos-delay="200">
            <i data-lucide="map-pin" class="w-8 h-8 mx-auto text-gold"></i>
            <h3 class="mt-2 font-bold text-gold">ƒê·ªãa ƒëi·ªÉm</h3>
            <p id="eventVenue" class="text-charcoal">Ch∆∞a c·∫≠p nh·∫≠t</p>
          </div>
        </div>

        <!-- Countdown -->
        <div class="mt-10 card p-6" data-aos="fade-up">
          <div class="text-center mb-4">
            <p class="text-white/90">ƒê·∫øm ng∆∞·ª£c t·ªõi th·ªùi kh·∫Øc tr·ªçng ƒë·∫°i</p>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="count-box"><div id="cdDays" class="text-4xl font-extrabold">0</div><div class="text-sm">Ng√†y</div></div>
            <div class="count-box"><div id="cdHours" class="text-4xl font-extrabold">0</div><div class="text-sm">Gi·ªù</div></div>
            <div class="count-box"><div id="cdMinutes" class="text-4xl font-extrabold">0</div><div class="text-sm">Ph√∫t</div></div>
            <div class="count-box"><div id="cdSeconds" class="text-4xl font-extrabold">0</div><div class="text-sm">Gi√¢y</div></div>
          </div>
          <p id="cdStatus" class="mt-3 text-center text-taupe text-sm"></p>
        </div>

        <div class="mt-8 rounded-xl overflow-hidden border border-gold/30 shadow" data-aos="fade-up">
          <div id="mapEmbed"></div>
        </div>
      </div>
    </section>

    <!-- 3) GRADUATE -->
    <section id="s3" class="section relative text-charcoal">
      <div class="absolute inset-0 -z-10 bg-gradient-to-br from-[#FFFBF7] via-[#FFF6EB] to-[#F3EEE4]"></div>
      <div class="absolute inset-0 pointer-events-none grid place-items-center">
        <img src="/image/vien-vang.png" class="opacity-20 w-[90%] max-w-5xl" alt="">
      </div>

      <div class="max-w-5xl w-full grid md:grid-cols-2 gap-8 items-center">
        <div class="flex justify-center" data-aos="zoom-in">
          <div class="relative w-56 h-56 md:w-64 md:h-64">
            <img src="/image/nguyet-que.png" class="absolute inset-0 w-full h-full object-contain opacity-90" alt="">
            <img id="graduateImage" src="/image/graduation/main.jpg" class="relative left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 w-40 h-40 md:w-48 md:h-48 object-cover rounded-full ring-4 ring-gold shadow-xl" alt="">
          </div>
        </div>
        <div data-aos="fade-left">
          <h3 id="graduateNameS3" class="font-serif text-4xl font-black text-gold">T√™n T√¢n C·ª≠ Nh√¢n</h3>
          <p id="graduateQuote" class="mt-3 text-taupe italic" data-thanks="info.json/thanksMessage"></p>
          <div id="contactWrap" class="mt-4 flex items-center gap-4"></div>
        </div>
      </div>
    </section>

    <!-- 4) RSVP -->
    <section id="s4" class="section relative">
      <div class="watermark-center"><img src="/image/graduation/logotruong.png" alt="logo" /></div>
      <div class="max-w-2xl w-full card p-6 text-center" data-aos="fade-up">
        <h2 class="font-serif text-3xl text-gold mb-1">B·∫°n s·∫Ω ƒë·∫øn d·ª± ch·ª©?</h2>
        <p class="text-taupe mb-6">(Ch·ªçn ƒë√°p √°n!)</p>
        <div class="flex justify-center gap-6">
          <button id="btnYes" class="btn btn-gold text-lg px-6 py-3">ƒêi ch·ª©</button>
          <button id="btnNo" class="btn btn-navy text-lg px-6 py-3">Ti·∫øc qu√°</button>
        </div>

        <!-- Ch·ªâ d·∫´n khi "ƒêi ch·ª©" -->
        <div id="instructionCard" class="hidden mt-6 card p-4">
          <h3 class="font-serif text-2xl text-gold mb-3">Ch·ªâ d·∫´n tham d·ª±</h3>
          <img src="/image/graduation/map.jpg" class="w-full rounded-lg shadow border border-gold/40" alt="Map h∆∞·ªõng d·∫´n" />
        </div>

        <!-- Form khi "Ti·∫øc qu√°" -->
        <form id="regretForm" class="hidden mt-6 grid gap-3 card p-4 text-left">
          <label class="text-sm font-semibold">L·ªùi nh·∫Øn (tu·ª≥ ch·ªçn)</label>
          <textarea id="rsvpMessage" rows="3" class="px-3 py-2 rounded-lg bg-white/80 text-navy focus:outline-none" placeholder="G·ª≠i l·ªùi ch√∫c ho·∫∑c l√Ω do b·∫°n kh√¥ng th·ªÉ ƒë·∫øn..."></textarea>
          <button type="submit" class="btn btn-gold self-start">G·ª≠i l·ªùi nh·∫Øn</button>
        </form>
      </div>
    </section>

    <!-- 5) PERSONAL INVITE -->
    <section id="s5" class="section relative">
      <div class="absolute inset-0 -z-10 bg-gradient-to-br from-[#FFF6EB]/40 to-[#D4AF37]/10"></div>
      <div class="watermark-center"><img src="/image/graduation/logotruong.png" alt="logo" /></div>

      <div class="max-w-3xl w-full card p-6 text-center" data-aos="fade-up">
        <h2 class="font-serif text-4xl font-black text-gold">Thi·ªáp M·ªùi C√° Nh√¢n</h2>
        <p id="guestTarget" class="mt-2 text-taupe">D√†nh cho b·∫°n</p>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="md:col-span-2 text-left">
            <p id="inviteMessage" class="text-lg font-serif italic text-charcoal">
              "S·ª± hi·ªán di·ªán c·ªßa b·∫°n l√† ni·ªÅm vinh d·ª± l·ªõn nh·∫•t!"
            </p>
            <p id="inviterName" class="mt-3 text-sm text-taupe">‚Äî T√¢n c·ª≠ nh√¢n</p>
            <div class="mt-6 flex flex-wrap items-center gap-3">
              <a href="#s1" class="btn btn-gold"><i data-lucide="home" class="w-5 h-5"></i> V·ªÅ trang ƒë·∫ßu</a>
            </div>
          </div>

          <div class="text-center">
            <img id="guestAvatar" src="/image/graduation/man.jpg" class="w-20 h-20 rounded-full object-cover mx-auto mb-3 ring-2 ring-gold/30" alt="">
            <p id="guestNameLabel" class="font-cursive text-3xl text-gold">T√™n Kh√°ch M·ªùi</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="modalWrap" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[2000]">
    <div class="bg-white text-charcoal rounded-2xl p-6 w-[min(92vw,420px)] shadow-xl">
      <h3 id="modalTitle" class="text-xl font-bold"></h3>
      <p id="modalMsg" class="mt-1 text-gray-700"></p>
      <div class="mt-4 text-right">
        <button id="modalClose" class="btn btn-navy">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!-- ====== SCRIPT (Firebase + Logic) ====== -->
  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, getDocs, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ===== Config & Globals =====
    const appId = typeof __app_id !== "undefined" ? __app_id : "default-app-id";
    const firebaseConfig = typeof __firebase_config !== "undefined" ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== "undefined" ? __initial_auth_token : null;
    const APP_ROOT = "/graduation"; // theo y√™u c·∫ßu URL

    const ASSETS = {
      LOGO: "/image/graduation/logotruong.png",
      BG_VIDEO: "/video/sparkle-background.mp4",
      GRADUATE_IMAGE: "/image/graduation/main.jpg",
      MAN_DEFAULT: "/image/graduation/man.jpg",
      WOMEN_DEFAULT: "/image/graduation/women.jpg",
      MAP_IMAGE: "/image/graduation/map.jpg",
    };

    const INFO_URL = "/data/info.json";
    const GUESTS_URL = "/data/khach.json";

    let db, auth, INFO=null, GUESTS=[];
    let countdownTimer = null;

    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    // ===== UI helpers =====
    function showModal(title, msg) {
      $("#modalTitle").textContent = title;
      $("#modalMsg").textContent = msg;
      $("#modalWrap").classList.remove("hidden");
      $("#modalWrap").classList.add("flex");
    }
    $("#modalClose").addEventListener("click", ()=> {
      $("#modalWrap").classList.add("hidden");
      $("#modalWrap").classList.remove("flex");
    });

    function goldConfetti() {
      confetti({ particleCount: 160, spread: 100, origin: { y: .6 }, colors: ["#D4AF37","#FFF3B0","#FDE047","#FACC15"] });
    }

    function normalize(s) { return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim(); }
    function beautifyName(name) {
      return (name||"").split(/[\s_]+/).map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(" ").trim();
    }

    function getGuestFromUrl() {
      const parts = location.pathname.replace(/\/+$/,"").split("/").filter(Boolean);
      if (parts.length >= 2 && parts[0].toLowerCase() === "graduation") return decodeURIComponent(parts[1]);
      return null;
    }

    function updateMeta(info, guest=null) {
      const baseTitle = `Thi·ªáp M·ªùi T·ªët Nghi·ªáp ‚Äî ${info?.graduateName || "T√¢n C·ª≠ nh√¢n"}`;
      const title = guest ? `Th∆∞ m·ªùi d√†nh cho ${guest.title?guest.title+" ":""}${guest.name}`
                          : baseTitle;
      const desc = guest ? `Thi·ªáp m·ªùi t·ª´ ${info?.graduateName || "T√¢n c·ª≠ nh√¢n"} d√†nh cho ${guest.title?guest.title+" ":""}${guest.name}.`
                         : `Tr√¢n tr·ªçng k√≠nh m·ªùi b·∫°n ƒë·∫øn chung vui c√πng ${info?.graduateName||"t√¢n c·ª≠ nh√¢n"}.`;
      const img  = guest?.previewImage || info?.previewImage || ASSETS.GRADUATE_IMAGE;
      // Gi·ªØ title tab theo c·∫•u tr√∫c th·ªëng nh·∫•t
      document.title = baseTitle;
      const set=(sel,attr,val)=>{const m=$(sel); if(m) m.setAttribute(attr,val);};
      set('meta[property="og:title"]', "content", title);
      set('meta[property="og:description"]', "content", desc);
      set('meta[property="og:image"]', "content", img.startsWith("http")?img:`${location.origin}${img}`);
    }

    // ===== Firebase Setup & Data load =====
    async function setupFirebase() {
      try {
        if (!firebaseConfig || !Object.keys(firebaseConfig).length) return false;
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
        else await signInAnonymously(auth);
        return true;
      } catch (e) { console.error("Firebase init error:", e); return false; }
    }
    const infoDocRef   = () => doc(db, "artifacts", appId, "public", "data", "info", "event_details");
    const guestsColRef = () => collection(db, "artifacts", appId, "public", "data", "khach");
    const rsvpsColRef  = () => collection(db, "artifacts", appId, "public", "data", "rsvps");

    async function loadData() {
      let info=null, guests=[];
      const canFs = await setupFirebase();
      if (canFs) {
        try {
          const infoSnap = await getDoc(infoDocRef());
          if (infoSnap.exists()) info = infoSnap.data();
          const guestsSnap = await getDocs(guestsColRef());
          guests = guestsSnap.docs.map(d=>d.data());
        } catch (e) { console.warn("Firestore read failed; fallback JSON...", e); }
      }
      try {
        if (!info) {
          const r = await fetch(INFO_URL, { cache: "no-store" }); if (r.ok) info = await r.json();
        }
        if (!guests?.length) {
          const r = await fetch(GUESTS_URL, { cache: "no-store" }); if (r.ok) {
            const j = await r.json(); guests = Array.isArray(j?.guests)? j.guests : Array.isArray(j)? j : [];
          }
        }
      } catch(e){ console.error("Local JSON load error:", e); }
      guests = (guests||[]).map(g=>({...g, nameEncoded: encodeURIComponent(g.name)}));
      return { info, guests };
    }

    // ===== Music & chrome =====
    function setupMusic(info) {
      const audio = $("#bgm"), btn = $("#musicBtn");
      if (info?.music) audio.src = info.music;
      let playing=false;
      const render = () => btn.innerHTML = playing ? '<i data-lucide="volume-2" class="w-6 h-6"></i>' : '<i data-lucide="volume-x" class="w-6 h-6"></i>';
      const tryPlay = () => audio.play().then(()=>{playing=true;render();lucide.createIcons();}).catch(()=>{playing=false;render();lucide.createIcons();});
      btn.addEventListener("click", ()=>{ if(!playing) tryPlay(); else { audio.pause(); playing=false; render(); lucide.createIcons(); }});
      setTimeout(()=>tryPlay(), 600);
      document.addEventListener("click", ()=>{ if(!playing) tryPlay(); }, { once: true });
    }

    // ===== Countdown =====
    function parseEventDateTime(info) {
      // c·ªë g·∫Øng gh√©p info.date + info.time th√†nh Date
      const dateStr = (info?.date || "").trim();   // v√≠ d·ª•: "27/06/2025" ho·∫∑c "2025-06-27"
      const timeStr = (info?.time || "00:00").trim(); // "15:30"
      let d = null;

      // Th·ª≠ d·∫°ng dd/mm/yyyy
      const m = dateStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if (m) {
        const [_, dd, mm, yyyy] = m;
        d = new Date(`${yyyy}-${mm.padStart(2,"0")}-${dd.padStart(2,"0")}T${timeStr}:00`);
      } else if (!isNaN(Date.parse(dateStr))) {
        d = new Date(`${dateStr}T${timeStr}:00`);
      }

      if (!d || isNaN(d.getTime())) {
        // fallback: +7 ng√†y
        d = new Date(Date.now() + 7*24*3600*1000);
      }
      return d;
    }

    function startCountdown(target) {
      const daysEl = $("#cdDays"), hoursEl = $("#cdHours"), minutesEl = $("#cdMinutes"), secondsEl = $("#cdSeconds"), statusEl=$("#cdStatus");
      function tick() {
        const now = new Date();
        let diff = Math.floor((target.getTime() - now.getTime())/1000);
        if (diff <= 0) {
          daysEl.textContent=hoursEl.textContent=minutesEl.textContent=secondsEl.textContent="0";
          statusEl.textContent = "S·ª± ki·ªán ƒë√£ di·ªÖn ra. C·∫£m ∆°n b·∫°n ƒë√£ quan t√¢m!";
          clearInterval(countdownTimer);
          return;
        }
        const d = Math.floor(diff / (24*3600)); diff -= d*24*3600;
        const h = Math.floor(diff / 3600); diff -= h*3600;
        const m = Math.floor(diff / 60); const s = diff - m*60;
        daysEl.textContent  = String(d);
        hoursEl.textContent = String(h);
        minutesEl.textContent = String(m);
        secondsEl.textContent = String(s);
        statusEl.textContent = "";
      }
      tick();
      countdownTimer = setInterval(tick, 1000);
    }

    // ===== Personal Invite render =====
    function renderPersonalInvite(info, guest=null) {
      const guestName = beautifyName(guest?.name || sessionStorage.getItem("guestName") || "B·∫°n");
      const guestTitle = guest?.title ? `${guest.title} ` : "";
      const inviteMsg = (guest?.message && guest.message.trim()) ? guest.message
                        : (info?.personalInviteDefault || "S·ª± hi·ªán di·ªán c·ªßa b·∫°n l√† ni·ªÅm vinh d·ª± l·ªõn nh·∫•t!");
      const avatar = guest?.image ? guest.image
                    : (guest?.gender && guest.gender.toLowerCase()==="female" ? ASSETS.WOMEN_DEFAULT : ASSETS.MAN_DEFAULT);

      $("#guestTarget").textContent = `D√†nh cho ${guestTitle}${guestName}`;
      $("#guestNameLabel").textContent = `${guestTitle}${guestName}`;
      $("#inviteMessage").textContent = `"${inviteMsg}"`;
      $("#inviterName").textContent = `‚Äî ${info?.graduateName || "T√¢n c·ª≠ nh√¢n"}`;
      $("#guestAvatar").src = avatar.startsWith("/") ? avatar : `/image/graduation/${avatar}`;
    }

    // ===== RSVP senders =====
    async function sendRsvpToFirestore(data) {
      if (!db) return false;
      try {
        await addDoc(rsvpsColRef(), { ...data, timestamp: new Date().toISOString() });
        return true;
      } catch (e) { console.error("RSVP Firestore error:", e); return false; }
    }

    async function sendRsvpEmail(data, info) {
      try {
        const res = await fetch("https://hethongthongminh.id.vn/api/rsvp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ...data, eventInfo: { email: info?.email, university: info?.university, date: info?.date } })
        });
        const j = await res.json().catch(()=>({success:false}));
        return !!j?.success;
      } catch (e) { console.error("RSVP Email error:", e); return false; }
    }

    // ===== Main =====
    async function main() {
      AOS.init({ duration: 700, once: true, offset: 40 });
      lucide.createIcons();

      // load data
      const { info, guests } = await loadData();
      INFO=info; GUESTS=guests;

      if (!info) {
        $("#loading").innerHTML = `
          <div class="text-center text-charcoal">
            <h2 class="text-2xl font-bold text-red-600">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</h2>
            <p class="mt-2">Ki·ªÉm tra Firestore ho·∫∑c /data/info.json.</p>
          </div>`;
        return;
      }

      // show app
      $("#app").classList.remove("hidden");
      $("#loading").classList.add("hidden");

      // chrome
      $("#logoOverlay").innerHTML = `<img src="${ASSETS.LOGO}" class="w-10 h-10 md:w-12 md:h-12" alt="">`;
      $("#bgVideoSrc").src = ASSETS.BG_VIDEO;
      setupMusic(info);
      $("#celebrateBtn").addEventListener("click", goldConfetti);

      // fill hero + event
      $("#graduateNameHero").textContent = info?.graduateName || "T√™n T√¢n C·ª≠ Nh√¢n";
      $("#universityLabel").textContent  = info?.university || "T√™n Tr∆∞·ªùng";
      $("#eventDate").textContent        = info?.date || "Ch∆∞a c·∫≠p nh·∫≠t";
      $("#eventTime").textContent        = info?.time || "Ch∆∞a c·∫≠p nh·∫≠t";
      $("#eventVenue").textContent       = info?.venue || "Ch∆∞a c·∫≠p nh·∫≠t";
      $("#graduateImage").src            = info?.graduateImage || ASSETS.GRADUATE_IMAGE;
      $("#graduateNameS3").textContent   = info?.graduateName || "T√™n T√¢n C·ª≠ Nh√¢n";
      const tq = $("#graduateQuote");
      if (tq) {
        tq.innerHTML = info?.thanksMessage || info?.quote || tq.innerHTML;
      }

      // contact
      const c = info?.contact || {};
      const cont = [];
      if (c.phone)    cont.push(`<a href="tel:${c.phone}" class="hover:text-gold" title="G·ªçi"><i data-lucide="phone" class="w-5 h-5"></i></a>`);
      if (c.zalo)     cont.push(`<a href="${c.zalo}" target="_blank" class="hover:text-gold" title="Zalo"><i data-lucide="message-square" class="w-5 h-5"></i></a>`);
      if (c.facebook) cont.push(`<a href="${c.facebook}" target="_blank" class="hover:text-gold" title="Facebook"><i data-lucide="facebook" class="w-5 h-5"></i></a>`);
      $("#contactWrap").innerHTML = cont.join("");
      lucide.createIcons();

      // map
      $("#mapEmbed").innerHTML = info?.mapLink
        ? `<iframe src="${info.mapLink}" width="100%" height="360" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`
        : `<img src="${ASSETS.MAP_IMAGE}" class="w-full h-80 object-cover" alt="Map" />`;

      // countdown
      const targetTime = parseEventDateTime(info);
      startCountdown(targetTime);

      // ===== Guest from URL logic (c·∫≠p nh·∫≠t chu·∫©n) =====
      const rawFromUrl = getGuestFromUrl();
      let currentGuest = null;

      if (rawFromUrl) {
        const q = normalize(rawFromUrl);
        currentGuest =
          GUESTS.find(g => normalize(g.name) === q) ||
          GUESTS.find(g => normalize(g.name).includes(q)) ||
          { name: beautifyName(rawFromUrl) };

        sessionStorage.setItem("guestName", currentGuest.name);
        const titleTxt = currentGuest.title ? `${currentGuest.title} ` : "";
        const nameTxt = `${titleTxt}${currentGuest.name}`;

        const guestNameEl = $("#guestNameHero");
        if (guestNameEl) guestNameEl.textContent = nameTxt;

        const inviteLineEl = $("#inviteLine");
        if (inviteLineEl)
          inviteLineEl.textContent = `Tr√¢n tr·ªçng k√≠nh m·ªùi ${nameTxt} ƒë·∫øn tham d·ª± l·ªÖ t·ªët nghi·ªáp.`;

        renderPersonalInvite(INFO, currentGuest);
        updateMeta(INFO, currentGuest);

      } else {
        // Fallback n·∫øu kh√¥ng c√≥ :guest trong URL
        const guestNameEl = $("#guestNameHero");
        if (guestNameEl) guestNameEl.textContent = "b·∫°n";

        const inviteLineEl = $("#inviteLine");
        if (inviteLineEl)
          inviteLineEl.textContent = "Tr√¢n tr·ªçng k√≠nh m·ªùi b·∫°n ƒë·∫øn tham d·ª± l·ªÖ t·ªët nghi·ªáp.";

        renderPersonalInvite(INFO, null);
        updateMeta(INFO, null);
      }


      // RSVP logic
      const btnYes = $("#btnYes"), btnNo = $("#btnNo"), instruction = $("#instructionCard"), regretForm = $("#regretForm");
      const getCurrentName = () => beautifyName(sessionStorage.getItem("guestName") || currentGuest?.name || "B·∫°n");

      btnYes.addEventListener("click", async ()=>{
        instruction.classList.remove("hidden");
        regretForm.classList.add("hidden");
        const name = getCurrentName();
        const payload = { name, email: "", attending: true, message: "" };
        const fsOK = await sendRsvpToFirestore(payload);
        const mailOK = await sendRsvpEmail(payload, INFO);
        goldConfetti();
        if (fsOK && mailOK) showModal("üéâ C·∫£m ∆°n b·∫°n!", "R·∫•t h√¢n h·∫°nh ƒë∆∞·ª£c ƒë√≥n ti·∫øp b·∫°n t·∫°i bu·ªïi l·ªÖ.");
        else if (fsOK)      showModal("ƒê√£ ghi nh·∫≠n tham d·ª±", "G·ª≠i email kh√¥ng th√†nh c√¥ng ‚Äî ki·ªÉm tra c·∫•u h√¨nh API.");
        else                showModal("L·ªói", "Kh√¥ng th·ªÉ ghi nh·∫≠n RSVP l√∫c n√†y. Vui l√≤ng th·ª≠ l·∫°i.");
      });

      btnNo.addEventListener("click", ()=>{
        instruction.classList.add("hidden");
        regretForm.classList.remove("hidden");
      });

      regretForm.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const name = getCurrentName();
        const msg = $("#rsvpMessage").value.trim();
        const payload = { name, email: "", attending: false, message: msg };
        const fsOK = await sendRsvpToFirestore(payload);
        const mailOK = await sendRsvpEmail(payload, INFO);
        if (fsOK && mailOK) {
          regretForm.reset();
          regretForm.classList.add("hidden");
          showModal("üíå C·∫£m ∆°n b·∫°n", "R·∫•t ti·∫øc b·∫°n kh√¥ng th·ªÉ tham d·ª±. L·ªùi nh·∫Øn c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i.");
        } else if (fsOK) {
          showModal("ƒê√£ l∆∞u l·ªùi nh·∫Øn", "G·ª≠i email kh√¥ng th√†nh c√¥ng ‚Äî ki·ªÉm tra c·∫•u h√¨nh API.");
        } else {
          showModal("L·ªói", "Kh√¥ng th·ªÉ g·ª≠i ph·∫£n h·ªìi l√∫c n√†y. Vui l√≤ng th·ª≠ l·∫°i.");
        }
      });
    }

    window.addEventListener("load", main);
  </script>

  <script>
    // Init for static parts
    window.addEventListener("load", ()=>{ try { AOS.init({ duration: 700, once: true }); lucide.createIcons(); } catch(_){} });
  </script>
</body>
</html>
