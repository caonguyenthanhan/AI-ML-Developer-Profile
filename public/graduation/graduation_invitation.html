<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lời Mời Tốt Nghiệp Cá Nhân Hóa</title>
    <!-- Tải Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện icon Lucide-React -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Tải Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Cấu hình Tailwind CSS cho tông màu Xanh Navy và Vàng Kim
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'navy': '#03204c', // Màu xanh navy đậm
                        'gold': '#ffd700', // Màu vàng kim
                        'primary': '#03204c', // Đặt primary là navy
                        'secondary': '#ffd700', // Đặt secondary là gold
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'], // Font cho tiêu đề lớn
                    },
                }
            }
        }
    </script>
    <style>
        /* CSS tuỳ chỉnh để thêm hiệu ứng lấp lánh và kiểu thiệp mời */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@400;600;700&display=swap');
        
        body {
            background-color: #eef2ff; /* Nền xanh nhạt bên ngoài */
        }
        
        /* Hiệu ứng lấp lánh (dùng cho nền cột trái) */
        .sparkle-background {
            background-color: #03204c;
            background-image: 
                radial-gradient(circle at top right, rgba(255, 215, 0, 0.1) 1px, transparent 0), 
                radial-gradient(circle at bottom left, rgba(255, 215, 0, 0.1) 1px, transparent 0);
            background-size: 20px 20px;
        }

        /* Viền vàng lấp lánh cho ảnh */
        .golden-border {
            border: 4px solid transparent;
            box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.8), 0 0 5px 2px rgba(255, 215, 0, 0.6);
        }

        /* Thiệp mời đặc biệt (dành cho Cha, Mẹ, Thầy Cô) */
        .special-card {
            background: linear-gradient(135deg, #05376e, #03204c);
            box-shadow: 0 10px 30px rgba(3, 32, 76, 0.8);
            border: 3px solid #ffd700;
        }

        /* Viền thiệp chính (cột phải) */
        .invitation-frame {
            border: 2px solid #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
        }
        .gold-frame-bg {
            background-image: url('/image/vien-vang.png');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 100% 100%;
        }
        /* Hiệu ứng ánh sáng mới */
        .gold-shine {
            color: #ffd700;
            animation: goldShine 3.2s ease-in-out infinite;
            text-shadow: 0 0 6px rgba(255,215,0,0.6), 0 0 2px rgba(255,215,0,0.4);
        }
        @keyframes goldShine {
            0%, 100% {
                text-shadow: 0 0 6px rgba(255,215,0,0.6), 0 0 2px rgba(255,215,0,0.4);
                transform: scale(1);
            }
            50% {
                text-shadow: 0 0 12px rgba(255,215,0,0.8), 0 0 4px rgba(255,215,0,0.6);
                transform: scale(1.01);
            }
        }
        .soft-glow {
            position: relative;
        }
        .soft-glow::before {
            content: "";
            position: absolute;
            inset: -10%;
            background: radial-gradient(circle at 50% 30%, rgba(255, 215, 0, 0.12), transparent 60%);
            filter: blur(10px);
            z-index: 0;
            pointer-events: none;
        }
        .soft-glow > * {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Container chính để render nội dung -->
    <div id="app" class="flex flex-col items-center p-4 md:p-8">
        <!-- Nội dung sẽ được render bởi JavaScript -->
        <div class="text-center p-8">Đang tải...</div>
    </div>

    <script type="module">
        // Biến toàn cục từ môi trường Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let isAuthReady = false;

        // --- 1. SETUP FIREBASE VÀ AUTH ---
        async function setupFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Cannot proceed with Firestore.");
                    return false;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Đăng nhập bằng Custom Token hoặc ẩn danh
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                console.log("Firebase initialized and user signed in:", auth.currentUser.uid);
                isAuthReady = true;
                return true;
            } catch (error) {
                console.error("Error setting up Firebase:", error);
                return false;
            }
        }

        // --- 2. CẤU HÌNH CỐ ĐỊNH ---
        const DEFAULT_INVITE_MESSAGE = "Thân gửi bạn, hãy đến chung vui cùng tôi trong buổi lễ trọng đại này, đánh dấu một cột mốc quan trọng trên con đường sắp tới. Sự hiện diện của bạn là niềm vinh dự lớn nhất của tôi!";
        const APP_ROOT = '/graduation';
        
        // Mặc định ảnh sẽ lấy từ public/image/graduation
        const INFO_URL = "/data/info.json";
        const GUESTS_URL = "/data/khach.json";
        const ASSETS = {
                GRADUATE_IMAGE: "/image/graduation/main.jpg", // Ảnh người tốt nghiệp
                MAP_IMAGE: "/image/graduation/map.jpg", // Ảnh bản đồ nội bộ
                MAN_DEFAULT: "/image/graduation/man.jpg", // Ảnh mặc định nam
                WOMEN_DEFAULT: "/image/graduation/women.jpg", // Ảnh mặc định nữ
                LAUREL_WREATH: "/image/nguyet-que.png", // Vòng nguyệt quế vàng
                GOLD_FRAME: "/image/vien-vang.png" // Viền khung trang trí vàng
            };


        // --- 3. LOGIC XỬ LÝ DỮ LIỆU TỪ FIRESTORE (ĐÃ BỎ MOCK DATA) ---
        
        const getInfoDocRef = () => doc(db, "artifacts", appId, "public", "data", "info", "event_details");
        const getGuestsCollectionRef = () => collection(db, "artifacts", appId, "public", "data", "khach");

        async function initializeData() {
            let info = null;
            let guests = [];

            const isUsingFirestore = await setupFirebase();

            if (isUsingFirestore && isAuthReady) {
                try {
                    // 1. Tải Info từ Firestore
                    const infoDoc = await getDoc(getInfoDocRef());
                    if (infoDoc.exists()) {
                        info = infoDoc.data();
                        console.log("Event info loaded from Firestore.");
                    } else {
                        console.warn("Event info document not found in Firestore.");
                    }
                    
                    // 2. Tải Guests từ Firestore
                    const guestSnapshot = await getDocs(getGuestsCollectionRef());
                    guests = guestSnapshot.docs.map(doc => doc.data()) || [];
                    
                    if (guests.length === 0) {
                        console.warn("No guests found in Firestore.");
                    }
                } catch (e) {
                    console.error("Error loading data from Firestore:", e);
                }
            }

            // Fallback sang dữ liệu JSON nội bộ nếu Firestore không khả dụng hoặc thiếu dữ liệu
            try {
                if (!info) {
                    const infoRes = await fetch(INFO_URL, { cache: 'no-store' });
                    if (infoRes.ok) {
                        info = await infoRes.json();
                        console.log("Event info loaded from local JSON:", INFO_URL);
                    } else {
                        console.error("Failed to fetch local info.json", infoRes.status);
                    }
                }
                if (!guests || guests.length === 0) {
                    const guestsRes = await fetch(GUESTS_URL, { cache: 'no-store' });
                    if (guestsRes.ok) {
                        const guestsJson = await guestsRes.json();
                        guests = Array.isArray(guestsJson?.guests) ? guestsJson.guests : (Array.isArray(guestsJson) ? guestsJson : []);
                        console.log("Guests loaded from local JSON:", GUESTS_URL);
                    } else {
                        console.error("Failed to fetch local khach.json", guestsRes.status);
                    }
                }
            } catch (e) {
                console.error("Error loading local JSON data:", e);
            }

            // Thêm trường encoded name cho routing
            guests = (guests || []).map(g => ({...g, nameEncoded: encodeURIComponent(g.name)}));
            
            return { info, guests };
        }

        // --- 4. HÀM RENDER TRANG CHỦ (/graduation) ---
        function renderMainPage(info, guests) {
            // Kiểm tra dữ liệu chính
            if (!info || !info.graduateName) {
                return renderDataError('Không tìm thấy thông tin sự kiện. Vui lòng kiểm tra Firestore.');
            }

            const defaultGuestName = info.graduateName;

            // Vòng lặp để hiển thị tối đa 5 khách mời để gợi ý
            const guestLinks = guests.slice(0, 5).map(g => {
                return `<a href="${APP_ROOT}/${g.nameEncoded}" class="block text-base text-gold hover:underline font-semibold">${g.title} ${g.name}</a>`;
            }).join('');
            
            const guestSection = guests.length > 0 ? `
                <div class="mt-8 text-center w-full p-4 bg-navy/20 rounded-lg border border-gold/50">
                    <p class="text-sm text-gold mb-2 font-bold">Tìm Thiệp Mời Của Bạn:</p>
                    <form id="guestSearchForm" class="space-y-2">
                        <input
                            type="text"
                            id="guestNameInput"
                            placeholder="Nhập tên khách mời..."
                            class="w-full px-3 py-2 rounded-md border border-gold/50 bg-transparent text-gold placeholder-gold/70 focus:outline-none focus:ring-2 focus:ring-gold"
                        />
                        <button
                            type="submit"
                            class="w-full bg-gold text-navy font-semibold py-2 rounded-md hover:bg-yellow-400 transition-colors"
                        >
                            Tìm kiếm
                        </button>
                    </form>
                    <p class="text-xs text-gold/80 mt-2">...và nhiều thiệp mời cá nhân khác.</p>
                    </div>
                </div>
            ` : `<p class="mt-8 text-sm text-gold/80">Chưa có danh sách khách mời.</p>`;


            return `
                <div class="flex flex-col md:flex-row w-full max-w-5xl rounded-2xl overflow-hidden shadow-2xl my-8">
                    
                    <!-- Cột Trái: Giống ảnh mẫu (Thông báo Lễ Tốt Nghiệp) -->

                    <div class="flex-1 p-8 md:p-12 text-white flex flex-col items-center justify-between relative overflow-hidden">
                        
                        <video id="background-video" autoplay loop muted playsinline 
                            class="absolute inset-0 w-full h-full object-cover pointer-events-none z-0">
                            <source src="/video/sparkle-background.mp4" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <div class="text-center w-full relative z-10">
                            <h2 class="text-2xl font-serif text-gold gold-shine mb-1">Thư Mời</h2>
                            <h1 class="text-4xl md:text-5xl font-serif font-black text-gold gold-shine border-b border-gold/50 pb-2 mb-8">
                                Tham Dự <br> LỄ TỐT NGHIỆP
                            </h1>

                            <!-- Vòng ảnh người tốt nghiệp -->
                            <div class="my-8 flex justify-center">
                                <div class="relative inline-block w-56 h-56 md:w-64 md:h-64">
                                    <img src="${ASSETS.LAUREL_WREATH}" alt="Vòng nguyệt quế" class="absolute inset-0 w-full h-full object-contain select-none pointer-events-none" aria-hidden="true">
                                    <img src="${ASSETS.GRADUATE_IMAGE}" alt="Ảnh người tốt nghiệp" onerror="this.onerror=null;this.src='${ASSETS.GRADUATE_IMAGE}';" class="relative w-40 h-40 md:w-48 md:h-48 object-cover rounded-full golden-border left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2">
                                </div>
                            </div>

                            <p class="text-base text-gold font-semibold tracking-wider">TÂN CỬ NHÂN</p>
                            <h3 class="text-3xl md:text-4xl font-serif font-black text-gold mt-2 drop-shadow-[0_0_6px_rgba(255,215,0,0.8)] animate-pulse">
                                ♦ ${defaultGuestName} ♦
                            </h3>
                            <!-- Thông tin phụ như khóa học/khoa -->
                        <p class="text-base font-bold text-white bg-navy py-1 px-4 inline-block rounded-full mt-3 shadow-md">
                            ${info.subEventDetails || info.universityShort || 'UEH'} - ${info.date ? `Ngày ${info.date}` : 'Thông tin phụ'}
                        </p>

                        <!-- Form nhập tên khách mời -->
                        <div class="mt-8 w-full max-w-sm mx-auto">
                            <form id="guestSearchForm" class="space-y-3">
                                <input
                                    type="text"
                                    id="guestNameInput"
                                    placeholder="Nhập tên khách mời..."
                                    class="w-full px-4 py-2 rounded-md border border-gold/50 bg-transparent text-gold placeholder-gold/70 focus:outline-none focus:ring-2 focus:ring-gold"
                                />
                                <button
                                    type="submit"
                                    class="w-full bg-gold text-navy font-semibold py-2 rounded-md hover:bg-yellow-400 transition-colors"
                                >
                                    Tìm thiệp mời
                                </button>
                            </form>
                        </div>
                        </div>
                        
                        
                    </div>

                    <!-- Cột Phải: Chi tiết Sự kiện -->
                    <div class="flex-1 p-8 md:p-12 invitation-frame gold-frame-bg bg-white/60 backdrop-blur-sm text-navy flex flex-col relative">
                        <!-- Lớp mờ phủ nền -->
                        <div class="absolute inset-0 bg-white/40 backdrop-blur-sm z-0"></div>
                        <div class="relative z-10">
                            <div class="text-center">
                                <p class="text-sm font-semibold tracking-widest text-gray-500">${info.university || 'Tên trường'}</p>
                                <h1 class="text-4xl font-serif font-black text-navy mt-2">LỄ TỐT NGHIỆP</h1>
                                
                                <!-- Thông tin phụ như khóa học/khoa -->
                                <p class="text-base font-bold text-white bg-navy py-1 px-4 inline-block rounded-full mt-3 shadow-md">
                                    ${info.subEventDetails || info.universityShort || 'UEH'} - ${info.date ? `Ngày ${info.date}` : 'Thông tin phụ'}
                                </p>
                                <div class="w-full h-px bg-gray-300 my-6"></div>
                            </div>

                            <!-- Chi tiết -->
                            <div class="space-y-6 mb-8">
                                <div>
                                    <h3 class="text-sm font-black tracking-widest text-navy uppercase mb-1">THỜI GIAN</h3>
                                    <p class="text-xl font-bold">${info.time || 'Chưa cập nhật'}, Ngày ${info.date || 'Chưa cập nhật'}</p>
                                </div>
                                <!-- Địa điểm có link bản đồ -->
                                <div>
                                    <h3 class="text-sm font-black tracking-widest text-navy uppercase mb-1">ĐỊA ĐIỂM</h3>
                                    <a href="${info.mapLink || '#'}" target="_blank" class="block group text-navy hover:text-gold transition-colors duration-200">
                                        <p class="text-lg font-bold flex items-center">
                                            ${info.venue || 'Chưa cập nhật'}
                                            <i data-lucide="map-pin" class="w-4 h-4 ml-2 text-navy group-hover:text-gold"></i>
                                        </p>
                                        <p class="text-sm text-gray-600 group-hover:text-gray-800">${info.address || 'Chưa cập nhật địa chỉ'}</p>
                                        <p class="text-xs text-blue-500 group-hover:underline mt-1">Xem trên Google Maps</p>
                                    </a>
                                </div>
                            </div>

                            <!-- Bản đồ/ảnh hội trường (map.png) -->
                            <div class="mt-auto pt-4">
                                <h3 class="text-center text-sm font-black tracking-widest text-navy uppercase mb-2">Ảnh Dẫn Đường</h3>
                                <img src="${ASSETS.MAP_IMAGE}" alt="Ảnh dẫn đến hội trường" onerror="this.onerror=null;this.src='${ASSETS.MAP_IMAGE}';" class="w-full rounded-lg shadow-md border border-gray-200">
                            </div>
                            
                            <!-- Kính mời cuối -->
                            <div class="text-center mt-6 pt-4 border-t border-gray-200">
                                <h3 class="text-lg font-bold text-navy">TRÂN TRỌNG KÍNH MỜI</h3>
                                <p class="text-xl font-serif font-extrabold text-navy mt-1">Sự hiện diện của Quý Vị</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- 5. HÀM RENDER THIỆP MỜI CÁ NHÂN HÓA (Đã được cập nhật để xử lý lỗi dữ liệu) ---
        function renderGuestHtml(info, guest) {
            if (!info || !info.graduateName) {
                return renderDataError('Không tìm thấy thông tin sự kiện để tạo thiệp mời.');
            }

            const guestName = guest.name;
            const guestTitle = guest.title;
            const inviteMsg = guest.message && guest.message.trim() !== '' ? guest.message : DEFAULT_INVITE_MESSAGE;
            
            // Xác định ảnh khách mời
            const guestImg = guest.image && guest.image.trim() !== '' 
                ? `/image/graduation/${guest.image}` // Giả định ảnh khách mời cũng lưu ở public/image/graduation
                : (guest.gender && guest.gender.toLowerCase() === 'female' 
                    ? ASSETS.WOMEN_DEFAULT 
                    : ASSETS.MAN_DEFAULT);
            
            // Xử lý CSS cho Khách mời Đặc biệt
            const mainCardClass = guest.special 
                ? 'special-card text-white' 
                : 'bg-navy/95 text-white';

            const frameClass = guest.special
                ? 'invitation-frame gold-frame-bg bg-white/95 text-navy'
                : 'invitation-frame bg-white text-navy';

            return `
                <div class="flex flex-col md:flex-row w-full max-w-5xl rounded-2xl overflow-hidden shadow-2xl my-8">
                    
                    <!-- Cột Trái: Ảnh và Tên Khách Mời -->
                    <div class="flex-1 p-8 md:p-12 sparkle-background soft-glow ${mainCardClass} flex flex-col items-center justify-between">
                        <div class="text-center w-full">
                            <h2 class="text-2xl font-serif text-gold mb-1">Thư Mời</h2>
                            <h1 class="text-4xl md:text-5xl font-serif font-black text-gold border-b border-gold/50 pb-2 mb-8">
                                Tham Dự <br> LỄ TỐT NGHIỆP
                            </h1>

                            <!-- Vòng ảnh tốt nghiệp -->
                            <div class="my-8 flex justify-center">
                                <div class="relative inline-block w-56 h-56 md:w-64 md:h-64">
                                    <img src="${ASSETS.LAUREL_WREATH}" alt="Vòng nguyệt quế" class="absolute inset-0 w-full h-full object-contain select-none pointer-events-none" aria-hidden="true">
                                    <img src="${ASSETS.GRADUATE_IMAGE}" alt="Ảnh người tốt nghiệp" class="relative w-40 h-40 md:w-48 md:h-48 object-cover rounded-full golden-border left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2">
                                </div>
                            </div>

                            <p class="text-base text-gold font-semibold tracking-wider">TRÂN TRỌNG KÍNH MỜI</p>
                            <h3 class="text-3xl md:text-4xl font-serif font-bold text-gold mt-2 gold-shine">
                                _ ${guestTitle} _<br>
                                ♦ ${guestName} ♦
                            </h3>
                        </div>
                        <a href="${APP_ROOT}" class="mt-8 text-sm text-gold hover:underline">Quay về trang chủ</a>
                    </div>

                    <!-- Cột Phải: Chi tiết Sự kiện và Lời nhắn -->
                    <div class="flex-1 p-8 md:p-12 ${frameClass} flex flex-col">
                        <div class="text-center">
                            <p class="text-sm font-semibold tracking-widest text-gray-500">${info.university || 'Tên trường'}</p>
                            <h1 class="text-4xl font-serif font-black text-navy mt-2">LỄ TỐT NGHIỆP</h1>
                            <p class="text-base font-bold text-gray-700 mt-2">${info.subEventDetails || info.universityShort || 'UEH'} - ${info.date ? `Ngày ${info.date}` : 'Thông tin phụ'}</p>
                            <div class="w-full h-px bg-gray-300 my-6"></div>
                        </div>

                        <!-- Chi tiết -->
                        <div class="space-y-6 mb-8">
                            <div>
                                <h3 class="text-sm font-black tracking-widest text-navy uppercase mb-1">THỜI GIAN</h3>
                                <p class="text-xl font-bold">${info.time || 'Chưa cập nhật'}, Ngày ${info.date || 'Chưa cập nhật'}</p>
                            </div>
                            <!-- ĐỊA ĐIỂM - Liên kết bản đồ -->
                            <div>
                                <h3 class="text-sm font-black tracking-widest text-navy uppercase mb-1">ĐỊA ĐIỂM</h3>
                                <a href="${info.mapLink || '#'}" target="_blank" class="block group text-navy hover:text-gold transition-colors duration-200">
                                    <p class="text-lg font-bold flex items-center">
                                        ${info.venue || 'Chưa cập nhật'}
                                        <i data-lucide="map-pin" class="w-4 h-4 ml-2 text-navy group-hover:text-gold"></i>
                                    </p>
                                    <p class="text-sm text-gray-600 group-hover:text-gray-800">${info.address || 'Chưa cập nhật địa chỉ'}</p>
                                    <p class="text-xs text-blue-500 group-hover:underline mt-1">Xem trên Google Maps</p>
                                </a>
                            </div>
                        </div>

                        <!-- Lời nhắn cá nhân -->
                        <div class="flex flex-col items-center p-4 bg-gray-50 rounded-lg border border-gray-200 mt-auto">
                            <img src="${guestImg}" alt="Ảnh Khách Mời" onerror="this.onerror=null;this.src='${guest.gender && guest.gender.toLowerCase() === 'female' ? ASSETS.WOMEN_DEFAULT : ASSETS.MAN_DEFAULT}';" class="w-16 h-16 rounded-full object-cover mb-3 border-2 border-navy">
                            <p class="text-lg font-serif italic text-gray-700 text-center mb-4">
                                "${inviteMsg}"
                            </p>
                            <p class="text-sm font-semibold text-navy">Trân trọng từ người tốt nghiệp, ${info.graduateName} </p>
                        </div>
                        
                        <!-- Kính mời cuối -->
                        <div class="text-center mt-6 pt-4 border-t border-gray-200">
                            <h3 class="text-lg font-bold text-navy">TRÂN TRỌNG KÍNH MỜI</h3>
                            <p class="text-2xl font-serif font-extrabold text-navy mt-1">${guestTitle} ${guestName}</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- 6. HÀM XỬ LÝ LỖI DỮ LIỆU ---
        function renderDataError(message) {
            return `
                <div class="text-center p-12 bg-white rounded-xl shadow-lg mt-12 max-w-md border-t-8 border-red-500">
                    <h1 class="text-3xl font-bold text-red-600 mb-4">Lỗi Dữ Liệu</h1>
                    <p class="text-gray-600">${message}</p>
                    <p class="text-sm text-gray-500 mt-2">Vui lòng đảm bảo Firebase đã được thiết lập và các documents/collection sau đã được tạo:</p>
                    <ul class="text-left text-xs text-gray-500 list-disc list-inside mt-2 mx-auto max-w-xs">
                        <li>/artifacts/{appId}/public/data/info/event_details (Document)</li>
                        <li>/artifacts/{appId}/public/data/khach (Collection)</li>
                    </ul>
                </div>
            `;
        }


        function renderLoading() {
            document.getElementById('app').innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen w-full">
                    <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-navy" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-navy font-semibold">Đang tải dữ liệu thiệp mời...</p>
                </div>
            `;
        }
        
        // Helper: Gắn sự kiện submit cho form tìm thiệp mời khách mời
        function attachGuestForm(guests) {
            const forms = Array.from(document.querySelectorAll('form#guestSearchForm'));
            if (!forms.length) return;
        
            const normalize = (s) => (s || '')
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase()
                .trim();
        
            forms.forEach((form) => {
                const input = form.querySelector('input#guestNameInput');
                if (!input) return;
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const query = normalize(input.value);
                    if (!query) { input.focus(); return; }
                    let target = (guests || []).find(g => normalize(g.name) === query);
                    if (!target) {
                        target = (guests || []).find(g => normalize(g.name).includes(query));
                    }
                    if (target) {
                        history.pushState({}, '', `${APP_ROOT}/${encodeURIComponent(target.name)}`);
                        router();
                    } else {
                        input.classList.add('ring-2', 'ring-red-500');
                        setTimeout(() => input.classList.remove('ring-2', 'ring-red-500'), 1200);
                    }
                });
            });
        }

        // --- 7. HÀM ĐỊNH TUYẾN (ROUTER) ---

        async function router() {
            renderLoading();
            const { info, guests } = await initializeData();

            const path = window.location.pathname.replace(/\/+$/, '');
            const pathParts = path.split('/').filter(part => part.length > 0);

            let contentHtml = '';

            // Kiểm tra chung về kết nối Firebase và dữ liệu info
            if (!info) {
                document.getElementById('app').innerHTML = renderDataError('Không thể tải dữ liệu sự kiện từ Firestore.');
                return;
            }

            if (pathParts.length === 1 && pathParts[0].toLowerCase() === 'graduation') {
                // Trang chủ /graduation
                contentHtml = renderMainPage(info, guests);
            } else if (pathParts.length === 2 && pathParts[0].toLowerCase() === 'graduation') {
                // Trang khách mời cá nhân /graduation/{Tên Khách Mời}
                const guestNameEncoded = pathParts[1];
                const guestName = decodeURIComponent(guestNameEncoded);
                const guest = guests.find(g => g.name.toLowerCase() === guestName.toLowerCase());

                if (guest) {
                    contentHtml = renderGuestHtml(info, guest);
                } else {
                    // 404 cho khách mời không tìm thấy
                    contentHtml = `
                        <div class="text-center p-12 bg-white rounded-xl shadow-lg mt-12 max-w-md border-t-8 border-red-500">
                            <h1 class="text-3xl font-bold text-red-600 mb-4">Lỗi 404 - Không tìm thấy</h1>
                            <p class="text-gray-600">Rất tiếc, không tìm thấy thiệp mời cho khách mời "${guestName}".</p>
                            <a href="${APP_ROOT}" class="mt-6 inline-block text-navy font-semibold hover:underline">Quay về trang chủ</a>
                        </div>
                    `;
                }
            } else {
                // 404 chung
                contentHtml = `
                    <div class="p-8 text-center max-w-2xl mx-auto bg-white rounded-xl shadow-xl mt-12 border-t-8 border-red-500">
                        <h1 class="text-4xl font-black text-red-500 mb-4">Lỗi Đường Dẫn</h1>
                        <p class="text-xl text-gray-700 mb-6">Vui lòng truy cập đường dẫn chính:</p>
                        <a href="${APP_ROOT}" class="mt-6 inline-block text-white px-6 py-3 bg-navy rounded-full hover:bg-navy/80 font-semibold">Đi đến ${APP_ROOT}</a>
                    </div>
                `;
            }

            document.getElementById('app').innerHTML = contentHtml;
            attachGuestForm(guests);
            lucide.createIcons();
        }

        // Khởi tạo router khi tải trang và khi điều hướng lịch sử
        window.addEventListener('load', router);
        window.addEventListener('popstate', router);
    </script>
</body>
</html>
