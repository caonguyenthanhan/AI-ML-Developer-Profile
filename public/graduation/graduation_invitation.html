<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thư Mời Tốt Nghiệp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'navy': '#03204c',
                        'gold': '#ffd700',
                        'primary': '#03204c',
                        'secondary': '#ffd700',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@400;600;700&display=swap');
        body { background-color: #eef2ff; }
        .sparkle-background {
            background-color: #03204c;
            background-image: radial-gradient(circle at top right, rgba(255, 215, 0, 0.1) 1px, transparent 0), radial-gradient(circle at bottom left, rgba(255, 215, 0, 0.1) 1px, transparent 0);
            background-size: 20px 20px;
        }
        .golden-border { border: 4px solid transparent; box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.8), 0 0 5px 2px rgba(255, 215, 0, 0.6); }
        .special-card { background: linear-gradient(135deg, #05376e, #03204c); box-shadow: 0 10px 30px rgba(3, 32, 76, 0.8); border: 3px solid #ffd700; }
        .invitation-frame { border: 2px solid #ffd700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.4); }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="flex flex-col items-center p-4 md:p-8">
        <div class="text-center p-8">Đang tải...</div>
    </div>

    <script type="module">
        const INFO_URL = '/data/info.json';
        const GUESTS_URL = '/data/khach.json';
        const DEFAULT_INVITE_MESSAGE = 'Thân gửi bạn, hãy đến chung vui cùng tôi trong buổi lễ trọng đại này, đánh dấu một cột mốc quan trọng trên con đường sắp tới. Sự hiện diện của bạn là niềm vinh dự lớn nhất của tôi!';
        const ASSETS = {
            GRADUATE_IMAGE: '/image/graduation/main.png',
            MAN_DEFAULT: '/image/graduation/man.png',
            WOMEN_DEFAULT: '/image/graduation/women.png'
        };
        const APP_ROOT = (() => {
        const p = window.location.pathname.replace(/\/+$/, '');
        const idx = p.indexOf('/graduation');
        if (idx >= 0) return p.substring(0, idx + '/graduation'.length);
        return p.replace(/\/graduation_invitation\.html$/, '');
        })();

        async function initializeData() {
            try {
                const [infoRes, guestsRes] = await Promise.all([
                    fetch(INFO_URL, { cache: 'no-store' }),
                    fetch(GUESTS_URL, { cache: 'no-store' })
                ]);
                const info = infoRes.ok ? await infoRes.json() : {};
                const guestsJson = guestsRes.ok ? await guestsRes.json() : [];
                let guests = Array.isArray(guestsJson) ? guestsJson : (Array.isArray(guestsJson.guests) ? guestsJson.guests : []);
                const mapLink = info.mapLink && info.mapLink.trim() !== ''
                    ? info.mapLink
                    : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(info.address || '')}`;
                info.mapLink = mapLink;
                if (!Array.isArray(guests) || guests.length === 0) {
                    guests = [{ name: 'Khách Mời', title: 'Bạn', gender: 'male', image: '', message: DEFAULT_INVITE_MESSAGE, special: false }];
                }
                guests = guests.map(g => ({ ...g, nameEncoded: encodeURIComponent(g.name) }));
                return { info, guests };
            } catch (e) {
                const info = { eventName: 'Lễ Tốt Nghiệp', university: '', universityShort: '', date: '', time: '', venue: '', address: '', mapLink: '' };
                const guests = [{ name: 'Khách Mời', title: 'Bạn', gender: 'male', image: '', message: DEFAULT_INVITE_MESSAGE, special: false, nameEncoded: encodeURIComponent('Khách Mời') }];
                return { info, guests };
            }
        }

        function renderGuestHtml(info, guest) {
            const guestName = guest.name;
            const guestTitle = guest.title;
            const inviteMsg = guest.message && guest.message.trim() !== '' ? guest.message : DEFAULT_INVITE_MESSAGE;
            const guestImg = guest.image && guest.image.trim() !== ''
                ? `/image/graduation/${guest.image}`
                : (guest.gender && guest.gender.toLowerCase() === 'female' ? ASSETS.WOMEN_DEFAULT : ASSETS.MAN_DEFAULT);
            const mainCardClass = guest.special ? 'special-card text-white' : 'bg-navy/95 text-white';
            const frameClass = guest.special ? 'invitation-frame bg-white/95 text-navy' : 'invitation-frame bg-white text-navy';

            return `
                <div class="flex flex-col md:flex-row w-full max-w-5xl rounded-2xl overflow-hidden shadow-2xl my-8">
                    <div class="flex-1 p-8 md:p-12 sparkle-background ${mainCardClass} flex flex-col items-center justify-between">
                        <div class="text-center w-full">
                            <h2 class="text-2xl font-serif text-gold mb-1">Thư Mời</h2>
                            <h1 class="text-4xl md:text-5xl font-serif font-black text-gold border-b border-gold/50 pb-2 mb-8">Tham Dự <br> LỄ TỐT NGHIỆP</h1>
                            <div class="my-8 flex justify-center">
                                <img src="${ASSETS.GRADUATE_IMAGE}" alt="Ảnh người tốt nghiệp" class="w-40 h-40 md:w-48 md:h-48 object-cover rounded-full golden-border">
                            </div>
                            <p class="text-base text-gold font-semibold tracking-wider">TRÂN TRỌNG KÍNH MỜI</p>
                            <h3 class="text-3xl md:text-4xl font-serif font-bold text-gold mt-2">♦ ${guestTitle} ${guestName} ♦</h3>
                        </div>
                        <a href="${APP_ROOT}" class="mt-8 text-sm text-gold hover:underline">Quay về trang chủ</a>
                    </div>

                    <div class="flex-1 p-8 md:p-12 ${frameClass} flex flex-col">
                        <div class="text-center">
                            <p class="text-sm font-semibold tracking-widest text-gray-500">${info.university || ''}</p>
                            <h1 class="text-4xl font-serif font-black text-navy mt-2">LỄ TỐT NGHIỆP</h1>
                            <p class="text-lg font-bold text-gray-700 mt-2">${(info.universityShort || '')} - Khóa ${new Date().getFullYear()}</p>
                            <div class="w-full h-px bg-gray-300 my-6"></div>
                        </div>
                        <div class="space-y-6 mb-8">
                            <div>
                                <h3 class="text-sm font-black tracking-widest text-navy uppercase mb-1">THỜI GIAN</h3>
                                <p class="text-xl font-bold">${info.time || ''}, Ngày ${info.date || ''}</p>
                            </div>
                            <div>
                                <h3 class="text-sm font-black tracking-widest text-navy uppercase mb-1">ĐỊA ĐIỂM</h3>
                                <a href="${info.mapLink}" target="_blank" class="block group text-navy hover:text-gold transition-colors duration-200">
                                    <p class="text-lg font-bold flex items-center">${info.venue || ''}<i data-lucide="map-pin" class="w-4 h-4 ml-2 text-navy group-hover:text-gold"></i></p>
                                    <p class="text-sm text-gray-600 group-hover:text-gray-800">${info.address || ''}</p>
                                    <p class="text-xs text-blue-500 group-hover:underline mt-1">Xem trên Google Maps</p>
                                </a>
                            </div>
                        </div>
                        <div class="flex flex-col items-center p-4 bg-gray-50 rounded-lg border border-gray-200 mt-auto">
                            <img src="${guestImg}" alt="Ảnh Khách Mời" onerror="this.onerror=null;this.src='${guest.gender && guest.gender.toLowerCase() === 'female' ? ASSETS.WOMEN_DEFAULT : ASSETS.MAN_DEFAULT}';" class="w-16 h-16 rounded-full object-cover mb-3 border-2 border-navy">
                            <p class="text-lg font-serif italic text-gray-700 text-center mb-4">"${inviteMsg}"</p>
                            <p class="text-sm font-semibold text-navy">Trân trọng từ người tốt nghiệp,</p>
                        </div>
                        <div class="text-center mt-6 pt-4 border-t border-gray-200">
                            <h3 class="text-lg font-bold text-navy">TRÂN TRỌNG KÍNH MỜI</h3>
                            <p class="text-2xl font-serif font-extrabold text-navy mt-1">${guestTitle} ${guestName}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLoading() {
            document.getElementById('app').innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen w-full">
                    <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-navy" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-navy font-semibold">Đang tải dữ liệu thiệp mời...</p>
                </div>
            `;
        }

        async function router() {
            renderLoading();
            const isHttp = window.location.protocol === 'http:' || window.location.protocol === 'https:';
            if (!isHttp) {
                document.getElementById('app').innerHTML = `
                    <div class="p-8 text-center max-w-2xl mx-auto bg-white rounded-xl shadow-xl mt-12 border-t-8 border-red-500">
                        <h1 class="text-2xl font-black text-red-500 mb-3">Không thể tải dữ liệu qua file://</h1>
                        <p class="text-base text-gray-700 mb-4">Vui lòng chạy trang qua máy chủ (http/https) để truy cập JSON.</p>
                        <a href="http://127.0.0.1:5000/graduation" class="mt-2 inline-block text-white px-6 py-3 bg-navy rounded-full hover:bg-navy/80 font-semibold">Mở http://127.0.0.1:5000/graduation</a>
                    </div>
                `;
                return;
            }
            const { info, guests } = await initializeData();
            const currentPath = window.location.pathname.replace(/\/+$/, '');
            let contentHtml = '';
            if (currentPath === APP_ROOT || currentPath === APP_ROOT + '/') {
                contentHtml = `
                    <div class="p-8 text-center max-w-2xl mx-auto bg-white rounded-xl shadow-xl mt-12 border-t-8 border-navy">
                        <h1 class="text-4xl font-serif font-black text-navy mb-4">${info.eventName || 'Lễ Tốt Nghiệp'}</h1>
                        <p class="text-xl text-gray-700 mb-6">Chào mừng đến với trang thiệp mời điện tử!</p>
                        <p class="text-gray-600 mb-4">Vui lòng truy cập đường dẫn cá nhân của bạn. Ví dụ:</p>
                        <div class="space-y-2 p-4 bg-navy/10 rounded-lg">
                            ${guests.map(g => `<a href="${APP_ROOT}/${g.nameEncoded}" class="block text-base text-navy hover:underline">${APP_ROOT}/${g.nameEncoded}</a>`).slice(0, 5).join('')}
                            <p class="text-xs pt-2 text-gray-600">...và nhiều thiệp mời khác.</p>
                        </div>
                    </div>
                `;
            } else if (currentPath.startsWith(APP_ROOT + '/')) {
                const guestNameEncoded = currentPath.substring(APP_ROOT.length + 1);
                const guestName = decodeURIComponent(guestNameEncoded);
                const guest = guests.find(g => g.name.toLowerCase() === guestName.toLowerCase());
                if (guest) {
                    contentHtml = renderGuestHtml(info, guest);
                } else {
                    contentHtml = `
                        <div class="text-center p-12 bg-white rounded-xl shadow-lg mt-12 max-w-md border-t-8 border-red-500">
                            <h1 class="text-3xl font-bold text-red-600 mb-4">Lỗi 404 - Không tìm thấy</h1>
                            <p class="text-gray-600">Rất tiếc, không tìm thấy thiệp mời cho khách mời "${guestName}".</p>
                            <a href="${APP_ROOT}" class="mt-6 inline-block text-navy font-semibold hover:underline">Quay về trang chủ</a>
                        </div>
                    `;
                }
            } else {
                contentHtml = `
                    <div class="p-8 text-center max-w-2xl mx-auto bg-white rounded-xl shadow-xl mt-12 border-t-8 border-red-500">
                        <h1 class="text-4xl font-black text-red-500 mb-4">Lỗi Đường Dẫn</h1>
                        <p class="text-xl text-gray-700 mb-6">Vui lòng truy cập đường dẫn chính:</p>
                        <a href="${APP_ROOT}" class="mt-6 inline-block text-white px-6 py-3 bg-navy rounded-full hover:bg-navy/80 font-semibold">Đi đến ${APP_ROOT}</a>
                    </div>
                `;
            }
            document.getElementById('app').innerHTML = contentHtml;
            if (window.lucide && typeof lucide.createIcons === 'function') {
                lucide.createIcons();
            }
        }

        window.addEventListener('load', router);
        window.addEventListener('popstate', router);
    </script>
</body>
</html>
