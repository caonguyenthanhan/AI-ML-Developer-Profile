(function(root,factory){
if(typeof define==='function'&&define.amd){define([],function(){return factory(root)})}
else if(typeof module==='object'&&module.exports){module.exports=factory(root)}
else{root.GraduationApp=factory(root)}
})(typeof self!=='undefined'?self:this,function(root){
var ASSETS={GRADUATE_IMAGE:"/image/graduation/main-preview.jpg",MAN_DEFAULT:"/image/default_avatar.png",WOMEN_DEFAULT:"/image/default_avatar.png"};
var APP_ROOT="/graduation";
var INFO_URL="/data/info.json";
var GUESTS_URL="/data/khach.json";
function $(s){return document.querySelector(s);} 
function setupFirebase(){
  try{
    var cfg=typeof firebaseConfig!="undefined"?firebaseConfig:{};
    if(!cfg||!Object.keys(cfg).length) return Promise.resolve(false);
    var app=null;
    if(typeof firebase!=='undefined' && firebase.apps && firebase.apps.length){
      app=firebase.app();
    } else {
      app=firebase.initializeApp(cfg);
    }
    window.db=firebase.firestore(app);
    try{ window.db.settings({ experimentalForceLongPolling: true, useFetchStreams: false }); }catch(_){ }
    window.auth=firebase.auth(app);
    var tok=typeof initialAuthToken!="undefined"?initialAuthToken:null;
    return tok?auth.signInWithCustomToken(tok).then(()=>true).catch(()=>false):auth.signInAnonymously().then(()=>true).catch(()=>false);
  }catch(e){
    return Promise.resolve(false)
  }
}
function loadData(){return new Promise(async function(resolve){var info=null,guests=[];var canFs=await setupFirebase();if(canFs){try{var appId=typeof __app_id!="undefined"?__app_id:"default-app-id";var infoDocPath=`artifacts/${appId}/public/data/info/event_details`;var guestsColPath=`artifacts/${appId}/public/data/khach`;var is=await db.doc(infoDocPath).get();if(is.exists)info=is.data();var gs=await db.collection(guestsColPath).get();guests=gs.docs.map(d=>d.data());}catch(e){}}try{if(!info){var r=await fetch(INFO_URL,{cache:"no-store"});if(r.ok)info=await r.json()}if(!guests||!guests.length){var r2=await fetch(GUESTS_URL,{cache:"no-store"});if(r2.ok){var j=await r2.json();guests=Array.isArray(j?.guests)?j.guests:(Array.isArray(j)?j:[])}}}catch(e){}guests=(guests||[]).map(g=>({"name":g.name, "title":g.title, "gender":g.gender, "image":g.image, previewImage:g.previewImage, nameEncoded:encodeURIComponent(g.name)}));resolve({info,guests});})}
function renderLoading(){var el=document.getElementById("app");if(!el)return;el.innerHTML='<div class="flex flex-col items-center justify-center min-h-screen w-full"><svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-navy" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-4 text-navy font-semibold">Đang tải dữ liệu thiệp mời...</p></div>'}
function renderDataError(message){return '<div class="text-center p-12 bg-white rounded-xl shadow-lg mt-12 max-w-md border-t-8 border-red-500"><h1 class="text-3xl font-bold text-red-600 mb-4">Lỗi Dữ Liệu</h1><p class="text-gray-600">'+message+'</p><p class="text-sm text-gray-500 mt-2">Vui lòng đảm bảo Firebase đã được thiết lập và các documents/collection sau đã được tạo:</p><ul class="text-left text-xs text-gray-500 list-disc list-inside mt-2 mx-auto max-w-xs"><li>/artifacts/{appId}/public/data/info/event_details (Document)</li><li>/artifacts/{appId}/public/data/khach (Collection)</li></ul></div>'}
function attachGuestForm(guests){var forms=Array.from(document.querySelectorAll('form#guestSearchForm'));if(!forms.length)return;var normalize=function(s){return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim()};forms.forEach(function(form){var input=form.querySelector('input#guestNameInput');if(!input)return;form.addEventListener('submit',function(e){e.preventDefault();var query=normalize(input.value);if(!query){input.focus();return}var target=(guests||[]).find(function(g){return normalize(g.name)===query})|| (guests||[]).find(function(g){return normalize(g.name).includes(query)});if(target){history.pushState({},'',`${APP_ROOT}/${encodeURIComponent(target.name)}`);router()}else{input.classList.add('ring-2','ring-red-500');setTimeout(function(){input.classList.remove('ring-2','ring-red-500')},1200)}})})}
function updateMetaTags(info,guest){var title,description,image;var defaultTitle=`Lời Mời Lễ Tốt Nghiệp | ${info.graduateName}`;var defaultDesc=`Trân trọng kính mời bạn đến chung vui cùng ${info.graduateName} trong buổi lễ tốt nghiệp.`;var defaultImage=`${window.location.origin}${info.previewImage||ASSETS.GRADUATE_IMAGE}`;if(guest){title=`Thân mời ${guest.title||''} ${guest.name}`.replace(/\s+/g,' ').trim();description=`Thiệp mời đặc biệt dành cho ${guest.title||''} ${guest.name} từ ${info.graduateName}`.replace(/\s+/g,' ').trim();image=`${window.location.origin}${guest.previewImage||info.previewImage||ASSETS.GRADUATE_IMAGE}`}else{title=defaultTitle;description=defaultDesc;image=defaultImage}document.title=title;var t=document.querySelector('meta[property="og:title"]');if(t)t.setAttribute('content',title);var d=document.querySelector('meta[property="og:description"]');if(d)d.setAttribute('content',description);var i=document.querySelector('meta[property="og:image"]');if(i)i.setAttribute('content',image);var c=document.querySelector('meta[name="twitter:card"]');if(c)c.setAttribute('content','summary_large_image');var w=document.querySelector('meta[property="og:image:width"]');if(!w){w=document.createElement('meta');w.setAttribute('property','og:image:width');document.head.appendChild(w)}w.setAttribute('content','1200');var h=document.querySelector('meta[property="og:image:height"]');if(!h){h=document.createElement('meta');h.setAttribute('property','og:image:height');document.head.appendChild(h)}h.setAttribute('content','630')}
var currentEffectIndex=0;function triggerCelebration(){
  var maxP = (typeof window.__confettiMax!=='undefined'?window.__confettiMax:90);
  var effects=[
    function(){
      var duration=3500;var animationEnd=Date.now()+duration;var defaults={startVelocity:28,spread:260,ticks:50,zIndex:100};
      function randomInRange(min,max){return Math.random()*(max-min)+min}
      var interval=setInterval(function(){var timeLeft=animationEnd-Date.now();if(timeLeft<=0)return clearInterval(interval);var particleCount=Math.max(12, Math.min(maxP, Math.floor(30*(timeLeft/duration))));confetti({...defaults,particleCount,origin:{x:randomInRange(0.1,0.3),y:Math.random()-0.2}});confetti({...defaults,particleCount,origin:{x:randomInRange(0.7,0.9),y:Math.random()-0.2}})},300);
      setTimeout(function(){confetti({particleCount:Math.min(maxP,90),spread:160,origin:{y:0.6}})},400)
    },
    function(){
      var colors=['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff'];
      for(var i=0;i<6;i++){setTimeout(function(){confetti({particleCount:12,angle:90,spread:35,origin:{x:Math.random(),y:1.1},colors:colors,shapes:['circle'],scalar:1.1,gravity:-0.4,drift:Math.random()-0.5})},i*220)}
    },
    function(){
      var duration=3000;var animationEnd=Date.now()+duration;var interval=setInterval(function(){var timeLeft=animationEnd-Date.now();if(timeLeft<=0)return clearInterval(interval);confetti({particleCount:2,angle:90,spread:0,origin:{x:Math.random(),y:-0.1},colors:['#FFD700','#FFA500','#FF6347'],shapes:['line'],scalar:1.8,gravity:0.75,ticks:240})},120)
    },
    function(){
      var firework=function(x,y){confetti({particleCount:Math.min(maxP,70),spread:300,origin:{x,y},colors:['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff'],startVelocity:40,scalar:1.3})};
      setTimeout(function(){firework(0.2,0.3)},0);setTimeout(function(){firework(0.8,0.4)},320);setTimeout(function(){firework(0.5,0.2)},640);setTimeout(function(){firework(0.3,0.6)},960);
    }
  ];
  effects[currentEffectIndex]();currentEffectIndex=(currentEffectIndex+1)%effects.length
}
function renderControls(info){var controlsContainer=document.getElementById('controls');if(!controlsContainer)return;var controlsHtml='<button id="celebrateBtn" title="Chúc mừng!" class="bg-gold text-navy w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition-transform"><i data-lucide="party-popper" class="w-6 h-6"></i></button>';if(info.music){controlsHtml+='<button id="musicBtn" title="Tắt/Mở nhạc" class="bg-gold text-navy w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition-transform"><i data-lucide="volume-2" class="w-6 h-6"></i></button>'}controlsContainer.innerHTML=controlsHtml;lucide.createIcons();var celebrateBtn=document.getElementById('celebrateBtn');if(celebrateBtn)celebrateBtn.addEventListener('click',triggerCelebration);if(info.music){var musicPlayer=document.getElementById('background-music');var musicBtn=document.getElementById('musicBtn');musicPlayer.src=info.music;var isPlaying=true;var toggleMusic=function(){if(isPlaying){musicPlayer.pause();musicBtn.innerHTML='<i data-lucide="volume-x" class="w-6 h-6"></i>'}else{musicPlayer.play().catch(function(){}) ;musicBtn.innerHTML='<i data-lucide="volume-2" class="w-6 h-6"></i>'}isPlaying=!isPlaying;lucide.createIcons()};musicBtn&&musicBtn.addEventListener('click',toggleMusic);setTimeout(function(){musicPlayer.play().catch(function(){isPlaying=false;musicBtn.innerHTML='<i data-lucide="volume-x" class="w-6 h-6"></i>';lucide.createIcons()});triggerCelebration()},1000);document.body.addEventListener('click',function(){if(!isPlaying&&musicPlayer.paused){musicPlayer.play().catch(function(){});isPlaying=true;musicBtn.innerHTML='<i data-lucide="volume-2" class="w-6 h-6"></i>';lucide.createIcons()}},{once:true})}else{setTimeout(function(){triggerCelebration()},1000)}}
function renderMainPage(info,guests){var guestCount=(guests||[]).length;return '<div class="text-center p-10 bg-white rounded-xl shadow-md w-full max-w-3xl"><h1 class="text-3xl font-serif font-black text-navy">LỄ TỐT NGHIỆP</h1><p class="mt-2 text-gray-600">'+(info.university||'')+'</p><p class="mt-2 text-gray-600">'+(info.date||'')+' — '+(info.time||'')+'</p><p class="mt-2 text-gray-600">'+(info.venue||'')+'</p><div class="mt-6"><form id="guestSearchForm"><input id="guestNameInput" class="px-4 py-2 rounded-lg border" placeholder="Nhập tên khách mời..."/><button class="ml-2 px-4 py-2 rounded-lg bg-navy text-white">Tìm thiệp</button></form><p class="mt-3 text-sm text-gray-500">Tổng số khách mời: '+guestCount+'</p></div></div>'}
function renderGuestHtml(info,guest){var guestTitle=guest.title?guest.title+" ":"";var guestName=guest.name;var guestImg=(guest.image||'');var inviteMsg=(guest.message&&guest.message.trim())?guest.message:(info.invitationMessage||info.personalInviteDefault||"Sự hiện diện của bạn là niềm vinh dự lớn nhất!");return '<div class="p-6 bg-white rounded-xl shadow-md w-full max-w-3xl mx-auto"><div class="text-center"><p class="text-sm font-semibold tracking-widest text-gray-500">'+(info.university||'')+'</p><h1 class="text-4xl font-serif font-black text-navy mt-2">LỄ TỐT NGHIỆP</h1><p class="text-base font-bold text-gray-700 mt-2">'+(info.subEventDetails||info.universityShort||'')+' - '+(info.date?('Ngày '+info.date):'')+'</p><div class="w-full h-px bg-gray-300 my-6"></div></div><div class="flex flex-col items-center p-4 bg-gray-50 rounded-lg border border-gray-200"><img src="'+guestImg+'" alt="Ảnh Khách Mời" class="w-16 h-16 rounded-full object-cover mb-3"><p class="text-lg font-serif italic text-gray-700 text-center mb-4">"'+inviteMsg+'"</p><p class="text-sm font-semibold text-navy">Trân trọng từ người tốt nghiệp, '+(info.graduateName||'')+' </p></div><div class="text-center mt-6 pt-4 border-t border-gray-200"><h3 class="text-lg font-bold text-navy">TRÂN TRỌNG KÍNH MỜI</h3><p class="text-2xl font-serif font-extrabold text-navy mt-1">'+guestTitle+guestName+'</p></div></div>'}
function router(){renderLoading();loadData().then(function(data){var info=data.info,guests=data.guests;var path=window.location.pathname.replace(/\/+$/,'');var parts=path.split('/').filter(function(p){return p.length>0});var contentHtml='';if(!info){document.getElementById('app').innerHTML=renderDataError('Không thể tải dữ liệu sự kiện từ Firestore.');return}if(parts.length===1&&parts[0].toLowerCase()==='graduation'){contentHtml=renderMainPage(info,guests)}else if(parts.length===2&&parts[0].toLowerCase()==='graduation'){var guestName=decodeURIComponent(parts[1]);var guest=(guests||[]).find(function(g){return (g.name||'').toLowerCase()===guestName.toLowerCase()});if(guest){contentHtml=renderGuestHtml(info,guest)}else{contentHtml='<div class="text-center p-12 bg-white rounded-xl shadow-lg mt-12 max-w-md border-t-8 border-red-500"><h1 class="text-3xl font-bold text-red-600 mb-4">Lỗi 404 - Không tìm thấy</h1><p class="text-gray-600">Rất tiếc, không tìm thấy thiệp mời cho khách mời "'+guestName+'".</p><a href="'+APP_ROOT+'" class="mt-6 inline-block text-navy font-semibold hover:underline">Quay về trang chủ</a></div>'}}else{contentHtml='<div class="p-8 text-center max-w-2xl mx-auto bg-white rounded-xl shadow-xl mt-12 border-t-8 border-red-500"><h1 class="text-4xl font-black text-red-500 mb-4">Lỗi Đường Dẫn</h1><p class="text-xl text-gray-700 mb-6">Vui lòng truy cập đường dẫn chính:</p><a href="'+APP_ROOT+'" class="mt-6 inline-block text-white px-6 py-3 bg-navy rounded-full hover:bg-navy/80 font-semibold">Đi đến '+APP_ROOT+'</a></div>'}var app=document.getElementById('app');if(app)app.innerHTML=contentHtml;var currentGuest=(parts.length===2&&parts[0].toLowerCase()==='graduation')?(guests||[]).find(function(g){return (g.name||'').toLowerCase()===decodeURIComponent(parts[1]).toLowerCase()}):null;updateMetaTags(info,currentGuest);renderControls(info);attachGuestForm(guests);lucide.createIcons()})}
window.addEventListener('load',function(){router()});window.addEventListener('popstate',function(){router()});
return{router:router}
});